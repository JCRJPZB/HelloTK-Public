{"version":3,"sources":["file:///E:/GitHub/HelloTK/assets/Script/UI/StageScene/StagePoint.ts"],"names":["_decorator","Component","Label","find","Camera","Material","MeshRenderer","v3","tween","MonsterMgr","Functions","Generator","ResMgr","Subscribe","StageMgr","ccclass","property","StagePoint","onLoad","meshR","node","getComponent","loadRes","res","enable_mtr","isEnabled","setMaterial","disable_mtr","select_mtr","listen","uuid","slt_flag","changeSelect","init","uiParent","conf","changeState","ui_target","getChildByName","camera","pos","setPosition","gen","getInstance","ui_node","generator","label","text","string","mstMgr","mst_conf","forEach","mst","push","getMonsterAttr","mst_pos_idxs","i","length","data","on","getLastStageId","x","getPosition","camera_pos","camera_tween","to","position","y","z","easing","call","remove","name","start","stop","trigger","available","update","UIFllow3DNode"],"mappings":"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","sourcesContent":["﻿import { _decorator, Component, Node, Label, find, Camera, Material, MeshRenderer, v3, tween, Vec3 } from 'cc';\r\nimport { MonsterMgr } from '../../BattleField/Monster/MonsterMgr';\r\nimport { Functions } from '../../Tools/Functions';\r\nimport { Generator } from '../../Tools/Generator';\r\nimport { ResMgr } from '../../Tools/ResMgr';\r\nimport { Subscribe } from '../../Tools/Subscribe';\r\nimport { StageMgr } from './StageMgr';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('StagePoint')\r\nexport class StagePoint extends Component {\r\n    private ui_target: Node | null = null; // 要跟随的3D物体\r\n    private ui_node: Node | null = null; // UI节点\r\n    private text: Label | null = null; // 关卡标题\r\n    private camera: Camera | null | undefined = null; // 主摄像头\r\n    private meshR: MeshRenderer | null = null; // 材质管理\r\n    private enable_mtr: Material | null = null; // 可用状态材质\r\n    private disable_mtr: Material | null = null; // 禁用状态材质\r\n    private select_mtr: Material | null = null; // 选中状态材质\r\n    private isEnabled: boolean = false; // 可用状态标识\r\n    private slt_flag: boolean = false; // 被选中标识\r\n    private data: any = null; // 关卡内怪物的配置\r\n\r\n    onLoad() {\r\n        this.meshR = this.node.getComponent(MeshRenderer); // 获取材质管理器\r\n        ResMgr.loadRes(\"Material\", \"/Stage/Stage_enable\", Material, (res: Material) => { // 加载可用状态材质\r\n            this.enable_mtr = res;\r\n            if (this.isEnabled) {\r\n                this.meshR?.setMaterial(this.enable_mtr, 0);\r\n            }\r\n        });\r\n        ResMgr.loadRes(\"Material\", \"/Stage/Stage_disable\", Material, (res: Material) => { // 加载禁用状态材质\r\n            this.disable_mtr = res;\r\n        });\r\n        ResMgr.loadRes(\"Material\", \"/Stage/Stage_selected\", Material, (res: Material) => { // 加载选中状态材质\r\n            this.select_mtr = res;\r\n        });\r\n        Subscribe.listen(\"touch_start\" + this.node.uuid, this.node.uuid, () => { // 触摸开始事件\r\n            if (!this.isEnabled) { return; }\r\n            this.slt_flag = true;\r\n            this.meshR?.setMaterial(this.select_mtr, 0); // 将材质改为被选中\r\n        });\r\n        Subscribe.listen(\"touch_end\" + this.node.uuid, this.node.uuid, () => { // 触摸结束事件(触点在自身)\r\n            if (this.isEnabled && this.slt_flag) { // 只有当可用且触摸标识在自身时才响应\r\n                this.changeSelect();\r\n            }\r\n        });\r\n        Subscribe.listen(\"touch_end\", this.node.uuid, () => { // 触摸结束事件\r\n            if (this.isEnabled && this.slt_flag) {\r\n                this.slt_flag = false;\r\n                this.meshR?.setMaterial(this.enable_mtr, 0); // 恢复到选中状态材质\r\n            }\r\n        });\r\n    }\r\n\r\n    init(uiParent: Node, conf: any) {\r\n        Subscribe.listen(\"stage available \" + conf[\"id\"], this.uuid, this.changeState, this);\r\n        this.ui_target = this.node.getChildByName(\"UITarget\"); // UI跟随的节点（3D)\r\n        this.camera = find(\"/Main Camera\")?.getComponent(Camera); // 主摄像机\r\n        let pos = v3(conf[\"pos\"][0], conf[\"pos\"][1], conf[\"pos\"][2]); // 摆放\r\n        this.node.setPosition(pos);\r\n        let gen = Generator.getInstance(); // 预制体生成器\r\n        this.ui_node = gen.generator(uiParent, \"Stage_UI\"); // 生成UI节点\r\n        if (this.ui_target && this.ui_node) {\r\n            let label = this.ui_node.getChildByName(\"Label\");\r\n            if (label) { this.text = label.getComponent(Label); }\r\n            if (this.text) { this.text.string = conf[\"name\"]; } // 设置关卡名称\r\n            let mstMgr = MonsterMgr.getInstance(); // 怪物管理器\r\n            let mst_conf: any[] = [];\r\n            conf[\"monsters\"].forEach((mst: any) => { // 获取关卡内的怪物配置\r\n                mst_conf.push(mstMgr.getMonsterAttr(mst));\r\n            });\r\n            let mst_pos_idxs: any[] = [];\r\n            for (let i = 0; i < mst_conf.length; i++) { mst_pos_idxs.push({ \"id\": mst_conf[i][\"id\"], \"idx\": i }); } // 生成配置\r\n            this.data = { // 生成数据\r\n                \"stage_id\": conf[\"id\"],\r\n                \"formation\": { \"id\": \"monster\", \"name\": \"怪物\", \"ids_idxs\": mst_pos_idxs, \"pos_idxs\": [0, 1, 2, 3, 4, 5, 6, 7, 8] },\r\n                \"heros\": mst_conf\r\n            };\r\n            if (conf[\"available\"]) { // 若已通关或解锁则改为可用状态\r\n                this.ui_node.on(\"click\", this.changeSelect, this);\r\n                this.isEnabled = true;\r\n                if (conf[\"id\"] === StageMgr.getInstance().getLastStageId()) { // 此处初始化了进入选关界面以后显示哪个关卡\r\n                    this.changeSelect();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private changeSelect() { // 改变选中关卡\r\n        let x = this.node.getPosition().x + 10;\r\n        if (this.camera) {\r\n            let camera_pos = this.camera.node.getPosition();\r\n            let camera_tween = tween(this.camera.node) // 缓动移动摄像头到关卡位置\r\n                .to(1, { position: v3(x, camera_pos.y, camera_pos.z) }, { easing: \"sineInOut\" })\r\n                .call(() => { Subscribe.remove(\"touch screen start\", this.name); }) // 缓动结束后移除监听\r\n                .start();\r\n            Subscribe.listen(\"touch screen start\", this.name, () => { // 监听触摸事件\r\n                camera_tween.stop(); // 移动过程中有触摸事件则终止缓动\r\n                Subscribe.remove(\"touch screen start\", this.name); // 终止后移除监听\r\n            }, this);\r\n        }\r\n        Subscribe.trigger(\"change select stage\", this.data);\r\n    }\r\n\r\n    private changeState(available: boolean) {\r\n        if (available) {\r\n            this.meshR?.setMaterial(this.enable_mtr, 0);\r\n        } else {\r\n            this.meshR?.setMaterial(this.disable_mtr, 0);\r\n        }\r\n    }\r\n\r\n    update() {\r\n        if (this.ui_target && this.camera && this.ui_node) {\r\n            Functions.UIFllow3DNode(this.ui_node, this.camera, this.ui_target); // 跟随3D节点\r\n        }\r\n    }\r\n}\r\n"]}