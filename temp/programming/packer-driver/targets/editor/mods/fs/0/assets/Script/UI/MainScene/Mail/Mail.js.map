{"version":3,"sources":["file:///E:/GitHub/HelloTK/assets/Script/UI/MainScene/Mail/Mail.ts"],"names":["_decorator","ItemMgr","Generator","Subscribe","UIBase","MailMgr","MailTitle","ccclass","property","Mail","Map","onInit","addBtnEvent","gen","getInstance","mail_title_root","getNode","mail_sender","getComp","text_content","mail_annex_root","collect_btn","collected","alert_Lbl_Root","onOpen","refreshMail","addClickEvent","hide","allRead","collect_item","list","getMailList","length","mail_list","i","push","mail_map","set","new_title","generator","ctrl","getComponent","init","readMail","mail_id","mail","get","currMail","string","removeAllChildren","forEach","annex","getItemNode","active","trigger"],"mappings":"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","sourcesContent":["import { _decorator, Node, Label, find, v3 } from 'cc';\r\nimport { ItemMgr } from '../../../Items/ItemMgr';\r\nimport { Generator } from '../../../Tools/Generator';\r\nimport { Subscribe } from '../../../Tools/Subscribe';\r\nimport { UIBase } from '../../UIBase';\r\nimport { MailMgr } from './MailMgr';\r\nimport { MailTitle } from './MailTitle';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Mail')\r\nexport class Mail extends UIBase {\r\n\r\n    private gen: Generator | null = null;\r\n\r\n    private mail_list: string[] = [];\r\n    private mail_map: Map<string, any> = new Map();\r\n    private currMail: any;\r\n\r\n    private mail_title_root: Node | undefined;\r\n    private mail_sender: Label | null | undefined = null;\r\n    private text_content: Label | null | undefined = null;\r\n    private mail_annex_root: Node | undefined;\r\n    private collect_btn: Node | undefined;\r\n    private collected: Node | undefined;\r\n\r\n    private alert_Lbl_Root: Node | undefined;\r\n\r\n    protected onInit() {\r\n        this.addBtnEvent();\r\n\r\n        this.gen = Generator.getInstance();\r\n\r\n        this.mail_title_root = this.getNode(\"Title_Content\");\r\n        this.mail_sender = this.getComp(\"Sender\", \"Label\");\r\n        this.text_content = this.getComp(\"Text_Content\", \"Label\");\r\n        this.mail_annex_root = this.getNode(\"Annex_Content\");\r\n        this.collect_btn = this.getNode(\"Collect\");\r\n        this.collected = this.getNode(\"Collected\");\r\n\r\n        this.alert_Lbl_Root = this.getNode(\"Alert_Lbl_Root\");\r\n    }\r\n\r\n    protected onOpen() {\r\n        this.refreshMail();\r\n    }\r\n\r\n    private addBtnEvent() {\r\n        this.addClickEvent(\"Quit\", this.hide, this);\r\n        this.addClickEvent(\"Return\", this.hide, this);\r\n        this.addClickEvent(\"AllRead\", this.allRead, this);\r\n        this.addClickEvent(\"Collect\", this.collect_item, this);\r\n    }\r\n\r\n    private refreshMail() {\r\n        if (!this.gen) { this.gen = Generator.getInstance(); }\r\n        if (this.mail_title_root) {\r\n            let list = MailMgr.getInstance().getMailList();\r\n            if (list.length > this.mail_list.length) {\r\n                for (let i = this.mail_list.length; i < list.length; i++) {\r\n                    this.mail_list.push(list[i][\"mail_id\"]);\r\n                    this.mail_map.set(list[i][\"mail_id\"], list[i]);\r\n                    let new_title = this.gen.generator(this.mail_title_root, \"Mail_Title\");\r\n                    let ctrl = new_title?.getComponent(MailTitle);\r\n                    if (ctrl) { ctrl.init(list[i], () => { this.readMail(list[i][\"mail_id\"]) }); }\r\n                }\r\n            }\r\n            this.readMail(this.mail_list[0]);\r\n        }\r\n    }\r\n\r\n    private readMail(mail_id: string) {\r\n        if (this.mail_sender && this.text_content) {\r\n            let mail = this.mail_map.get(mail_id);\r\n            if (mail) {\r\n                this.currMail = mail;\r\n                this.mail_sender.string = \"From: \" + mail[\"sender\"];\r\n                this.text_content.string = mail[\"text_content\"];\r\n                this.mail_annex_root?.removeAllChildren();\r\n                mail[\"mail_annex\"].forEach((annex: any) => {\r\n                    if (!this.mail_annex_root) { return; }\r\n                    ItemMgr.getInstance().getItemNode(annex[\"item_id\"], this.mail_annex_root, annex[\"num\"]);\r\n                });\r\n                if (this.collect_btn && this.collected) {\r\n                    if (mail[\"hasAnnex\"] && !mail[\"collected\"]) {\r\n                        this.collect_btn.active = true;\r\n                        this.collected.active = false;\r\n                    }\r\n                    else {\r\n                        this.collect_btn.active = false;\r\n                        this.collected.active = true;\r\n                    }\r\n                }\r\n                Subscribe.trigger(\"read mail\", mail[\"mail_id\"]);\r\n            }\r\n        }\r\n    }\r\n\r\n    private allRead() { }\r\n\r\n    private collect_item() {\r\n        // ########################################################################\r\n        if (this.currMail[\"hasAnnex\"] && !this.currMail[\"collected\"] && this.currMail[\"mail_annex\"].length > 0) {\r\n            this.currMail[\"mail_annex\"].forEach((annex: any) => {\r\n                Subscribe.trigger(\"collect item\", annex[\"item_id\"], annex[\"num\"]);\r\n            });\r\n        }\r\n        // ########################################################################\r\n        // 由于网络等因素导致的领取失败需要考虑\r\n        if (this.collect_btn) {\r\n            if (this.alert_Lbl_Root) {\r\n                Subscribe.trigger(\"alert UI\", \"领取成功！!\", this.alert_Lbl_Root); // 显示提示Label\r\n            }\r\n            this.collect_btn.active = false;\r\n            if (this.collected) { this.collected.active = true; }\r\n        }\r\n        Subscribe.trigger(\"collect annex\", this.currMail[\"mail_id\"]);\r\n    }\r\n\r\n    private hide() {\r\n        Subscribe.trigger(\"go back page\");\r\n    }\r\n\r\n}\r\n"]}