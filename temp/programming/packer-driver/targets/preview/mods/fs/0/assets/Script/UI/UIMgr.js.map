{"version":3,"sources":["file:///E:/GitHub/HelloTK/assets/Script/UI/UIMgr.ts"],"names":["_decorator","Component","find","Label","tween","v3","Configure","Generator","Subscribe","UIBase","ccclass","property","UIMgr","constructor","name","Map","_UIConf","getConfigure","listen","_reset","openUI","closeUI","alert","goBackPage","getInstance","ist","scene_name","num","data","_sceneName","_currentPage","_stackPageName","_UIMap","clear","_PageMap","_mapLayer","rootPath","typeArr","length","trigger","_root_UI","forEach","type","node","getChildByName","set","strName","layer","params","ui","get","_destoryAllUI","openPage","layer_node","ui_node","generator","getComponent","_strName","init","open","pageName","push","close","key","destroy","prePage","pop","content","parent","pos","gen","lbl_node","lbl","string","by","position","easing","call","start"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, find, Vec3, Label, tween, v3 } from 'cc';\r\nimport { Configure } from '../Tools/Configure';\r\nimport { Generator } from '../Tools/Generator';\r\nimport { Subscribe } from '../Tools/Subscribe';\r\nimport { UIBase } from './UIBase';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('UIMgr')\r\nexport class UIMgr extends Component {\r\n\r\n    private static ist: UIMgr;\r\n\r\n    private _sceneName: string = \"\";\r\n    private _root_UI: Node | null = null;\r\n    private _currentPage: string = \"\";\r\n    private _mapLayer: Map<string, Node> = new Map();\r\n    private _UIConf: any = null;\r\n    private _stackPageName: string[] = [];\r\n    private _UIMap: Map<string, UIBase> = new Map();\r\n    private _PageMap: Map<string, UIBase> = new Map();\r\n    private gen: Generator | null = null;\r\n\r\n    private constructor(name: string) {\r\n        super(name);\r\n        this._UIConf = Configure.getConfigure(\"ui\");\r\n        // this._reset();\r\n        Subscribe.listen(\"change scene\", this.name, this._reset, this);\r\n        Subscribe.listen(\"open UI\", this.name, this.openUI, this);\r\n        Subscribe.listen(\"close UI\", this.name, this.closeUI, this);\r\n        Subscribe.listen(\"alert UI\", this.name, this.alert, this);\r\n        Subscribe.listen(\"go back page\", this.name, this.goBackPage, this);\r\n    }\r\n\r\n    public static getInstance() {\r\n        if (!UIMgr.ist) {\r\n            UIMgr.ist = new UIMgr(\"UIMgr\");\r\n        }\r\n        return UIMgr.ist;\r\n    }\r\n\r\n    private _reset(scene_name: string, num: number, data: any) {\r\n        this._sceneName = scene_name;\r\n        this._currentPage = \"\";\r\n        this._stackPageName = [];\r\n        this._UIMap.clear();\r\n        this._PageMap.clear();\r\n        this._mapLayer.clear();\r\n        let rootPath = this._UIConf[\"root\"];\r\n        let typeArr = this._UIConf[\"types\"];\r\n        if (!typeArr || typeArr.length < 1) {\r\n            Subscribe.trigger(\"log err\", \"Get type array failed!\");\r\n            return;\r\n        }\r\n        this._root_UI = find(rootPath);\r\n        if (!this._root_UI) {\r\n            Subscribe.trigger(\"log err\", \"Get UI root failed!\");\r\n            return;\r\n        }\r\n        typeArr.forEach((type: any) => {\r\n            let node = this._root_UI?.getChildByName(type[\"node_name\"]);\r\n            if (node) {\r\n                this._mapLayer.set(type[\"type_name\"], node);\r\n            } else {\r\n                Subscribe.trigger(\"log err\", \"Failed to find node named \\'\" + type[\"node_name\"] + \"\\' !\");\r\n            }\r\n        });\r\n        Subscribe.trigger(\"UI manager ready\", scene_name, num, data);\r\n    }\r\n\r\n    private openUI(strName: string, layer?: string, params?: any) {\r\n        let ui: UIBase | null | undefined = this._UIMap.get(strName);\r\n        layer = layer || \"Page\";\r\n        if (layer === \"Page\") {\r\n            this._destoryAllUI();\r\n            this.openPage(strName);\r\n            ui = this._PageMap.get(strName);\r\n        }\r\n        if (!ui) {\r\n            let layer_node = this._mapLayer.get(layer);\r\n            if (!layer_node) {\r\n                Subscribe.trigger(\"alert err\", \"找不到该界面：\" + strName);\r\n                return;\r\n            }\r\n            let ui_node = Generator.getInstance().generator(layer_node, strName);\r\n            if (!ui_node) {\r\n                Subscribe.trigger(\"alert err\", \"生成界面失败：\" + strName);\r\n                return;\r\n            }\r\n            ui = ui_node.getComponent(UIBase);\r\n            if (!ui) {\r\n                Subscribe.trigger(\"log err\", strName + \" has no comp named \\'UIBase\\'.\");\r\n                return;\r\n            }\r\n            ui._strName = strName;\r\n            ui.init(params);\r\n            if (layer === \"Page\") {\r\n                this._PageMap.set(strName, ui);\r\n            } else {\r\n                this._UIMap.set(strName, ui);\r\n            }\r\n        }\r\n        ui.open(params);\r\n    }\r\n\r\n    private openPage(pageName: string) {\r\n        if (this._currentPage === pageName) {\r\n            return;\r\n        }\r\n        if (this._currentPage) {\r\n            this._stackPageName.push(this._currentPage);\r\n        }\r\n        if (this._currentPage && this._stackPageName.length > 1) { // 最底层的页面不会关闭\r\n            this._PageMap.get(this._currentPage)?.close(null);\r\n        }\r\n        if (this._stackPageName.length > 0) {\r\n            Subscribe.trigger(\"stop move camera\");\r\n        }\r\n        this._currentPage = pageName;\r\n    }\r\n\r\n    public closeUI(strName: string, layer?: string, params?: any) {\r\n        if (!layer) {\r\n            layer = \"Window\";\r\n        }\r\n        let ui = this._UIMap.get(strName);\r\n        if (layer === \"Page\") {\r\n            ui = this._PageMap.get(strName);\r\n        }\r\n        if (!ui) {\r\n            return;\r\n        }\r\n        ui.close(params);\r\n    }\r\n\r\n    private _destoryAllUI() {\r\n        this._UIMap.forEach((ui, key) => {\r\n            ui.node.destroy();\r\n        });\r\n        this._UIMap.clear();\r\n    }\r\n\r\n    private goBackPage() {\r\n        let length = this._stackPageName.length;\r\n        if (length < 1) {\r\n            return;\r\n        }\r\n        if (this._currentPage) {\r\n            this._PageMap.get(this._currentPage)?.close(null);\r\n            this._currentPage = \"\";\r\n        }\r\n        this._destoryAllUI();\r\n        let prePage = this._stackPageName.pop();\r\n        if (!prePage) {\r\n            return;\r\n        }\r\n        this.openPage(prePage);\r\n        if (this._stackPageName.length < 1) {\r\n            Subscribe.trigger(\"continue move camera\");\r\n        }\r\n    }\r\n\r\n    private alert(content: string, parent: Node, pos?: Vec3) {\r\n        if (!this.gen) {\r\n            this.gen = Generator.getInstance();\r\n        }\r\n        let lbl_node = this.gen.generator(parent, \"Alert_Label\", pos);\r\n        let lbl = lbl_node?.getComponent(Label);\r\n        if (lbl) { lbl.string = content; }\r\n        tween(lbl_node)\r\n            .by(1, { position: v3(0, 150, 0) }, { easing: \"fade\" })\r\n            .call(() => { lbl_node?.destroy(); })\r\n            .start();\r\n    }\r\n}\r\n"]}