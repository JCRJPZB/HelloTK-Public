{"version":3,"sources":["file:///E:/GitHub/HelloTK/assets/Script/UI/MainScene/League/DynamicList.ts"],"names":["_decorator","Label","Generator","Subscribe","UIBase","LeagueMgr","ccclass","property","DynamicList","Map","onInit","league_id","listen","name","refreshDynamics","gen","getInstance","leagueMgr","view_root","getNode","page_num_box","getComp","page_num","addClickEvent","turnToPage","string","node","on","box","Number","isNaN","toString","max_page","onOpen","trigger","removeAllChildren","dynamic_page_map","clear","dynamics","getLeagueDynamicsById","new_page","i","length","generator","active","set","Math","floor","createDynamic","size","first_page","get","current_page","parent","info","new_dynamic","content","getChildByPath","getComponent","time","getChildByName","isNext","page"],"mappings":"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","sourcesContent":["import { _decorator, Node, Label, EditBox } from 'cc';\r\nimport { Generator } from '../../../Tools/Generator';\r\nimport { Subscribe } from '../../../Tools/Subscribe';\r\nimport { UIBase } from '../../UIBase';\r\nimport { LeagueMgr } from './LeagueMgr';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('DynamicList')\r\nexport class DynamicList extends UIBase {\r\n\r\n    private gen: Generator | null = null;\r\n    private leagueMgr: LeagueMgr | null = null;\r\n\r\n    private dynamic_page_map: Map<number, Node> = new Map();\r\n\r\n    private view_root: Node | undefined;\r\n    private page_num_box: EditBox | undefined;\r\n    private page_num: number = 0;\r\n    private max_page: number = 0;\r\n    private current_page: Node | undefined;\r\n\r\n    protected onInit(league_id: string) {\r\n        Subscribe.listen(\"refresh dynamics\", this.name, this.refreshDynamics, this);\r\n\r\n        this.gen = Generator.getInstance();\r\n        this.leagueMgr = LeagueMgr.getInstance();\r\n\r\n        this.view_root = this.getNode(\"Dynamic_View\");\r\n        this.page_num_box = this.getComp(\"PageNum\", \"EditBox\");\r\n        this.page_num = 1;\r\n\r\n        this.addClickEvent(\"PreBtn\", () => { this.turnToPage(-1, false); }, this);\r\n        this.addClickEvent(\"NextBtn\", () => { this.turnToPage(-1, true); }, this);\r\n        if (this.page_num_box) {\r\n            this.page_num_box.string = \"1/1\";\r\n            this.page_num_box.node.on(\"editing-did-ended\", (box: EditBox) => {\r\n                let page_num = Number(box.string);\r\n                if (!isNaN(page_num)) { this.turnToPage(page_num, false); }\r\n                box.string = this.page_num.toString() + \"/\" + this.max_page.toString();\r\n            }, this);\r\n        }\r\n    }\r\n\r\n    protected onOpen(league_id: string) {\r\n        this.refreshDynamics(league_id);\r\n    }\r\n\r\n    private refreshDynamics(league_id: string) {\r\n        if (!this.leagueMgr || !this.gen || !this.view_root) { Subscribe.trigger(\"log err\", \"Init failed!\"); return; }\r\n        this.view_root.removeAllChildren();\r\n        this.dynamic_page_map.clear();\r\n        let dynamics = this.leagueMgr.getLeagueDynamicsById(league_id)[\"dynamics\"];\r\n        let new_page: Node | null = null;\r\n        for (let i = 0; i < dynamics.length; i++) {\r\n            if (i % 8 == 0) { // 一页8条动态\r\n                new_page = this.gen.generator(this.view_root, \"Dynamics\");\r\n                if (new_page && i / 8 > 0) { new_page.active = false; } // 除了第一页都失活，实现默认显示第一页\r\n                if (!new_page) { break; }\r\n                this.dynamic_page_map.set(Math.floor(i / 8) + 1, new_page); // 根据页码保存\r\n            }\r\n            if (!new_page) { break; }\r\n            this.createDynamic(new_page, dynamics[i]);\r\n        }\r\n        if (this.dynamic_page_map.size > 0) {\r\n            let first_page = this.dynamic_page_map.get(1);\r\n            if (first_page) { this.current_page = first_page; }\r\n        } else {\r\n            new_page = this.gen.generator(this.view_root, \"Dynamics\");\r\n            if (new_page) {\r\n                this.dynamic_page_map.set(1, new_page);\r\n                this.current_page = new_page;\r\n            }\r\n        }\r\n        if (this.page_num_box) {\r\n            this.max_page = this.dynamic_page_map.size;\r\n            this.max_page = this.max_page > 0 ? this.max_page : 1;\r\n            this.page_num = 1;\r\n            this.page_num_box.string = this.page_num.toString() + \"/\" + this.max_page.toString();\r\n        }\r\n    }\r\n\r\n    createDynamic(parent: Node, info: any) {\r\n        if (!this.gen) { this.gen = Generator.getInstance(); }\r\n        let new_dynamic = this.gen.generator(parent, \"League_Dynamic\");\r\n        if (!new_dynamic) { return; }\r\n        let content = new_dynamic.getChildByPath(\"Mask/Content\")?.getComponent(Label);\r\n        let time = new_dynamic.getChildByName(\"Timestamp\")?.getComponent(Label);\r\n        if (!content || !time) { return; }\r\n        content.string = info[\"content\"];\r\n        time.string = info[\"time\"];\r\n    }\r\n\r\n    turnToPage(page_num: number, isNext: boolean) {\r\n        if (page_num > 0) {\r\n            if (page_num === this.page_num) { return; }\r\n            page_num = page_num > this.max_page ? this.max_page : page_num;\r\n        } else if (isNext) {\r\n            if (this.page_num >= this.max_page) { return; }\r\n            page_num = this.page_num + 1;\r\n        } else {\r\n            if (this.page_num <= 1) { return; }\r\n            page_num = this.page_num - 1;\r\n        }\r\n        let page = this.dynamic_page_map.get(page_num);\r\n        if (!page) { return; }\r\n        this.page_num = page_num;\r\n        if (this.page_num_box) { this.page_num_box.string = this.page_num.toString() + \"/\" + this.max_page.toString(); }\r\n        if (this.current_page) { this.current_page.active = false; }\r\n        this.current_page = page;\r\n        this.current_page.active = true;\r\n        return;\r\n    }\r\n}\r\n"]}