{"version":3,"sources":["file:///E:/GitHub/HelloTK/assets/Script/UI/StageScene/StageDetails.ts"],"names":["_decorator","Component","Sprite","Label","UITransform","Size","ItemMgr","Functions","Generator","ImgMgr","Subscribe","StageMgr","ccclass","property","StageDetails","onLoad","listen","name","changeSelect","stage_name","node","getChildByPath","getComponent","description","i","goal_temp","toString","goal","push","reward_item_root","start_btn","getChildByName","data","conf","getInstance","getStageConfById","string","goal_strs","getStageGoal","length","gen","setItemList","on","trigger","items_conf","itemMgr","portrait","reward_items","generator","initItem","pop","destroy","setContentSize","idx","sf","img_name","getItemConf","spriteFrame","getImg","num","numToChar","Math","floor","setPosition"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Sprite, Label, UITransform, Size } from 'cc';\r\nimport { ItemMgr } from '../../Items/ItemMgr';\r\nimport { Functions } from '../../Tools/Functions';\r\nimport { Generator } from '../../Tools/Generator';\r\nimport { ImgMgr } from '../../Tools/ImgMgr';\r\nimport { Subscribe } from '../../Tools/Subscribe';\r\nimport { StageMgr } from './StageMgr';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('StageDetails')\r\nexport class StageDetails extends Component {\r\n\r\n    private stage_name: Label | null | undefined = null;\r\n    private description: Label | null | undefined = null;\r\n    private goal: Label[] = [];\r\n    private reward_item_root: Node | null = null;\r\n    private reward_items: Node[] = [];\r\n    private start_btn: Node | null = null;\r\n\r\n    onLoad() {\r\n        Subscribe.listen(\"change select stage\", this.name, this.changeSelect, this); // 监听切换关卡事件\r\n        this.stage_name = this.node.getChildByPath(\"StageName/Label\")?.getComponent(Label);\r\n        this.description = this.node.getChildByPath(\"Description/view/content\")?.getComponent(Label);\r\n        for (let i = 1; i <= 3; i++) {\r\n            let goal_temp = this.node.getChildByPath(\"Goal/Lbl_Root/Goal_\" + i.toString())?.getComponent(Label);\r\n            if (goal_temp) { this.goal.push(goal_temp); }\r\n        }\r\n        this.reward_item_root = this.node.getChildByPath(\"Reward/Items/view/content\");\r\n        this.start_btn = this.node.getChildByName(\"Start_Btn\");\r\n    }\r\n\r\n    private changeSelect(data: any) {\r\n        let conf = StageMgr.getInstance().getStageConfById(data[\"id\"]); // 根据关卡名读取当前关卡配置\r\n        if (this.stage_name) { this.stage_name.string = conf[\"name\"]; } // 修改关卡名标签内容\r\n        if (this.description) { this.description.string = conf[\"description\"]; }\r\n        let goal_strs = StageMgr.getInstance().getStageGoal(data[\"idx\"]); // 获取三星条件\r\n        if (this.goal.length >= goal_strs.length) {\r\n            for (let i = 0; i < this.goal.length; i++) {\r\n                if (i < goal_strs.length) { this.goal[i].string = goal_strs[i]; }\r\n            }\r\n        }\r\n\r\n        let gen = Generator.getInstance(); // 预制件实例化生成器\r\n        this.setItemList(conf[\"items\"], gen); // 设置掉落清单\r\n\r\n        if (this.start_btn) { // 点击确认按钮\r\n            this.start_btn.on(\"click\", () => {\r\n                Subscribe.trigger(\"load scene\", \"BattleField\", data); // 进入战斗场景\r\n            });\r\n        }\r\n    }\r\n\r\n    private setItemList(items_conf: any, gen: Generator) {\r\n        let itemMgr = ItemMgr.getInstance(); // 物品管理器\r\n        for (let i = 0; i < items_conf.length; i++) {\r\n            if (this.reward_item_root) {\r\n                let portrait: Node | null = null;\r\n                if (this.reward_items.length <= i) { // 如果现有的物品节点数量不够则生成新的\r\n                    portrait = gen.generator(this.reward_item_root, \"ItemPortrait\"); // 实例化掉落物图片预制件\r\n                    if (portrait) { this.reward_items.push(portrait); } // 把新的放进去\r\n                } else { // 反之则使用已有的\r\n                    portrait = this.reward_items[i];\r\n                }\r\n                if (portrait) { this.initItem(items_conf[i], portrait, i, itemMgr); } // 初始化物品\r\n            }\r\n        }\r\n        while (this.reward_items.length > items_conf.length) { this.reward_items.pop()?.destroy(); } // 如果现有的比需要的物品节点多，则将多余的删除\r\n        this.reward_item_root?.getComponent(UITransform)?.setContentSize(new Size(items_conf.length * 150, 150)); // 重新设置物品框大小\r\n    }\r\n\r\n    private initItem(conf: any, node: Node, idx: number, itemMgr: ItemMgr) {\r\n        let sf = node.getComponent(Sprite); // 获得掉落物图片的精灵组件\r\n        let img_name = itemMgr.getItemConf(conf[\"id\"])[\"img\"]; // 获取配置中的贴图路径\r\n        if (img_name && sf) {\r\n            sf.spriteFrame = ImgMgr.getInstance().getImg(img_name); // 根据配置设置精灵组件贴图\r\n        }\r\n        let num = node.getChildByName(\"Num\")?.getComponent(Label); // 物品数量Label\r\n        if (num) {\r\n            if (conf[\"max\"] > 1) { // 最大掉落数大于1则显示掉落区间\r\n                if (conf[\"max\"] == conf[\"min\"]) { // 最大掉落数等于最小掉落数则显示掉落数\r\n                    num.string = Functions.numToChar(conf[\"max\"]);\r\n                } else { // 否则显示平均值\r\n                    num.string = \"约\" + Functions.numToChar(Math.floor((conf[\"max\"] + conf[\"min\"]) / 2));\r\n                }\r\n            }\r\n        }\r\n        node.setPosition(idx * 125 + 75, 0, 0); // 计算位置并摆放\r\n    }\r\n}\r\n"]}