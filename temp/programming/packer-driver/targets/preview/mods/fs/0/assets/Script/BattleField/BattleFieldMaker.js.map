{"version":3,"sources":["file:///E:/GitHub/HelloTK/assets/Script/BattleField/BattleFieldMaker.ts"],"names":["_decorator","Component","find","Vec3","v3","HerosMgr","HpMgr","Generator","Subscribe","Info","Configure","ccclass","property","BattleFieldMaker","onLoad","listen","name","prepare","enemy_conf","army_node","ally_node","getChildByName","enemy_node","trigger","mgr","getInstance","gen","ally_conf","getTroops","prePos","getConfigure","genArmies","allies","enemies","parent","conf","camp","hp","conf_map","Map","forEach","hero","set","hero_ids","pos_idxs","length","i","hero_conf","get","pos_idx","pos","pos_vec","hero_node","generator","info","getComponent","init","push","genHpNum","init_total_hp"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, find, Vec3, v3 } from 'cc';\r\nimport { HerosMgr } from '../Heros/HerosMgr';\r\nimport { HpMgr } from './HP/HpMgr';\r\nimport { Generator } from '../Tools/Generator';\r\nimport { Subscribe } from '../Tools/Subscribe';\r\nimport { Info } from './Attack/Info';\r\nimport { Configure } from '../Tools/Configure';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('BattleFieldMaker')\r\nexport class BattleFieldMaker extends Component {\r\n\r\n    private allies: Info[] = [];\r\n    private enemies: Info[] = [];\r\n\r\n    onLoad() {\r\n        Subscribe.listen(\"prepare battle\", this.name, this.prepare, this);\r\n    }\r\n\r\n    private prepare(enemy_conf: any) {\r\n        let army_node = find(\"/SafeArea/Armies\"); // 队伍父节点\r\n        let ally_node = army_node?.getChildByName(\"Allies\"); // 友方队伍父节点\r\n        let enemy_node = army_node?.getChildByName(\"Enemies\"); // 敌方队伍父节点\r\n        if (!ally_node || !enemy_node) {\r\n            Subscribe.trigger(\"print err\", \"Can't find armies nodes.\");\r\n            return;\r\n        }\r\n\r\n        let mgr = HerosMgr.getInstance(); // 武将Mgr\r\n        let gen = Generator.getInstance(); // 预制体实例化生成器\r\n        let ally_conf = mgr.getTroops(); // 获取友方阵容\r\n        let prePos = Configure.getConfigure(\"hero\")[\"common\"][\"prePos\"]; // 获取预先设定好的位置\r\n\r\n        this.genArmies(ally_node, ally_conf, gen, prePos, \"ally\"); // 生成友方队伍\r\n        this.genArmies(enemy_node, enemy_conf, gen, prePos, \"enemy\"); // 生成敌方队伍\r\n\r\n        Subscribe.trigger(\"battle is ready\", this.allies, this.enemies); // 生成完毕，开始战斗\r\n    }\r\n\r\n    private genArmies(parent: Node, conf: any, gen: Generator, prePos: any, camp: string) {\r\n        let hp = HpMgr.getInstance();\r\n        let conf_map: Map<string, any> = new Map();\r\n        conf[\"heros\"].forEach((hero: any) => {\r\n            conf_map.set(hero[\"id\"], hero);\r\n        });\r\n        let hero_ids = conf[\"formation\"][\"ids_idxs\"]; // id对应位置下标配置\r\n        let pos_idxs = conf[\"formation\"][\"pos_idxs\"]; // 位置下标数组\r\n        if (hero_ids.length <= pos_idxs.length) {\r\n            for (let i = 0; i < hero_ids.length; i++) {\r\n                let hero_conf = conf_map.get(hero_ids[i][\"id\"]); // 获取武将配置\r\n                let pos_idx = pos_idxs[hero_ids[i][\"idx\"]]; // 获取位置配置的下标\r\n                let pos = prePos[\"pos\"][pos_idx]; // 获取位置配置\r\n                let pos_vec: Vec3 = new Vec3(pos[0] * prePos[\"3d_dist\"], 0, pos[1] * prePos[\"3d_dist\"]);\r\n                let hero_node = gen.generator(parent, \"Hero_3D\", pos_vec); // 实例化武将节点\r\n                if (!hero_node) { return; }\r\n\r\n                gen.generator(hero_node, hero_conf[\"atkEff\"], v3(0, 10, 0)); // 生成攻击特效\r\n                gen.generator(hero_node, hero_conf[\"hitEff\"], v3(0, 10, 0)); // 生成受击特效\r\n                gen.generator(hero_node, hero_conf[\"arms\"]); // 实例化队伍\r\n\r\n                let info = hero_node.getComponent(Info); // Info对象，用于存储武将/怪物的属性及其他配置\r\n                if (!info) {\r\n                    Subscribe.trigger(\"log err\", \"Can't find component!\");\r\n                    return;\r\n                }\r\n                if (camp === \"ally\") { // 分阵营放置Info对象\r\n                    info.init(hero_conf[\"id\"], camp, hero_conf);\r\n                    this.allies.push(info);\r\n                } else if (camp === \"enemy\") {\r\n                    info.init(hero_conf[\"id\"], camp, hero_conf);\r\n                    this.enemies.push(info);\r\n                }\r\n                hp.genHpNum(info, camp); // 添加血量显示\r\n            }\r\n        }\r\n        hp.init_total_hp(conf, camp); // 总血量显示\r\n    }\r\n}\r\n"]}