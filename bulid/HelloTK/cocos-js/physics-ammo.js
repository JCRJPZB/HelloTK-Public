System.register(["./json-asset-1a4fee7d.js","./base.js","./index-60bf8166.js","./view-50c22e7e.js","./texture-buffer-pool-32e209c1.js","./deprecated-0fa1cf2f.js","./camera-component-ec549211.js","./renderable-component-b5e46bae.js","./transform-utils-65bf8251.js","./mesh-c8768986.js","./skeleton-314b4fa5.js","./index-bdb8067d.js","./collision-matrix-28b2cee7.js","./capsule-1280d817.js","./terrain-asset-42611908.js","./physics-framework.js","./_commonjsHelpers-19d0a8b5.js","./tuple-dictionary-5e20c301.js","./instantiated-9922024b.js","./array-collision-matrix-ec6af177.js"],(function(){"use strict";var t,i,e,s,o,n,r,a,l,h,d,c,p,u,_,S,y,f,g,C,E;return{setters:[function(p){t=p.a3,i=p.e2,e=p.c5,s=p.c9,o=p.gX,n=p.eb,r=p.e,a=p.ec,l=p.cD,h=p.cE,d=p.d,c=p.w},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(t){p=t.P,u=t.V,_=t.l,S=t.m},function(t){y=t.a,f=t.P},function(){},function(){},function(){},function(){},function(t){g=t.T},function(t){C=t.A},function(t){E=t.A}],execute:function(){function T(t,i){return t.setValue(i.x,i.y,i.z),t}function m(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t}function A(t,i){return t.setValue(i.x,i.y,i.z,i.w),t}function b(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t.w=i.w(),t}function O(t,i){delete C.getCache(i)[C.getPointer(t)]}function P(i,e){for(var s=e.renderingSubMeshes.length,o=0;o<s;o++){var n=e.renderingSubMeshes[o],r=n.geometricInfo;if(r){var a=n.primitiveMode,l=r.positions,h=r.indices,d=new C.btVector3,c=new C.btVector3,p=new C.btVector3;if(a===t.TRIANGLE_LIST)for(var u=h.length,_=0;_<u;_+=3){var S=3*h[_],y=3*h[_+1],f=3*h[_+2];d.setValue(l[S],l[S+1],l[S+2]),c.setValue(l[y],l[y+1],l[y+2]),p.setValue(l[f],l[f+1],l[f+2]),i.addTriangle(d,c,p)}else if(a===t.TRIANGLE_STRIP)for(var g=h.length-2,E=0,T=0;T<g;T+=1){var m=3*h[T-E],A=3*h[T+E+1],b=3*h[T+2];E=~E,d.setValue(l[m],l[m+1],l[m+2]),c.setValue(l[A],l[A+1],l[A+2]),p.setValue(l[b],l[b+1],l[b+2]),i.addTriangle(d,c,p)}else if(a===t.TRIANGLE_FAN){var O=h.length-1,P=3*h[0];d.setValue(l[P],l[P+1],l[P+2]);for(var B=1;B<O;B+=1){var R=3*h[B],I=3*h[B+1];c.setValue(l[R],l[R+1],l[R+2]),p.setValue(l[I],l[I+1],l[I+2]),i.addTriangle(d,c,p)}}C.destroy(d),C.destroy(c),C.destroy(p)}}return i}var B,R,I,v,w,D,Y,M,N;!function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(B||(B={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(R||(R={})),C.AmmoCollisionFlags=R,function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(I||(I={})),C.AmmoCollisionObjectTypes=I,function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(v||(v={})),function(t){t[t.CF_ANISOTROPIC_FRICTION_DISABLED=0]="CF_ANISOTROPIC_FRICTION_DISABLED",t[t.CF_ANISOTROPIC_FRICTION=1]="CF_ANISOTROPIC_FRICTION",t[t.CF_ANISOTROPIC_ROLLING_FRICTION=2]="CF_ANISOTROPIC_ROLLING_FRICTION"}(w||(w={})),C.AmmoAnisotropicFrictionFlags=w,function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(D||(D={})),C.AmmoRigidBodyFlags=D,function(t){t[t.BOX_SHAPE_PROXYTYPE=0]="BOX_SHAPE_PROXYTYPE",t[t.TRIANGLE_SHAPE_PROXYTYPE=1]="TRIANGLE_SHAPE_PROXYTYPE",t[t.TETRAHEDRAL_SHAPE_PROXYTYPE=2]="TETRAHEDRAL_SHAPE_PROXYTYPE",t[t.CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE=3]="CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE",t[t.CONVEX_HULL_SHAPE_PROXYTYPE=4]="CONVEX_HULL_SHAPE_PROXYTYPE",t[t.CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE=5]="CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE",t[t.CUSTOM_POLYHEDRAL_SHAPE_TYPE=6]="CUSTOM_POLYHEDRAL_SHAPE_TYPE",t[t.IMPLICIT_CONVEX_SHAPES_START_HERE=7]="IMPLICIT_CONVEX_SHAPES_START_HERE",t[t.SPHERE_SHAPE_PROXYTYPE=8]="SPHERE_SHAPE_PROXYTYPE",t[t.MULTI_SPHERE_SHAPE_PROXYTYPE=9]="MULTI_SPHERE_SHAPE_PROXYTYPE",t[t.CAPSULE_SHAPE_PROXYTYPE=10]="CAPSULE_SHAPE_PROXYTYPE",t[t.CONE_SHAPE_PROXYTYPE=11]="CONE_SHAPE_PROXYTYPE",t[t.CONVEX_SHAPE_PROXYTYPE=12]="CONVEX_SHAPE_PROXYTYPE",t[t.CYLINDER_SHAPE_PROXYTYPE=13]="CYLINDER_SHAPE_PROXYTYPE",t[t.UNIFORM_SCALING_SHAPE_PROXYTYPE=14]="UNIFORM_SCALING_SHAPE_PROXYTYPE",t[t.MINKOWSKI_SUM_SHAPE_PROXYTYPE=15]="MINKOWSKI_SUM_SHAPE_PROXYTYPE",t[t.MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE=16]="MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE",t[t.BOX_2D_SHAPE_PROXYTYPE=17]="BOX_2D_SHAPE_PROXYTYPE",t[t.CONVEX_2D_SHAPE_PROXYTYPE=18]="CONVEX_2D_SHAPE_PROXYTYPE",t[t.CUSTOM_CONVEX_SHAPE_TYPE=19]="CUSTOM_CONVEX_SHAPE_TYPE",t[t.CONCAVE_SHAPES_START_HERE=20]="CONCAVE_SHAPES_START_HERE",t[t.TRIANGLE_MESH_SHAPE_PROXYTYPE=21]="TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE=22]="SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.FAST_CONCAVE_MESH_PROXYTYPE=23]="FAST_CONCAVE_MESH_PROXYTYPE",t[t.TERRAIN_SHAPE_PROXYTYPE=24]="TERRAIN_SHAPE_PROXYTYPE",t[t.GIMPACT_SHAPE_PROXYTYPE=25]="GIMPACT_SHAPE_PROXYTYPE",t[t.MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE=26]="MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE",t[t.EMPTY_SHAPE_PROXYTYPE=27]="EMPTY_SHAPE_PROXYTYPE",t[t.STATIC_PLANE_PROXYTYPE=28]="STATIC_PLANE_PROXYTYPE",t[t.CUSTOM_CONCAVE_SHAPE_TYPE=29]="CUSTOM_CONCAVE_SHAPE_TYPE",t[t.CONCAVE_SHAPES_END_HERE=30]="CONCAVE_SHAPES_END_HERE",t[t.COMPOUND_SHAPE_PROXYTYPE=31]="COMPOUND_SHAPE_PROXYTYPE",t[t.SOFTBODY_SHAPE_PROXYTYPE=32]="SOFTBODY_SHAPE_PROXYTYPE",t[t.HFFLUID_SHAPE_PROXYTYPE=33]="HFFLUID_SHAPE_PROXYTYPE",t[t.HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE=34]="HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE",t[t.INVALID_SHAPE_PROXYTYPE=35]="INVALID_SHAPE_PROXYTYPE",t[t.MAX_BROADPHASE_COLLISION_TYPES=36]="MAX_BROADPHASE_COLLISION_TYPES"}(Y||(Y={})),C.AmmoBroadphaseNativeTypes=Y,function(t){t[t.DefaultFilter=1]="DefaultFilter",t[t.StaticFilter=2]="StaticFilter",t[t.KinematicFilter=4]="KinematicFilter",t[t.DebrisFilter=8]="DebrisFilter",t[t.SensorTrigger=16]="SensorTrigger",t[t.CharacterFilter=32]="CharacterFilter",t[t.AllFilter=-1]="AllFilter"}(M||(M={})),C.AmmoCollisionFilterGroups=M,function(t){t[t.CD_STATIC_STATIC_REPORTED=1]="CD_STATIC_STATIC_REPORTED",t[t.CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD=2]="CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD",t[t.CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION=4]="CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION"}(N||(N={})),C.AmmoDispatcherFlags=N;var F={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},L={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},H=function(){function t(){this.EMPTY_SHAPE=new C.btEmptyShape,this.TRANSFORM=new C.btTransform,this.TRANSFORM_1=new C.btTransform,this.VECTOR3_0=new C.btVector3,this.VECTOR3_1=new C.btVector3,this.QUAT_0=new C.btQuaternion}return t.isNotEmptyShape=function(t){return t!==this.instance.EMPTY_SHAPE},i(t,null,[{key:"instance",get:function(){return null==t._instance&&(t._instance=new t),t._instance}}]),t}();H._instance=void 0;var V=new e,G=new e,x=new s,k=V,W=G,X=function(){var t=s.prototype;function s(){this.id=void 0,this._isEnabled=!1,this._isUsingCCD=!1,this.id=s.idCounter++}return t.setMass=function(t){if(this._rigidBody.isDynamic){var i=this._sharedBody.bodyStruct.localInertia;i.setValue(1.6666666269302368,1.6666666269302368,1.6666666269302368);var e=this.impl.getCollisionShape();e.isCompound()?this._sharedBody.bodyCompoundShape.getNumChildShapes()>0&&e.calculateLocalInertia(this._rigidBody.mass,i):e.calculateLocalInertia(this._rigidBody.mass,i),this.impl.setMassProps(t,i),this._wakeUpIfSleep(),this._sharedBody.dirty|=B.BODY_RE_ADD}},t.setType=function(t){this._sharedBody.setType(t)},t.setLinearDamping=function(){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.setAngularDamping=function(){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.useGravity=function(t){if(this._rigidBody.isDynamic){var i=this.impl.getFlags();t?i&=~D.BT_DISABLE_WORLD_GRAVITY:(this.impl.setGravity(T(H.instance.VECTOR3_0,e.ZERO)),i|=D.BT_DISABLE_WORLD_GRAVITY),this.impl.setFlags(i),this._wakeUpIfSleep(),this._sharedBody.dirty|=B.BODY_RE_ADD}},t.useCCD=function(t){this.impl.setCcdMotionThreshold(t?.01:0),this.impl.setCcdSweptSphereRadius(t?.1:0),this._isUsingCCD=t},t.isUsingCCD=function(){return this._isUsingCCD},t.setLinearFactor=function(t){this.impl.setLinearFactor(T(H.instance.VECTOR3_0,t)),this._wakeUpIfSleep()},t.setAngularFactor=function(t){this.impl.setAngularFactor(T(H.instance.VECTOR3_0,t)),this._wakeUpIfSleep()},t.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?this.impl.forceActivationState(v.ACTIVE_TAG):this.impl.forceActivationState(v.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},t.clearState=function(){this.impl.clearState()},t.clearVelocity=function(){this.setLinearVelocity(e.ZERO),this.setAngularVelocity(e.ZERO)},t.clearForces=function(){this.impl.clearForces()},t.initialize=function(t){this._rigidBody=t,this._sharedBody=p.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.wakeUp=function(t){void 0===t&&(t=!0),this.impl.activate(t)},t.sleep=function(){return this.impl.wantsSleeping()},t.setSleepThreshold=function(t){this._wakeUpIfSleep(),this.impl.setSleepingThresholds(t,t)},t.getSleepThreshold=function(){return this.impl.getLinearSleepingThreshold()},t.getLinearVelocity=function(t){return m(t,this.impl.getLinearVelocity())},t.setLinearVelocity=function(t){this._wakeUpIfSleep(),T(this.impl.getLinearVelocity(),t)},t.getAngularVelocity=function(t){return m(t,this.impl.getAngularVelocity())},t.setAngularVelocity=function(t){this._wakeUpIfSleep(),T(this.impl.getAngularVelocity(),t)},t.applyLocalForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=e.transformQuat(k,t,s),n=i?e.transformQuat(W,i,s):e.ZERO;this.impl.applyForce(T(H.instance.VECTOR3_0,o),T(H.instance.VECTOR3_1,n))},t.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),e.transformQuat(k,t,this._sharedBody.node.worldRotation),this.impl.applyTorque(T(H.instance.VECTOR3_0,k))},t.applyLocalImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=e.transformQuat(k,t,s),n=i?e.transformQuat(W,i,s):e.ZERO;this.impl.applyImpulse(T(H.instance.VECTOR3_0,o),T(H.instance.VECTOR3_1,n))},t.applyForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=i||e.ZERO;this.impl.applyForce(T(H.instance.VECTOR3_0,t),T(H.instance.VECTOR3_1,s))},t.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),this.impl.applyTorque(T(H.instance.VECTOR3_0,t))},t.applyImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=i||e.ZERO;this.impl.applyImpulse(T(H.instance.VECTOR3_0,t),T(H.instance.VECTOR3_1,s))},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t._wakeUpIfSleep=function(){this.isAwake||this.impl.activate(!0)},i(s,[{key:"isAwake",get:function(){var t=this.impl.getActivationState();return t===v.ACTIVE_TAG||t===v.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return this.impl.getActivationState()===v.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return this.impl.getActivationState()===v.ISLAND_SLEEPING}},{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}}]),s}();X.idCounter=0;var U=function(){function t(){}return t.setWrapper=function(t){this.ptr2WrapObj[C.getPointer(t.impl)]=t},t.delWrapper=function(t){delete this.ptr2WrapObj[C.getPointer(t.impl)]},t.getWrapperByPtr=function(t){return this.ptr2WrapObj[t]},i(t,null,[{key:"bodyStructs",get:function(){return this.bodyAndGhosts}},{key:"ghostStructs",get:function(){return this.bodyAndGhosts}}]),t}();U.bodyAndGhosts={},U.ptr2WrapObj={};var j=V,z=x,J=0,K=function(){function t(i,e){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=p.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._wrappedBody=null,this.id=t.idCounter++,this.wrappedWorld=e,this.node=i}t.getSharedBody=function(i,e,s){var o,n=i.uuid;if(t.sharedBodesMap.has(n))o=t.sharedBodesMap.get(n);else{o=new t(i,e);var r=f.DEFAULT,a=p.instance.collisionMatrix[r];o._collisionFilterGroup=r,o._collisionFilterMask=a,t.sharedBodesMap.set(i.uuid,o)}if(s){o._wrappedBody=s;var l=s.rigidBody.group,h=p.instance.collisionMatrix[l];o._collisionFilterGroup=l,o._collisionFilterMask=h}return o};var e=t.prototype;return e._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=new C.btTransform;t.setIdentity(),T(t.getOrigin(),this.node.worldPosition);var i=new C.btQuaternion;A(i,this.node.worldRotation),t.setRotation(i);var e=new C.btDefaultMotionState(t),s=new C.btVector3(1.6666666269302368,1.6666666269302368,1.6666666269302368),o=new C.btCompoundShape,n=0;this._wrappedBody&&this._wrappedBody.rigidBody.enabled&&this._wrappedBody.rigidBody.isDynamic&&(n=this._wrappedBody.rigidBody.mass),0===n&&s.setValue(0,0,0);var r=new C.btRigidBodyConstructionInfo(n,e,H.instance.EMPTY_SHAPE,s),a=new C.btRigidBody(r),l=p.instance.sleepThreshold;a.setSleepingThresholds(l,l),this._bodyStruct={id:J++,body:a,localInertia:s,motionState:e,startTransform:t,shape:o,rbInfo:r,worldQuat:i,wrappedShapes:[],useCompound:!1},U.bodyStructs[this._bodyStruct.id]=this._bodyStruct,this.body.setUserIndex2(2),this.body.setUserIndex(this._bodyStruct.id),C.CC_CONFIG.ignoreSelfBody&&this._ghostStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0),this.wrappedBody&&this.setBodyType(this.wrappedBody.rigidBody.type)}},e._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=new C.btCollisionObject,i=new C.btCompoundShape;t.setCollisionShape(i),t.setCollisionFlags(R.CF_STATIC_OBJECT|R.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:J++,ghost:t,shape:i,worldQuat:new C.btQuaternion,wrappedShapes:[]},U.ghostStructs[this._ghostStruct.id]=this._ghostStruct,this.ghost.setUserIndex2(2),this.ghost.setUserIndex(this._ghostStruct.id),C.CC_CONFIG.ignoreSelfBody&&this._bodyStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0),this.wrappedBody&&this.setGhostType(this.wrappedBody.rigidBody.type)}},e.setType=function(t){this.setBodyType(t),this.setGhostType(t)},e.setBodyType=function(t){if(this._bodyStruct&&this._wrappedBody){var i=this._bodyStruct.body,e=this._wrappedBody,s=e.rigidBody,o=i.getCollisionFlags(),n=H.instance.VECTOR3_0;switch(t){case y.DYNAMIC:o&=~R.CF_KINEMATIC_OBJECT,o&=~R.CF_STATIC_OBJECT,i.setCollisionFlags(o),e.setMass(s.mass),e.useGravity(s.useGravity),e.setAllowSleep(s.allowSleep);break;case y.KINEMATIC:n.setValue(0,0,0),i.setMassProps(0,n),o|=R.CF_KINEMATIC_OBJECT,o&=~R.CF_STATIC_OBJECT,i.setCollisionFlags(o),i.forceActivationState(v.DISABLE_DEACTIVATION);break;case y.STATIC:default:n.setValue(0,0,0),i.setMassProps(0,n),o|=R.CF_STATIC_OBJECT,o&=~R.CF_KINEMATIC_OBJECT,i.setCollisionFlags(o),i.forceActivationState(v.ISLAND_SLEEPING)}this.dirty|=B.BODY_RE_ADD}},e.setGhostType=function(t){if(this._ghostStruct){var i=this._ghostStruct.ghost,e=i.getCollisionFlags();switch(t){case y.DYNAMIC:case y.KINEMATIC:e&=~R.CF_STATIC_OBJECT,e|=R.CF_KINEMATIC_OBJECT,i.setCollisionFlags(e),i.forceActivationState(v.DISABLE_DEACTIVATION);break;case y.STATIC:default:e&=~R.CF_KINEMATIC_OBJECT,e|=R.CF_STATIC_OBJECT,i.setCollisionFlags(e),i.forceActivationState(v.ISLAND_SLEEPING)}this.dirty|=B.GHOST_RE_ADD}},e.addShape=function(t,i){function e(t,i){t.body.setCollisionShape(i),t.dirty|=B.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!==s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var o=0;o<s;o++)this.bodyStruct.wrappedShapes[o].setCompound(this.bodyCompoundShape);e(this,this.bodyStruct.shape)}else e(this,t.impl)}this.bodyEnabled=!0}},e.removeShape=function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(o(this.ghostStruct.wrappedShapes,e),t.setCompound(null),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(null):this.body.setCollisionShape(H.instance.EMPTY_SHAPE),this.body.activate(!0),this.dirty|=B.BODY_RE_ADD,o(this.bodyStruct.wrappedShapes,s),this.bodyEnabled=!1)}},e.addJoint=function(t,i){i?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},e.removeJoint=function(t,i){if(i){var e=this.wrappedJoints1.indexOf(t);e>=0&&o(this.wrappedJoints1,e)}else{var s=this.wrappedJoints0.indexOf(t);s>=0&&o(this.wrappedJoints0,s)}},e.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&B.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&B.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},e.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=this.body.getWorldTransform();if(T(t.getOrigin(),this.node.worldPosition),A(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat),this.node.hasChangedFlags&n.SCALE&&this.syncBodyScale(),this.body.isKinematicObject()){var i=this.body.getMotionState();i&&i.setWorldTransform(t)}else this.isBodySleeping()&&this.body.activate()}},e.syncPhysicsToScene=function(){if(!this.body.isStaticOrKinematicObject()&&!this.isBodySleeping()){var t=this.bodyStruct.startTransform;if(this.body.getMotionState().getWorldTransform(t),this.node.worldPosition=m(j,t.getOrigin()),t.getBasis().getRotation(this.bodyStruct.worldQuat),this.node.worldRotation=b(z,this.bodyStruct.worldQuat),this._ghostStruct){var i=this.ghost.getWorldTransform();T(i.getOrigin(),this.node.worldPosition),A(this.ghostStruct.worldQuat,this.node.worldRotation),i.setRotation(this.ghostStruct.worldQuat)}}},e.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=this.ghost.getWorldTransform();T(t.getOrigin(),this.node.worldPosition),A(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat),this.node.hasChangedFlags&n.SCALE&&this.syncGhostScale(),this.ghost.activate()}},e.syncInitialBody=function(){var t=this.body.getWorldTransform();T(t.getOrigin(),this.node.worldPosition),A(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat),this.syncBodyScale(),this.body.activate()},e.syncInitialGhost=function(){var t=this.ghost.getWorldTransform();T(t.getOrigin(),this.node.worldPosition),A(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat),this.syncGhostScale(),this.ghost.activate()},e.syncBodyScale=function(){for(var t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].updateScale();for(var i=0;i<this.wrappedJoints0.length;i++)this.wrappedJoints0[i].updateScale0();for(var e=0;e<this.wrappedJoints1.length;e++)this.wrappedJoints1[e].updateScale1()},e.syncGhostScale=function(){for(var t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].updateScale()},e.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},e.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},e.destroy=function(){if(t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var i=this._bodyStruct;C.destroy(i.localInertia),C.destroy(i.worldQuat),C.destroy(i.startTransform),C.destroy(i.motionState),C.destroy(i.rbInfo),C.destroy(i.shape),O(i.shape,C.btCollisionShape),C.castObject(i.body,C.btRigidBody).wrapped=null,O(i.body,C.btRigidBody),O(i.body,C.btCollisionObject),delete U.bodyStructs[i.id],this._bodyStruct=null}if(this._ghostStruct){var e=this._ghostStruct;C.destroy(e.worldQuat),C.destroy(e.shape),O(e.shape,C.btCollisionShape),C.destroy(e.ghost),delete U.bodyStructs[e.id],this._ghostStruct=null}},e.isBodySleeping=function(){return this.body.getActivationState()===v.ISLAND_SLEEPING},i(t,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.shape}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.shape}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=B.BODY_RE_ADD,this.dirty|=B.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=B.BODY_RE_ADD,this.dirty|=B.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){if(t){if(this.bodyIndex<0){if(0===this.bodyStruct.wrappedShapes.length){if(!this.wrappedBody)return;if(!this.wrappedBody.rigidBody.isDynamic)return}this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitialBody()}}else this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(this.body.clearState(),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();K.idCounter=0,K.sharedBodesMap=new Map;var Q=function(){function t(t){this.impl=null,this.event=void 0,this.event=t}var o=t.prototype;return o.getLocalPointOnA=function(t){this.impl&&m(t,this.impl.m_localPointA)},o.getLocalPointOnB=function(t){this.impl&&m(t,this.impl.m_localPointB)},o.getWorldPointOnA=function(t){this.impl&&m(t,this.impl.m_positionWorldOnA)},o.getWorldPointOnB=function(t){this.impl&&m(t,this.impl.m_positionWorldOnB)},o.getLocalNormalOnA=function(t){if(this.impl){m(t,this.impl.m_normalWorldOnB),this.isBodyA||e.negate(t,t);var i=x,o=H.instance.QUAT_0;this.event.impl.getBody0().getWorldTransform().getBasis().getRotation(o),b(i,o),s.conjugate(i,i),e.transformQuat(t,t,i)}},o.getLocalNormalOnB=function(t){if(this.impl){var i=x,o=H.instance.QUAT_0;this.event.impl.getBody1().getWorldTransform().getBasis().getRotation(o),b(i,o),s.conjugate(i,i),m(t,this.impl.m_normalWorldOnB),e.transformQuat(t,t,i)}},o.getWorldNormalOnA=function(t){this.impl&&(m(t,this.impl.m_normalWorldOnB),this.isBodyA||e.negate(t,t))},o.getWorldNormalOnB=function(t){this.impl&&m(t,this.impl.m_normalWorldOnB)},i(t,[{key:"isBodyA",get:function(){var t=this.event.selfCollider.shape.sharedBody.body,i=this.event.impl.getBody0();return Ammo.compare(i,t)}}]),t}(),q=[],Z=V,$=G,tt=function(){var t=s.prototype;function s(){this._btWorld=void 0,this._btBroadphase=void 0,this._btSolver=void 0,this._btDispatcher=void 0,this._btCollisionConfiguration=void 0,this.bodies=[],this.ghosts=[],this.constraints=[],this.triggerArrayMat=new E,this.collisionArrayMat=new E,this.contactsDic=new g,this.oldContactsDic=new g,this._btCollisionConfiguration=new C.btDefaultCollisionConfiguration,this._btDispatcher=new C.btCollisionDispatcher(this._btCollisionConfiguration),this._btBroadphase=new C.btDbvtBroadphase,this._btSolver=new C.btSequentialImpulseConstraintSolver,this._btWorld=new C.ccDiscreteDynamicsWorld(this._btDispatcher,this._btBroadphase,this._btSolver,this._btCollisionConfiguration);var t=H.instance.VECTOR3_0;t.setValue(0,-10,0),this._btWorld.setGravity(t),s.closeHitCB||(s.closeHitCB=new C.ccClosestRayResultCallback(t,t)),s.allHitsCB||(s.allHitsCB=new C.ccAllHitsRayResultCallback(t,t))}return t.setAllowSleep=function(t){this._btWorld.setAllowSleep(t)},t.setDefaultMaterial=function(){},t.setGravity=function(t){var i=H.instance.VECTOR3_0;T(i,t),this._btWorld.setGravity(i)},t.destroy=function(){(this.constraints.length||this.bodies.length)&&r("You should destroy all physics component first."),C.destroy(this._btWorld),C.destroy(this._btSolver),C.destroy(this._btBroadphase),C.destroy(this._btDispatcher),C.destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null,this._btDispatcher=null,this._btBroadphase=null,this._btSolver=null,this._btWorld=null,this.bodies=null,this.ghosts=null,this.constraints=null,this.triggerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,q.length=0},t.step=function(t,i,e){if(void 0===e&&(e=0),0!==this.bodies.length||0!==this.ghosts.length){void 0===i&&(i=t),this._btWorld.stepSimulation(i,e,t);for(var s=0;s<this.bodies.length;s++)this.bodies[s].syncPhysicsToScene()}},t.syncSceneToPhysics=function(){for(var t=0;t<this.ghosts.length;t++)this.ghosts[t].updateDirty(),this.ghosts[t].syncSceneToGhost();for(var i=0;i<this.bodies.length;i++)this.bodies[i].updateDirty(),this.bodies[i].syncSceneToPhysics()},t.syncAfterEvents=function(){this.syncSceneToPhysics()},t.raycast=function(t,i,o,n){var r=s.allHitsCB,a=T(r.m_rayFromWorld,t.o);t.computeHit(Z,i.maxDistance);var l=T(r.m_rayToWorld,Z);if(r.reset(i.mask,i.queryTrigger),this._btWorld.rayTest(a,l,r),r.hasHit()){for(var h=r.getCollisionShapePtrs(),d=r.getHitPointWorld(),c=r.getHitNormalWorld(),p=0,u=h.size();p<u;p++){var _=U.getWrapperByPtr(h.at(p));m(Z,d.at(p)),m($,c.at(p));var S=o.add();S._assign(Z,e.distance(t.o,Z),_.collider,$),n.push(S)}return!0}return!1},t.raycastClosest=function(t,i,o){var n=s.closeHitCB,r=T(n.m_rayFromWorld,t.o);t.computeHit(Z,i.maxDistance);var a=T(n.m_rayToWorld,Z);if(n.reset(i.mask,i.queryTrigger),this._btWorld.rayTest(r,a,n),n.hasHit()){var l=U.getWrapperByPtr(n.getCollisionShapePtr());return m(Z,n.getHitPointWorld()),m($,n.getHitNormalWorld()),o._assign(Z,e.distance(t.o,Z),l.collider,$),!0}return!1},t.getSharedBody=function(t,i){return K.getSharedBody(t,this,i)},t.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),this._btWorld.addRigidBody(t.body,t.collisionFilterGroup,t.collisionFilterMask))},t.removeSharedBody=function(t){var i=this.bodies.indexOf(t);i>=0&&(o(this.bodies,i),this._btWorld.removeRigidBody(t.body))},t.addGhostObject=function(t){this.ghosts.indexOf(t)<0&&(this.ghosts.push(t),this._btWorld.addCollisionObject(t.ghost,t.collisionFilterGroup,t.collisionFilterMask))},t.removeGhostObject=function(t){var i=this.ghosts.indexOf(t);i>=0&&(o(this.ghosts,i),this._btWorld.removeCollisionObject(t.ghost))},t.addConstraint=function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),this._btWorld.addConstraint(t.impl,!t.constraint.enableCollision),t.index=i)},t.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),this._btWorld.removeConstraint(t.impl),t.index=-1)},t.emitEvents=function(){for(var t=this._btWorld.getCcdTriggerRecorder(),i=t.size(),e=0,s=0;s<i;s+=e){for(var o=t.at(e),n=U.getWrapperByPtr(t.at(e+1)),r=0;r<o;r++){var a=U.getWrapperByPtr(t.at(e+r+2));if(n.collider.needTriggerEvent||a.collider.needTriggerEvent){var l=this.contactsDic.get(n.id,a.id);null==l&&(l=this.contactsDic.set(n.id,a.id,{shape0:n,shape1:a,contacts:[],impl:t}))}}e+=o+2}for(var h=this._btDispatcher.getNumManifolds(),d=0;d<h;d++){var c=this._btDispatcher.getManifoldByIndexInternal(d),p=c.getBody0(),u=c.getBody1();if(!p.useCharacter&&!u.useCharacter)for(var _=c.getNumContacts(),S=0;S<_;S++){var y=c.getContactPoint(S),f=p.getCollisionShape(),g=u.getCollisionShape(),E=void 0,T=void 0;if(E=f.isCompound()?C.castObject(f,C.btCompoundShape).getChildShape(y.m_index0).wrapped:f.wrapped,T=g.isCompound()?C.castObject(g,C.btCompoundShape).getChildShape(y.m_index1).wrapped:g.wrapped,E&&T&&(E.collider.needTriggerEvent||T.collider.needTriggerEvent||E.collider.needCollisionEvent||T.collider.needCollisionEvent)){var m=this.contactsDic.get(E.id,T.id);null==m&&(m=this.contactsDic.set(E.id,T.id,{shape0:E,shape1:T,contacts:[],impl:c})),m.contacts.push(y)}}}for(var A=this.contactsDic.getLength();A--;){q.push.apply(q,L.contacts),L.contacts.length=0;var b=this.contactsDic.getKeyByIndex(A),O=this.contactsDic.getDataByKey(b),P=O.shape0,B=O.shape1;this.oldContactsDic.set(P.id,B.id,O);var R=P.collider,I=B.collider;if(R&&I){if(R.isTrigger||I.isTrigger)this.triggerArrayMat.get(P.id,B.id)?F.type="onTriggerStay":(F.type="onTriggerEnter",this.triggerArrayMat.set(P.id,B.id,!0)),F.impl=O.impl,F.selfCollider=R,F.otherCollider=I,R.emit(F.type,F),F.selfCollider=I,F.otherCollider=R,I.emit(F.type,F);else{var v=R.attachedRigidBody,w=I.attachedRigidBody;if(v&&w){if(v.isSleeping&&w.isSleeping)continue}else if(null==v&&w){if(w.isSleeping)continue}else if(null==w&&v&&v.isSleeping)continue;this.collisionArrayMat.get(P.id,B.id)?L.type="onCollisionStay":(L.type="onCollisionEnter",this.collisionArrayMat.set(P.id,B.id,!0));for(var D=0;D<O.contacts.length;D++){var Y=O.contacts[D];if(q.length>0){var M=q.pop();M.impl=Y,L.contacts.push(M)}else{var N=new Q(L);N.impl=Y,L.contacts.push(N)}}L.impl=O.impl,L.selfCollider=R,L.otherCollider=I,R.emit(L.type,L),L.selfCollider=I,L.otherCollider=R,I.emit(L.type,L)}null==this.oldContactsDic.get(P.id,B.id)&&this.oldContactsDic.set(P.id,B.id,O)}}for(var H=this.oldContactsDic.getLength();H--;){var V=this.oldContactsDic.getKeyByIndex(H),G=this.oldContactsDic.getDataByKey(V),x=G.shape0,k=G.shape1,W=x.collider,X=k.collider;if(W&&X){var j=W.isTrigger||X.isTrigger;null==this.contactsDic.getDataByKey(V)&&(j?this.triggerArrayMat.get(x.id,k.id)&&(F.type="onTriggerExit",F.selfCollider=W,F.otherCollider=X,W.emit(F.type,F),F.selfCollider=X,F.otherCollider=W,X.emit(F.type,F),this.triggerArrayMat.set(x.id,k.id,!1),this.oldContactsDic.set(x.id,k.id,null)):this.collisionArrayMat.get(x.id,k.id)&&(q.push.apply(q,L.contacts),L.contacts.length=0,L.type="onCollisionExit",L.selfCollider=W,L.otherCollider=X,W.emit(L.type,L),L.selfCollider=X,L.otherCollider=W,X.emit(L.type,L),this.collisionArrayMat.set(x.id,k.id,!1),this.oldContactsDic.set(x.id,k.id,null)))}}this.contactsDic.reset()},i(s,[{key:"impl",get:function(){return this._btWorld}}]),s}();tt.closeHitCB=void 0,tt.allHitsCB=void 0;var it=V,et=function(){var t=s.prototype;function s(t){this.id=void 0,this.type=void 0,this._index=-1,this._isEnabled=!1,this._isBinding=!1,this._isTrigger=!1,this._btCompound=null,this.transform=void 0,this.quat=void 0,this.scale=void 0,this.type=t,this.id=s.idCounter++,this.quat=new C.btQuaternion,this.transform=new C.btTransform,this.transform.setIdentity(),this.scale=new C.btVector3(1,1,1)}return t.updateEventListener=function(){},t.setMaterial=function(t){!this._isTrigger&&this._isEnabled&&t&&(this._btCompound?this._btCompound.setMaterial(this._index,t.friction,t.restitution,t.rollingFriction,t.spinningFriction,2):(this._sharedBody.body.setFriction(t.friction),this._sharedBody.body.setRestitution(t.restitution),this._sharedBody.body.setRollingFriction(t.rollingFriction),this._sharedBody.body.setSpinningFriction(t.spinningFriction),this._sharedBody.body.setUserIndex2(2)))},t.setCenter=function(t){e.copy(it,t),it.multiply(this._collider.node.worldScale),T(this.transform.getOrigin(),it),this.updateCompoundTransform()},t.setAsTrigger=function(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},t.getAABB=function(t){var i=H.instance.TRANSFORM;i.setIdentity(),i.setRotation(A(H.instance.QUAT_0,this._collider.node.worldRotation));var s=H.instance.VECTOR3_0,o=H.instance.VECTOR3_1;this._btShape.getAabb(i,s,o),t.halfExtents.set((o.x()-s.x())/2,(o.y()-s.y())/2,(o.z()-s.z())/2),e.add(t.center,this._collider.node.worldPosition,this._collider.center)},t.getBoundingSphere=function(t){t.radius=this._btShape.getLocalBoundingSphere(),e.add(t.center,this._collider.node.worldPosition,this._collider.center)},t.initialize=function(t){this._collider=t,this._isBinding=!0,this._sharedBody=p.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),this.setWrapper()},t.setWrapper=function(){H.isNotEmptyShape(this._btShape)&&(U.setWrapper(this),this._btShape.setUserPointerAsInt(C.getPointer(this._btShape)),C.castObject(this._btShape,C.btCollisionShape).wrapped=this)},t.onComponentSet=function(){},t.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},t.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},t.onDestroy=function(){this._sharedBody.reference=!1,this._btCompound=null,this._collider=null,C.castObject(this._btShape,C.btCollisionShape).wrapped=null,C.destroy(this.quat),C.destroy(this.scale),C.destroy(this.transform),H.isNotEmptyShape(this._btShape)&&(U.delWrapper(this),C.destroy(this._btShape),O(this._btShape,C.btCollisionShape)),this._btShape=null,this.transform=null,this.quat=null,this.scale=null},t.updateByReAdd=function(){this._isEnabled&&(this._sharedBody.removeShape(this,this._isTrigger),this._sharedBody.addShape(this,this._isTrigger))},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t.setCompound=function(t){this._btCompound&&(this._btCompound.removeChildShape(this._btShape),this._index=-1),t&&(this._index=t.getNumChildShapes(),t.addChildShape(this.transform,this._btShape)),this._btCompound=t},t.updateScale=function(){this.setCenter(this._collider.center)},t.updateCompoundTransform=function(){this._btCompound?this._btCompound.updateChildTransform(this.index,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=B.BODY_RE_ADD)},t.needCompound=function(){return this.type===Y.TERRAIN_SHAPE_PROXYTYPE||!this._collider.center.equals(e.ZERO)},i(s,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"index",get:function(){return this._index}}]),s}();et.idCounter=0;var st=function(t){a(s,t);var e=s.prototype;function s(){return t.call(this,Y.BOX_SHAPE_PROXYTYPE)||this}return e.updateSize=function(){var t=H.instance.VECTOR3_0;T(t,this.getMinUnscaledHalfExtents(u)),this.impl.setUnscaledHalfExtents(t),this.updateCompoundTransform()},e.onComponentSet=function(){var t=H.instance.VECTOR3_0;T(t,this.getMinUnscaledHalfExtents(u)),this._btShape=new C.btBoxShape(t),this.updateScale()},e.updateScale=function(){t.prototype.updateScale.call(this),T(this.scale,this.getMinScale(u)),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},e.getMinUnscaledHalfExtents=function(t){var i=this.collider.size,e=_(u.set(this._collider.node.worldScale)),s=p.instance.minVolumeSize,o=i.x/2,n=i.y/2,r=i.z/2,a=o*e.x<s?s/e.x:o,l=n*e.y<s?s/e.y:n,h=r*e.z<s?s/e.z:r;return t.set(a,l,h),t},e.getMinScale=function(t){var i=this.collider.size,e=_(u.set(this._collider.node.worldScale)),s=p.instance.minVolumeSize,o=i.x/2,n=i.y/2,r=i.z/2,a=o*e.x<s?s/o:e.x,l=n*e.y<s?s/n:e.y,h=r*e.z<s?s/r:e.z;return t.set(a,l,h),t},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),ot=function(t){a(s,t);var e=s.prototype;function s(){return t.call(this,Y.SPHERE_SHAPE_PROXYTYPE)||this}return e.updateRadius=function(){this.impl.setUnscaledRadius(this.getMinUnscaledRadius()),this.updateCompoundTransform()},e.onComponentSet=function(){var t=Math.abs(l(this._collider.node.worldScale)),i=this.collider.radius,e=p.instance.minVolumeSize,s=t*i<e?e/t:i;this._btShape=new C.btSphereShape(s),this.updateScale()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=this.getMinScale();u.set(i,i,i),T(this.scale,u),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},e.getMinUnscaledRadius=function(){var t=this.collider.radius,i=Math.abs(l(this._collider.node.worldScale)),e=p.instance.minVolumeSize;return i*t<e?e/i:t},e.getMinScale=function(){var t=this.collider.radius,i=Math.abs(l(this._collider.node.worldScale)),e=p.instance.minVolumeSize;return i*t<e?e/t:i},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),nt=function(t){a(s,t);var e=s.prototype;function s(){return t.call(this,Y.CAPSULE_SHAPE_PROXYTYPE)||this}return e.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){this._btShape=new C.btCapsuleShape(.5,1),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var o=s,n=e;if(1===n){var r=t*Math.abs(h(o.x,o.z)),a=i/2*Math.abs(o.y);this.impl.updateProp(r,a,n)}else if(0===n){var l=t*Math.abs(h(o.y,o.z)),d=i/2*Math.abs(o.x);this.impl.updateProp(l,d,n)}else{var c=t*Math.abs(h(o.x,o.y)),p=i/2*Math.abs(o.z);this.impl.updateProp(c,p,n)}this.updateCompoundTransform()},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),rt=function(t){a(s,t);var e=s.prototype;function s(){var i;return(i=t.call(this,Y.TRIANGLE_MESH_SHAPE_PROXYTYPE)||this).refBtTriangleMesh=null,i}return e.setMesh=function(t){if(this._isBinding)if(null!=this._btShape&&H.isNotEmptyShape(this._btShape))d(9620);else{var i=t;if(i&&i.renderingSubMeshes.length>0){var e=this._getBtTriangleMesh(i);this.collider.convex?this._btShape=new C.btConvexTriangleMeshShape(e,!0):this._btShape=new C.btBvhTriangleMeshShape(e,!0,!0),T(this.scale,this._collider.node.worldScale),this._btShape.setMargin(.01),this._btShape.setLocalScaling(this.scale),this.setWrapper(),this.setCompound(this._btCompound),this.updateByReAdd()}else this._btShape=H.instance.EMPTY_SHAPE}},e.onComponentSet=function(){this.setMesh(this.collider.mesh)},e.onDestroy=function(){this.refBtTriangleMesh&&C.destroy(this.refBtTriangleMesh),t.prototype.onDestroy.call(this)},e.setCompound=function(i){t.prototype.setCompound.call(this,i),this.impl.setUserIndex(this._index)},e.updateScale=function(){t.prototype.updateScale.call(this),T(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},e._getBtTriangleMesh=function(t){var i,e=C.CC_CACHE;if(e.btTriangleMesh.enable){if(null==e.btTriangleMesh[t._uuid]){var s=new C.btTriangleMesh;e.btTriangleMesh[t._uuid]=s,P(s,t)}i=e.btTriangleMesh[t._uuid]}else this.refBtTriangleMesh=i=new C.btTriangleMesh,P(i,t);return i},i(s,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),s}(et),at=function(t){a(s,t);var e=s.prototype;function s(){return t.call(this,Y.CYLINDER_SHAPE_PROXYTYPE)||this}return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){var t=H.instance.VECTOR3_0;t.setValue(.5,1,.5),this._btShape=new C.btCylinderShape(t),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var o=s,n=e;if(1===n){var r=i*Math.abs(o.y),a=t*Math.abs(h(o.x,o.z)),l=r/2;this.impl.updateProp(a,l,n)}else if(0===n){var d=i*Math.abs(o.x),c=t*Math.abs(h(o.y,o.z)),p=d/2;this.impl.updateProp(c,p,n)}else{var u=i*Math.abs(o.z),_=t*Math.abs(h(o.x,o.y)),S=u/2;this.impl.updateProp(_,S,n)}this.updateCompoundTransform()},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),lt=function(t){a(s,t);var e=s.prototype;function s(){return t.call(this,Y.CONE_SHAPE_PROXYTYPE)||this}return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){this._btShape=new C.btConeShape(.5,1),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var o=s,n=e;if(1===n){var r=i*Math.abs(o.y),a=t*Math.abs(h(o.x,o.z));this.impl.setRadius(a),this.impl.setHeight(r)}else if(0===n){var l=i*Math.abs(o.x),d=t*Math.abs(h(o.y,o.z));this.impl.setRadius(d),this.impl.setHeight(l)}else{var c=i*Math.abs(o.z),p=t*Math.abs(h(o.x,o.y));this.impl.setRadius(p),this.impl.setHeight(c)}this.impl.setConeUpIndex(n),this.scale.setValue(1,1,1),this.impl.setLocalScaling(this.scale),this.updateCompoundTransform()},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),ht=function(t){a(o,t);var s=o.prototype;function o(){var i;return(i=t.call(this,Y.TERRAIN_SHAPE_PROXYTYPE)||this)._buffPtr=void 0,i._tileSize=void 0,i._localOffset=void 0,i._buffPtr=0,i._tileSize=0,i._localOffset=new e,i}return s.setTerrain=function(t){if(this._isBinding)if(null!=this._btShape&&H.isNotEmptyShape(this._btShape))c("[Physics] Ammo change the terrain asset after initialization is not support.");else{var i=t;if(i){this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._buffPtr=C._malloc(4*e*s);for(var o=0,n=Number.MIN_VALUE,r=Number.MAX_VALUE,a=0;a<s;a++)for(var l=0;l<e;l++){var h=i.getHeight(l,a);C.HEAPF32[this._buffPtr+o>>2]=h,n=n<h?h:n,r=r>h?h:r,o+=4}n+=.1,r-=.1,this._localOffset.set((e-1)/2*this._tileSize,(n+r)/2,(s-1)/2*this._tileSize),this._btShape=new C.btHeightfieldTerrainShape(e,s,this._buffPtr,1,r,n,1,"PHY_FLOAT",!1),this.scale.setValue(this._tileSize,1,this._tileSize),this._btShape.setLocalScaling(this.scale),this.setCompound(this._btCompound),this.updateByReAdd()}else this._btShape=H.instance.EMPTY_SHAPE}},s.onComponentSet=function(){this.setTerrain(this.collider.terrain)},s.onDestroy=function(){this._buffPtr&&C._free(this._buffPtr),t.prototype.onDestroy.call(this)},s.setCompound=function(i){t.prototype.setCompound.call(this,i),this.impl.setUserIndex(this._index)},s.setCenter=function(t){e.copy(V,t),V.add(this._localOffset),T(this.transform.getOrigin(),V),this.updateCompoundTransform()},i(o,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),o}(et),dt=function(t){a(s,t);var e=s.prototype;function s(){var i;return(i=t.call(this,Y.TETRAHEDRAL_SHAPE_PROXYTYPE)||this).VERTICES=[],i}return e.setShapeType=function(){this._isBinding},e.setVertices=function(t){for(var i=this.VERTICES.length,e=0;e<i;e++)T(this.VERTICES[e],t[e]);T(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)},e.onComponentSet=function(){this._btShape=new C.btBU_Simplex1to4;for(var t=this.collider.shapeType,i=this.collider.vertices,e=0;e<t;e++)this.VERTICES[e]=new C.btVector3,T(this.VERTICES[e],i[e]),this.impl.addVertex(this.VERTICES[e]);T(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale)},e.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},e.onDestroy=function(){for(var i=this.VERTICES.length,e=0;e<i;e++)C.destroy(this.VERTICES[e]);this.VERTICES=null,t.prototype.onDestroy.call(this)},e.updateScale=function(){t.prototype.updateScale.call(this),T(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),ct=function(t){a(s,t);var e=s.prototype;function s(){return t.call(this,Y.STATIC_PLANE_PROXYTYPE)||this}return e.setNormal=function(t){T(this.impl.getPlaneNormal(),t),this.updateCompoundTransform()},e.setConstant=function(t){this.impl.setPlaneConstant(t),this.updateCompoundTransform()},e.updateScale=function(){t.prototype.updateScale.call(this),T(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},e.onComponentSet=function(){var t=H.instance.VECTOR3_0;T(t,this.collider.normal),this._btShape=new C.btStaticPlaneShape(t,this.collider.constant),this.updateScale()},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s}(et),pt=function(){function t(){this.dirty=0,this.index=-1,this._collided=!1}var e=t.prototype;return e.setConnectedBody=function(){},e.setEnableCollision=function(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())},e.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._collided=t.enableCollision,this.onComponentSet()},e.onComponentSet=function(){},e.updateScale0=function(){},e.updateScale1=function(){},e.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var i=this.constraint.connectedBody;i&&i.body.sharedBody.addJoint(this,1)},e.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var i=this.constraint.connectedBody;i&&i.body.sharedBody.removeJoint(this,1)},e.onDestroy=function(){C.destroy(this._impl),this._com=null,this._rigidBody=null,this._impl=null},i(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),ut=function(t){function s(){return t.apply(this,arguments)||this}a(s,t);var o=s.prototype;return o.setPivotA=function(){var t=H.instance.VECTOR3_0,i=this.constraint;e.multiply(V,i.node.worldScale,i.pivotA),T(t,V),this.impl.setPivotA(t),i.connectedBody||this.setPivotB(i.pivotB)},o.setPivotB=function(){var t=this.constraint,i=this._rigidBody.node,s=H.instance.VECTOR3_0,o=t.connectedBody;o?(e.multiply(V,o.node.worldScale,t.pivotB),T(s,V)):(e.multiply(V,i.worldScale,t.pivotA),e.add(V,V,i.worldPosition),e.add(V,V,t.pivotB),T(s,V)),this.impl.setPivotB(s)},o.onComponentSet=function(){var t,i=this._rigidBody.body.impl,e=this.constraint.connectedBody;e&&(t=e.body.impl);var s=H.instance.VECTOR3_0;if(t){var o=H.instance.VECTOR3_1;this._impl=new C.btPoint2PointConstraint(i,t,s,o)}else this._impl=new C.btPoint2PointConstraint(i,s);this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},o.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},o.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},i(s,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),s}(pt),_t=function(t){function o(){return t.apply(this,arguments)||this}a(o,t);var n=o.prototype;return n.setPivotA=function(){this.updateFrames()},n.setPivotB=function(){this.updateFrames()},n.setAxis=function(){this.updateFrames()},n.onComponentSet=function(){var t=this._rigidBody.body.sharedBody,i=this.constraint.connectedBody,e=i?i.body.impl:t.wrappedWorld.impl.getFixedBody(),s=H.instance.TRANSFORM,o=H.instance.TRANSFORM_1;this._impl=new C.btHingeConstraint(t.body,e,s,o),this.updateFrames()},n.updateFrames=function(){var t=this.constraint,i=t.node,o=V,n=x,r=H.instance.TRANSFORM;e.multiply(o,i.worldScale,t.pivotA),T(r.getOrigin(),o);var a=H.instance.QUAT_0;s.rotationTo(n,e.UNIT_Z,t.axis),r.setRotation(A(a,n));var l=H.instance.TRANSFORM_1,h=this.constraint.connectedBody;h?e.multiply(o,h.node.worldScale,t.pivotB):(e.multiply(o,i.worldScale,t.pivotA),e.add(o,o,i.worldPosition),e.add(o,o,t.pivotB),s.multiply(n,n,i.worldRotation)),T(l.getOrigin(),o),l.setRotation(A(a,n)),this.impl.setFrames(r,l)},n.updateScale0=function(){this.updateFrames()},n.updateScale1=function(){this.updateFrames()},i(o,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),o}(pt);S.register("ammo.js",{PhysicsWorld:tt,RigidBody:X,BoxShape:st,SphereShape:ot,CapsuleShape:nt,TrimeshShape:rt,CylinderShape:at,ConeShape:lt,TerrainShape:ht,SimplexShape:dt,PlaneShape:ct,PointToPointConstraint:ut,HingeConstraint:_t}),window.Ammo=C,C.CC_CONFIG={ignoreSelfBody:!0},C.CC_CACHE={btTriangleMesh:{enable:!1}}}}}));
