System.register(["./json-asset-1a4fee7d.js"],(function(e){"use strict";var t,i,n,r,s,a,o,h,u,c,_,l,d,f,p,g,v,m,S,E,T,w,y,O,I,A,b,F,R,D,N,P,L,B,C,M,x,U,H,G,z,k,V,W,K,Y,Q,q,X,j,Z,J,$,ee,te,ie,ne,re,se,ae,oe,he,ue,ce,_e,le,de,fe,pe,ge,ve,me,Se,Ee,Te,we,ye,Oe,Ie,Ae,be,Fe,Re,De,Ne,Pe,Le,Be,Ce,Me,xe,Ue,He,Ge,ze,ke,Ve,We,Ke,Ye,Qe,qe,Xe,je,Ze,Je,$e,et,tt,it,nt,rt,st,at,ot,ht,ut,ct,_t,lt,dt,ft,pt,gt,vt,mt,St,Et,Tt,wt,yt,Ot,It,At,bt,Ft,Rt,Dt,Nt,Pt,Lt;return{setters:[function(e){t=e.c5,i=e.cc,n=e.ac,r=e.d$,s=e.v,a=e.l,o=e.e0,h=e.e1,u=e.cq,c=e.e2,_=e.cr,l=e.ao,d=e.ch,f=e.e3,p=e.bN,g=e.e4,v=e.dF,m=e.av,S=e.H,E=e.I,T=e.x,w=e.J,y=e.e5,O=e.L,I=e.N,A=e.bT,b=e.bU,F=e.e6,R=e.aU,D=e.f,N=e.e7,P=e.aq,L=e.z,B=e.G,C=e.aH,M=e.aJ,x=e.P,U=e.dJ,H=e.e8,G=e.e9,z=e.c7,k=e.dQ,V=e.F,W=e.b4,K=e.bd,Y=e.ea,Q=e.t,q=e.eb,X=e.cS,j=e.cR,Z=e.bO,J=e.bA,$=e.ec,ee=e.bw,te=e.bM,ie=e.ed,ne=e.dr,re=e.ee,se=e.c9,ae=e.ef,oe=e.eg,he=e.eh,ue=e.ei,ce=e.ej,_e=e.ek,le=e.el,de=e.c3,fe=e.em,pe=e.en,ge=e.by,ve=e.eo,me=e.ep,Se=e.eq,Ee=e.cj,Te=e.er,we=e.es,ye=e.aT,Oe=e.et,Ie=e.df,Ae=e.ag,be=e.aW,Fe=e.bn,Re=e.cK,De=e.$,Ne=e.Z,Pe=e.a0,Le=e.ds,Be=e.d7,Ce=e.eu,Me=e.R,xe=e.C,Ue=e.ev,He=e.ew,Ge=e.ex,ze=e.ar,ke=e.ey,Ve=e.cz,We=e.ez,Ke=e.aK,Ye=e.aL,Qe=e.aO,qe=e.aR,Xe=e.eA,je=e.eB,Ze=e.eC,Je=e.eD,$e=e.eE,et=e.eF,tt=e.eG,it=e.eH,nt=e.eI,rt=e.eJ,st=e.eK,at=e.dd,ot=e.eL,ht=e.dD,ut=e.eM,ct=e.dc,_t=e.eN,lt=e.c,dt=e.dC,ft=e.eO,pt=e.eP,gt=e.eQ,vt=e.d,mt=e.a,St=e.c1,Et=e.eR,Tt=e.dy,wt=e.dA,yt=e.eS,Ot=e.dB,It=e.dz,At=e.b2,bt=e.eT,Ft=e.eU,Rt=e.e,Dt=e.w,Nt=e.eV,Pt=e.cf,Lt=e.eW}],execute:function(){var Bt,Ct,Mt,xt,Ut;e({C:void 0,K:void 0,L:void 0,M:void 0,a:void 0,b:void 0,c:void 0,d:void 0,g:ai}),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Bt||(Bt=e("C",{}))),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Ct||(Ct=e("a",{}))),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Mt||(Mt=e("b",{}))),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(xt||(xt=e("c",{}))),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Ut||(Ut=e("d",{})));var Ht=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Gt=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],zt=[100,200,400,800],kt=new t,Vt=new t,Wt=new i,Kt=e("S",n.STENCIL<<1),Yt=[],Qt=e("e",function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Bt.VERTICAL,this._fov=_(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new l(.2,.2,.2,1),this._viewport=new d(0,0,1,1),this._curTransform=s.IDENTITY,this._isProjDirty=!0,this._matView=new i,this._matViewInv=null,this._matProj=new i,this._matProjInv=new i,this._matViewProj=new i,this._matViewProjInv=new i,this._frustum=new f,this._forward=new t,this._position=new t,this._priority=0,this._aperture=Mt.F16_0,this._apertureValue=void 0,this._shutter=Ut.D125,this._shutterValue=0,this._iso=xt.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=n.NONE,this._clearDepth=1,this._visibility=r,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=Ht[this._aperture],this._shutterValue=Gt[this._shutter],this._isoValue=zt[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Yt.length){var a=e.capabilities.clipSpaceSignY;Yt[s.IDENTITY]=new i(1,0,0,0,0,a),Yt[s.ROTATE_90]=new i(0,1,0,0,-a,0),Yt[s.ROTATE_180]=new i(-1,0,0,0,0,-a),Yt[s.ROTATE_270]=new i(0,-1,0,0,a,0)}}var p=e.prototype;return p._setWidth=function(e){this._width=e},p._setHeight=function(e){this._height=e},p._setScene=function(e){this._scene=e},p._init=function(){},p.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=n.NONE,this.clearDepth=1,this.visibility=r,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},p._destroy=function(){},p.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},p.attachToScene=function(e){this._enabled=!0,this._setScene(e)},p.detachFromScene=function(){this._enabled=!1,this._setScene(null)},p.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0)},p.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1},p.update=function(e){if(void 0===e&&(e=!1),this._node){var t=!1;(this._node.hasChangedFlags||e)&&(i.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),t=!0);var n=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==n){var r;this._curTransform=n;var a=this._device.capabilities.clipSpaceSignY;if((null===(r=this.window)||void 0===r?void 0:r.hasOffScreenAttachments)&&(n=s.IDENTITY),this._proj===Ct.PERSPECTIVE)i.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Bt.VERTICAL,this._device.capabilities.clipSpaceMinZ,a,n);else{var o=this._orthoHeight*this._aspect,h=this._orthoHeight;i.ortho(this._matProj,-o,o,-h,h,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,a,n)}i.invert(this._matProjInv,this._matProj),t=!0,this._isProjDirty=!1}t&&(i.multiply(this._matViewProj,this._matProj,this._matView),i.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},p.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||a.director.root.mainWindow;t&&(t.attachCamera(this),this.window=t,this.resize(t.width,t.height))},p.detachCamera=function(){this._window&&this._window.detachCamera(this)},p.screenPointToRay=function(e,i,n){if(!this._node)return null;var r=this.width,s=this.height,a=this._viewport.x*r,u=this._viewport.y*s,c=this._viewport.width*r,_=this._viewport.height*s,l=this._proj===Ct.PERSPECTIVE,d=this._device.capabilities.clipSpaceSignY,f=o[this._curTransform];t.set(kt,(i-a)/c*2-1,(n-u)/_*2-1,l?1:-1);var p=kt.x,g=kt.y;return kt.x=p*f[0]+g*f[2]*d,kt.y=p*f[1]+g*f[3]*d,t.transformMat4(l?kt:e.o,kt,this._matViewProjInv),l?(this._node.getWorldPosition(Vt),h.fromPoints(e,Vt,kt)):t.transformQuat(e.d,t.FORWARD,this._node.worldRotation),e},p.screenToWorld=function(e,i){var n=this.width,r=this.height,s=this._viewport.x*n,a=this._viewport.y*r,h=this._viewport.width*n,c=this._viewport.height*r,_=this._device.capabilities.clipSpaceSignY,l=o[this._curTransform];if(this._proj===Ct.PERSPECTIVE){t.set(e,(i.x-s)/h*2-1,(i.y-a)/c*2-1,1);var d=e.x,f=e.y;e.x=d*l[0]+f*l[2]*_,e.y=d*l[1]+f*l[3]*_,t.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(kt),t.lerp(e,kt,e,u(this._nearClip/this._farClip,1,i.z))}else{t.set(e,(i.x-s)/h*2-1,(i.y-a)/c*2-1,2*i.z-1);var p=e.x,g=e.y;e.x=p*l[0]+g*l[2]*_,e.y=p*l[1]+g*l[3]*_,t.transformMat4(e,e,this._matViewProjInv)}return e},p.worldToScreen=function(e,i){var n=this.width,r=this.height,s=this._viewport.x*n,a=this._viewport.y*r,h=this._viewport.width*n,u=this._viewport.height*r,c=this._device.capabilities.clipSpaceSignY,_=o[this._curTransform];t.transformMat4(e,i,this._matViewProj);var l=e.x,d=e.y;return e.x=l*_[0]+d*_[2]*c,e.y=l*_[1]+d*_[3]*c,e.x=s+.5*(e.x+1)*h,e.y=a+.5*(e.y+1)*u,e.z=.5*e.z+.5,e},p.worldMatrixToScreen=function(e,n,r,s){i.multiply(e,this._matViewProj,n),i.multiply(e,Yt[this._curTransform],e);var a=r/2,o=s/2;return i.identity(Wt),i.transform(Wt,Wt,t.set(kt,a,o,0)),i.scale(Wt,Wt,t.set(kt,a,o,1)),i.multiply(e,Wt,e),e},p.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},p.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},c(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=e.x,i=e.width,n=e.height,r=this._device.capabilities.screenSpaceSignY<0?1-e.y-n:e.y;switch(this._device.surfaceTransform){case s.ROTATE_90:this._viewport.x=1-r-n,this._viewport.y=t,this._viewport.width=n,this._viewport.height=i;break;case s.ROTATE_180:this._viewport.x=1-t-i,this._viewport.y=1-r-n,this._viewport.width=i,this._viewport.height=n;break;case s.ROTATE_270:this._viewport.x=r,this._viewport.y=1-t-i,this._viewport.width=n,this._viewport.height=i;break;case s.IDENTITY:this._viewport.x=t,this._viewport.y=r,this._viewport.width=i,this._viewport.height=n}this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView},set:function(e){this._matView=e}},{key:"matViewInv",get:function(){return this._matViewInv||this._node.worldMatrix},set:function(e){this._matViewInv=e}},{key:"matProj",get:function(){return this._matProj},set:function(e){this._matProj=e}},{key:"matProjInv",get:function(){return this._matProjInv},set:function(e){this._matProjInv=e}},{key:"matViewProj",get:function(){return this._matViewProj},set:function(e){this._matViewProj=e}},{key:"matViewProjInv",get:function(){return this._matViewProjInv},set:function(e){this._matViewProjInv=e}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=Ht[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=Gt[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=zt[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}]),e}()),qt=new R(null),Xt=e("m",function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=g.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,i){if(void 0===i&&(i=null),this._device=a.director.root.device,qt.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(qt),this._setSubMesh(e),this._patches=i,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===p.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=g.DEFAULT,t[0].phase===v("reflection")){var n=this._device.width,r=this._device.height,s=512;r<n?(n=s*n/r,r=s):r=s*r/(n=s),this._reflectionTex=this._device.createTexture(new m(S.TEX2D,E.STORAGE|E.TRANSFER_SRC|E.SAMPLED,T.RGBA8,n,r,w.IMMUTABLE)),this.descriptorSet.bindTexture(y,this._reflectionTex);var o=[O.LINEAR,O.LINEAR,O.NONE,I.CLAMP,I.CLAMP,I.CLAMP],h=A(o);this._reflectionSampler=b.getSampler(this._device,h),this.descriptorSet.bindSampler(y,this._reflectionSampler),this.descriptorSet.bindTexture(F,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=a.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=a.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyInputAssembler(),this.priority=g.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler&&this._reflectionSampler.destroy(),this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var n=t[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},c(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?D(12004,8):(this._passes=e,this._flushPassInfo(),this._descriptorSet&&(this._destroyDescriptorSet(),qt.layout=e[0].localSetLayout,this._createDescriptorSet(qt)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._setSubMesh(e),this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===p.VB_MERGING&&this.subMesh.genFlatBuffers()}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}()),jt=e("X",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,i,n){void 0===n&&(n=null);var r=t.buffer.length;if(r){var s=e.inputAssembler,a=e.descriptorSet.getTexture(N),o=n;o||(o=e.shaders[i]);for(var h=e.descriptorSet,u=0;u<this.instances.length;++u){var c=this.instances[u];if(!(c.ia.indexBuffer!==s.indexBuffer||c.count>=1024)&&c.lightingMap===a){if(c.stride!==r)return;if(c.count>=c.capacity){c.capacity<<=1;var _=c.stride*c.capacity,l=c.data;c.data=new Uint8Array(_),c.data.set(l),c.vb.resize(_)}return c.shader!==o&&(c.shader=o),c.descriptorSet!==h&&(c.descriptorSet=h),c.data.set(t.buffer,c.stride*c.count++),void(this.hasPendingModels=!0)}}for(var d=this._device.createBuffer(new P(L.VERTEX|L.TRANSFER_DST,B.HOST|B.DEVICE,32*r,r)),f=new Uint8Array(32*r),p=s.vertexBuffers.slice(),g=s.attributes.slice(),v=s.indexBuffer,m=0;m<t.attributes.length;m++){var S=t.attributes[m],E=new C(S.name,S.format,S.isNormalized,p.length,!0);g.push(E)}f.set(t.buffer),p.push(d);var T=new M(g,p,v),w=this._device.createInputAssembler(T);this.instances.push({count:1,capacity:32,vb:d,data:f,ia:w,stride:r,shader:o,descriptorSet:h,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}());jt._buffers=new Map;var Zt,Jt=new i,$t=(new x((function(){return new Xt}),32),[{name:"CC_RECEIVE_SHADOW",value:!0}]);!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Zt||(Zt=e("M",{})));var ei=A([O.LINEAR,O.LINEAR,O.NONE,I.CLAMP,I.CLAMP,I.CLAMP]),ti=A([O.LINEAR,O.LINEAR,O.LINEAR,I.CLAMP,I.CLAMP,I.CLAMP]),ii=(e("i",function(){function e(){this.type=Zt.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(H.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new z,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=U.Enum.NONE,this._device=a.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=U.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var i=this._subModels[t];this._destroySubmodel(i)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._transformUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var r,s,a,o,h=this.transform._mat,u=this._instMatWorldIdx;if(u>=0){var c=this.instancedAttributes.views;r=h,s=c[u],a=c[u+1],o=c[u+2],s[0]=r.m00,s[1]=r.m01,s[2]=r.m02,s[3]=r.m12,a[0]=r.m04,a[1]=r.m05,a[2]=r.m06,a[3]=r.m13,o[0]=r.m08,o[1]=r.m09,o[2]=r.m10,o[3]=r.m14}else if(this._localBuffer){i.toArray(this._localData,h,H.MAT_WORLD_OFFSET),i.inverseTranspose(Jt,h);var _=Math.abs(i.determinant(Jt)),l=1/Math.sqrt(_);i.multiplyScalar(Jt,Jt,l),i.toArray(this._localData,Jt,H.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=G.fromPoints(G.create(),e,t),this._worldBounds=G.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new Xt},t.initSubModel=function(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){z.toArray(this._localData,t,H.LIGHTINGMAP_UVPARAM),this._applyLocalData(),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=k.get("empty-texture"));var i=e.getGFXTexture();if(i)for(var n=b.getSampler(this._device,e.mipmaps.length>1?ti:ei),r=this._subModels,s=0;s<r.length;s++){var a=r[s].descriptorSet;a.bindTexture(N,i),a.bindSampler(N,n),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?$t:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var i=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(i.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(V.INSTANCED_ARRAYS)){for(var i=0,n=0;n<e.length;n++){var r=e[n];r.isInstanced&&(i+=W[r.format].size)}var s=this.instancedAttributes;s.buffer=new Uint8Array(i),s.views.length=s.attributes.length=0;for(var a=0,o=0;o<e.length;o++){var h=e[o];if(h.isInstanced){var u=new C;u.format=h.format,u.name=h.name,u.isNormalized=h.isNormalized,u.location=h.location,s.attributes.push(u);var c=W[h.format],_=new(K(c))(s.buffer.buffer,a,c.count);s.views.push(_),a+=c.size}}t.batchingScheme===p.INSTANCING&&jt.get(t).destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(Y)),this._transformUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,H.SIZE,H.SIZE)),this._applyLocalBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(H.BINDING,this._localBuffer)},c(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}()),e("R",function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._createNativeObject(),!0},t.update=function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var r=this._spotLights,s=0;s<r.length;s++)r[s].update();for(var a=this._models,o=0;o<a.length;o++){var h=a[o];h.enabled&&(h.updateTransform(e),h.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=Q(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=q.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=Q(this._models);!(e=t()).done;){var i=e.value;i.detachFromScene(),i.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=Q(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},c(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}()));X(ii.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),X(ii.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var ni=e("f",{});X(ni,"CameraVisFlags",[{name:"GENERAL"}]),j(ni,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:U.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:U.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:U.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:U.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:U.BitMask,targetName:"UI_2D"}]),a.CameraVisFlags=ni;var ri,si=e("V",{});function ai(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),s=2*n-8*r+4,a=3*n/s,o=2*r/s,h=1/o*a,u=1/o*(1-a-o);e.x=3.2404542*h-1.5371385+-.4985314*u,e.y=-.969266*h+1.8760108+.041556*u,e.z=.0556434*h-.2040259+1.0572252*u}X(si,"VisibilityFlags",[{name:"GENERAL"}]),j(si,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:U.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:U.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:U.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:U.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:U.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:U.Enum,targetName:"UI_2D"}]),a.VisibilityFlags=si,j(Z.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),X(Qt.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]),X(J.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(ri||(ri=e("L",{})));var oi=e("n",(function(e){return 4*Math.PI*Math.PI*e*e})),hi=e("h",function(){function e(){this._baked=!1,this._color=new t(1,1,1),this._colorTemp=6550,this._colorTempRGB=new t(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=ri.UNKNOWN}var i=e.prototype;return i._init=function(){},i._destroy=function(){},i.initialize=function(){this._init(),this.color=new t(1,1,1),this.colorTemperature=6550},i.attachToScene=function(e){this._scene=e},i.detachFromScene=function(){this._scene=null},i.destroy=function(){this._name=null,this._node=null,this._destroy()},i.update=function(){},c(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,ai(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=q.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}()),ui=new t(0,0,-1),ci=new t,_i=(e("D",function(e){function i(){var i;return(i=e.call(this)||this)._dir=new t(1,-1,-1),i._illuminance=ee.SUN_ILLUM,i._type=ri.DIRECTIONAL,i}$(i,e);var n=i.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=ee.SUN_ILLUM,this.direction=new t(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=t.transformQuat(ci,ui,this._node.worldRotation))},c(i,[{key:"direction",get:function(){return this._dir},set:function(e){t.normalize(this._dir,e)}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e}}]),i}(hi)),e("P",function(e){function t(t,i){var n;(n=e.call(this,t.root)||this)._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=t,n._owner=i,n._doInit(n._parent,!0);for(var r=0;r<n._shaderInfo.blocks.length;r++){var s=n._shaderInfo.blocks[r],a=n._blocks[s.binding],o=n._parent.blocks[s.binding];a.set(o)}n._setRootBufferDirty(!0);for(var h=n._parent,u=0;u<n._shaderInfo.samplerTextures.length;u++)for(var c=n._shaderInfo.samplerTextures[u],_=0;_<c.count;_++){var l=h._descriptorSet.getSampler(c.binding,_),d=h._descriptorSet.getTexture(c.binding,_);n._descriptorSet.bindSampler(c.binding,l,_),n._descriptorSet.bindTexture(c.binding,d,_)}return e.prototype.tryCompile.call(ie(n)),n}$(t,e);var i=t.prototype;return i.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Z.fillPipelineInfo(this,e),Z.fillPipelineInfo(this,t),this._onStateChange()},i.tryCompile=function(t){if(t&&!te(this._defines,t))return!1;var i=e.prototype.tryCompile.call(this);return this._onStateChange(),i},i.beginChangeStatesSilently=function(){this._dontNotify=!0},i.endChangeStatesSilently=function(){this._dontNotify=!1},i._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(p.NONE)},i._onStateChange=function(){this._setHash(Z.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},c(t,[{key:"parent",get:function(){return this._parent}}]),t}(Z))),li=e("o",function(e){function t(t){var i;return(i=e.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=t.parent,i._owner=t.owner||null,i._subModelIdx=t.subModelIdx||0,i.copy(i._parent),i}$(t,e);var i=t.prototype;return i.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=Q(this._passes);!(i=n()).done;)i.value.tryCompile(e);else this._passes[t].tryCompile(e)},i.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],s=this._states[n]||(this._states[n]={});for(var a in e)s[a]=e[a];r.overridePipelineStates(i[r.passIndex],s)}else{var o=this._states[t]||(this._states[t]={});for(var h in e)o[h]=e[h];this._passes[t].overridePipelineStates(i[t],o)}}},i.destroy=function(){return this._doDestroy(),!0},i.onPassStateChange=function(e){this._hash=ne.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},i._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new _i(t[i],this));return e},c(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(ne)),di=null,fi=null,pi=e("j",function(){function e(){this._envmap=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._isRGBE=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setIsRGBE=function(e){this._isRGBE=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setIsRGBE(e.isRGBE),this._envmap=e.envmap},t.activate=function(){var e=a.director.root.pipeline,t=e.pipelineSceneData.ambient;if(this._globalDSManager=e.globalDSManager,this._default=k.get("default-cube-texture"),this._model||(this._model=a.director.root.createModel(a.renderer.scene.Model),this._model._initLocalDescriptors=function(){}),this._envmap||(this._envmap=this._default),t.albedoArray[3]=this._envmap.mipmapLevel,fi)fi.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var i=new ne;i.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),fi=new li({parent:i})}this.enabled&&(di||(di=a.utils.createMesh(a.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,di.renderingSubMeshes[0],fi)),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=this.useIBL?this.isRGBE?2:1:0,t=a.director.root,i=t.pipeline;i.macros.CC_USE_IBL!==e&&(i.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){var e=this.envmap.getGFXTexture(),t=b.getSampler(a.director._device,this.envmap.getSamplerHash());this._globalDSManager.bindSampler(re,t),this._globalDSManager.bindTexture(re,e),this._globalDSManager.update()},t._destroy=function(){},t.destroy=function(){this._destroy()},c(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"isRGBE",get:function(){return this._isRGBE},set:function(e){e&&(fi&&fi.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,fi)),this._setIsRGBE(e),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(a.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"native",get:function(){return this._nativeObj}}]),e}());a.Skybox=pi,e("k",function(e){$(n,e);var i=n.prototype;function n(){var i;return(i=e.call(this)||this)._needUpdate=!1,i._size=.15,i._range=1,i._luminance=0,i._pos=void 0,i._aabb=void 0,i._aabb=G.create(),i._pos=new t,i._type=ri.SPHERE,i}return i._init=function(){e.prototype._init.call(this)},i._destroy=function(){e.prototype._destroy.call(this)},i.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/oi(.15)},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;G.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},c(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(hi));var gi,vi,mi,Si,Ei,Ti,wi,yi,Oi,Ii,Ai,bi,Fi,Ri,Di,Ni,Pi,Li,Bi,Ci,Mi,xi,Ui,Hi=new t(0,0,-1),Gi=new se,zi=new i,ki=new i,Vi=new i,Wi=new i,Ki=(e("l",function(e){$(r,e);var n=r.prototype;function r(){var i;return(i=e.call(this)||this)._dir=new t(1,-1,-1),i._range=5,i._spotAngle=Math.cos(Math.PI/6),i._pos=void 0,i._aabb=void 0,i._frustum=void 0,i._angle=0,i._needUpdate=!1,i._size=.15,i._luminance=0,i._aspect=0,i._aabb=G.create(),i._frustum=f.create(),i._pos=new t,i._type=ri.SPOT,i}return n._init=function(){e.prototype._init.call(this)},n._destroy=function(){e.prototype._destroy.call(this)},n._setDirection=function(e){this._dir.set(e)},n.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/oi(.15),this.range=Math.cos(Math.PI/6),this._setDirection(new t(1,-1,-1))},n.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),t.transformQuat(this._dir,Hi,this._node.getWorldRotation(Gi)),t.normalize(this._dir,this._dir),G.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(zi),i.invert(zi,zi),i.perspective(ki,this._angle,1,.001,this._range),i.multiply(Vi,ki,zi),this._frustum.update(Vi,Wi),this._needUpdate=!1)},c(r,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),r}(hi)),e("z",(gi=ae("RenderStage"),vi=ce(),mi=ce(),Si=ce(),gi((Ii=function(){function e(){he(this,"_name",wi,this),he(this,"_priority",yi,this),he(this,"_tag",Oi,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},c(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}(),wi=oe((Ti=Ii).prototype,"_name",[vi,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yi=oe(Ti.prototype,"_priority",[mi,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oi=oe(Ti.prototype,"_tag",[Si,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ei=Ti))||Ei)));a.RenderStage=Ki;var Yi=e("y",(Ai=ae("RenderFlow"),bi=ce(),Fi=ce(),Ri=ce(),Di=ce(),Ni=_e([Ki]),Ai((Ui=function(){function e(){he(this,"_name",Bi,this),he(this,"_priority",Ci,this),he(this,"_tag",Mi,this),he(this,"_stages",xi,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},c(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Bi=oe((Li=Ui).prototype,"_name",[bi,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ci=oe(Li.prototype,"_priority",[Fi,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mi=oe(Li.prototype,"_tag",[Ri,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xi=oe(Li.prototype,"_stages",[Di,Ni,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pi=Li))||Pi));a.RenderFlow=Yi;var Qi=new t,qi=(new t,new t,new t),Xi=new i,ji=new G,Zi=(new G,[]),Ji=le.create(0,0,0,1),$i=new le,en=new f;en.accurate=!0;var tn=new f;tn.accurate=!0;var nn=new f,rn=new i,sn=new i,an=new i,on=new i,hn=new i,un=new i,cn=new i,_n=new t,ln=new de,dn=new t,fn=new t,pn=new t(0,0,0),gn=new x((function(){return{model:null,depth:0}}),128),vn=new x((function(){return{model:null,depth:0}}),128);function mn(e,i){var n=0;e.node&&(t.subtract(Qi,e.node.worldPosition,i.position),n=t.dot(Qi,i.forward));var r=gn.alloc();return r.model=e,r.depth=n,r}function Sn(e,i){var n=0;e.node&&(t.subtract(Qi,e.node.worldPosition,i.position),n=t.dot(Qi,i.forward));var r=vn.alloc();return r.model=e,r.depth=n,r}function En(e,n,r){var s=n.direction,a=e.normal,o=e.distance+.001,h=1/t.dot(a,s),u=s.x*h,c=s.y*h,_=s.z*h,l=a.x,d=a.y,f=a.z,p=e.matLight;p.m00=1-l*u,p.m01=-l*c,p.m02=-l*_,p.m03=0,p.m04=-d*u,p.m05=1-d*c,p.m06=-d*_,p.m07=0,p.m08=-f*u,p.m09=-f*c,p.m10=1-f*_,p.m11=0,p.m12=u*o,p.m13=c*o,p.m14=_*o,p.m15=1,i.toArray(r,p,pe.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Tn(e,n){var r=n.scene,s=r.mainLight,a=e.pipelineSceneData,o=a.shadows,h=a.skybox,u=a.renderObjects;gn.freeArray(u),u.length=0;var c=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(pe.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===ge.ShadowMap))if(c=e.pipelineSceneData.shadowObjects,vn.freeArray(c),c.length=0,s&&s.node)!function(e,n,r,s,a){var o=n.device,h=a.invisibleOcclusionRange,u=a.size.x;!function(e,t){if(t.node){var n=t.node,r=n.getWorldPosition(),s=n.getWorldRotation();i.fromRT(e,s,r),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(Xi,s),f.split(en,s,Xi,.1,a.shadowDistance),tn=f.clone(en),i.fromRT(rn,r.node.rotation,pn),i.invert(sn,rn),i.invert(an,sn);var c=sn.clone();tn.transform(sn),G.fromPoints(ji,new t(1e7,1e7,1e7),new t(-1e7,-1e7,-1e7)),ji.mergeFrustum(tn);var _=2*ji.halfExtents.z;qi.set(ji.center.x,ji.center.y,ji.center.z+ji.halfExtents.z+h),t.transformMat4(qi,qi,an),i.fromRT(rn,r.node.rotation,qi),i.invert(sn,rn),i.invert(an,sn);var l=t.distance(en.vertices[0],en.vertices[6]);$i.center.set(0,0,0),$i.radius=-1,$i.mergePoints(en.vertices);var d=.8*l+.4*$i.radius;a.shadowCameraFar=_+h;var p=.5*d;if(i.ortho(on,-p,p,-p,p,.1,a.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),u>0){i.multiply(un,on,c),t.transformMat4(_n,qi,un);var g=2/u;ln.set(g,g);var v=_n.x%ln.x,m=_n.y%ln.y;dn.set(_n.x-v,_n.y-m,_n.z),i.invert(cn,un),t.transformMat4(fn,dn,cn),i.fromRT(rn,r.node.rotation,fn),i.invert(sn,rn),i.invert(an,sn),f.createOrtho(e,d,d,.1,a.shadowCameraFar,an)}else{for(var S=0;S<8;S++)e.vertices[S].set(0,0,0);e.updatePlanes()}i.multiply(hn,on,sn),a.matShadowView=sn,a.matShadowProj=on,a.matShadowViewProj=hn}(nn,e,s,n,o);else{for(var _=0;_<8;_++)nn.vertices[_].set(0,0,0);nn.updatePlanes()}s&&o.type===ge.Planar&&function(e,i){var n=e.pipelineSceneData.shadows,r=i.direction,s=n.normal,a=n.distance+.001,o=1/t.dot(s,r),h=r.x*o,u=r.y*o,c=r.z*o,_=s.x,l=s.y,d=s.z,f=n.matLight;f.m00=1-_*h,f.m01=-_*u,f.m02=-_*c,f.m03=0,f.m04=-l*h,f.m05=1-l*u,f.m06=-l*c,f.m07=0,f.m08=-d*h,f.m09=-d*u,f.m10=1-d*c,f.m11=0,f.m12=h*a,f.m13=u*a,f.m14=c*a,f.m15=1,e.pipelineUBO.updateShadowUBORange(pe.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,s),h.enabled&&h.model&&n.clearFlag&Kt&&u.push(mn(h.model,n));for(var l=r.models,d=n.visibility,p=0;p<l.length;p++){var g=l[p];if(g.enabled&&(g.node&&(d&g.node.layer)===g.node.layer||d&g.visFlags)){if(null!=c&&g.castShadow&&g.worldBounds&&!fe.aabbFrustum(g.worldBounds,nn)&&c.push(Sn(g,n)),g.worldBounds&&!fe.aabbFrustum(g.worldBounds,n.frustum))continue;u.push(mn(g,n))}}}var wn=new i,yn=new i,On=new i,In=new z,An=function(){function e(){this._globalUBO=new Float32Array(ve.COUNT),this._cameraUBO=new Float32Array(me.COUNT),this._shadowUBO=new Float32Array(pe.COUNT)}e.updateGlobalUBOView=function(e,t){var i=e.device,n=a.director.root,r=t,s=Math.floor(i.width),o=Math.floor(i.height);r[ve.TIME_OFFSET]=n.cumulativeTime,r[ve.TIME_OFFSET+1]=n.frameTime,r[ve.TIME_OFFSET+2]=a.director.getTotalFrames(),r[ve.SCREEN_SIZE_OFFSET]=i.width,r[ve.SCREEN_SIZE_OFFSET+1]=i.height,r[ve.SCREEN_SIZE_OFFSET+2]=1/i.width,r[ve.SCREEN_SIZE_OFFSET+3]=1/i.height,r[ve.NATIVE_SIZE_OFFSET]=s,r[ve.NATIVE_SIZE_OFFSET+1]=o,r[ve.NATIVE_SIZE_OFFSET+2]=1/r[ve.NATIVE_SIZE_OFFSET],r[ve.NATIVE_SIZE_OFFSET+3]=1/r[ve.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,n,r){var s=e.device,o=(r.scene?r.scene:a.director.getScene().renderScene).mainLight,h=e.pipelineSceneData,u=h.ambient,c=h.fog,_=Math.floor(s.width),l=Math.floor(s.height),d=n,f=r.exposure,p=h.isHDR,g=h.shadingScale,v=h.fpScale;if(d[me.SCREEN_SCALE_OFFSET]=r.width/_*g,d[me.SCREEN_SCALE_OFFSET+1]=r.height/l*g,d[me.SCREEN_SCALE_OFFSET+2]=1/d[me.SCREEN_SCALE_OFFSET],d[me.SCREEN_SCALE_OFFSET+3]=1/d[me.SCREEN_SCALE_OFFSET+1],d[me.EXPOSURE_OFFSET]=f,d[me.EXPOSURE_OFFSET+1]=1/f,d[me.EXPOSURE_OFFSET+2]=p?1:0,d[me.EXPOSURE_OFFSET+3]=v/f,o){if(t.toArray(d,o.direction,me.MAIN_LIT_DIR_OFFSET),t.toArray(d,o.color,me.MAIN_LIT_COLOR_OFFSET),o.useColorTemperature){var m=o.colorTemperatureRGB;d[me.MAIN_LIT_COLOR_OFFSET]*=m.x,d[me.MAIN_LIT_COLOR_OFFSET+1]*=m.y,d[me.MAIN_LIT_COLOR_OFFSET+2]*=m.z}d[me.MAIN_LIT_COLOR_OFFSET+3]=p?o.illuminance*v:o.illuminance*f}else t.toArray(d,t.UNIT_Z,me.MAIN_LIT_DIR_OFFSET),z.toArray(d,z.ZERO,me.MAIN_LIT_COLOR_OFFSET);var S=u.colorArray;S[3]=p?u.skyIllum*v:u.skyIllum*f,d.set(S,me.AMBIENT_SKY_OFFSET),d.set(u.albedoArray,me.AMBIENT_GROUND_OFFSET),i.toArray(d,r.matView,me.MAT_VIEW_OFFSET),i.toArray(d,r.node.worldMatrix,me.MAT_VIEW_INV_OFFSET),t.toArray(d,r.position,me.CAMERA_POS_OFFSET),i.toArray(d,r.matProj,me.MAT_PROJ_OFFSET),i.toArray(d,r.matProjInv,me.MAT_PROJ_INV_OFFSET),i.toArray(d,r.matViewProj,me.MAT_VIEW_PROJ_OFFSET),i.toArray(d,r.matViewProjInv,me.MAT_VIEW_PROJ_INV_OFFSET),d[me.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),d.set(c.colorArray,me.GLOBAL_FOG_COLOR_OFFSET),d[me.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,d[me.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,d[me.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,d[me.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,d[me.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,d[me.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten},e.updateShadowUBOView=function(e,t,n){var r=e.device,s=n.scene.mainLight,a=e.pipelineSceneData.shadows,o=t;if(a.enabled){if(s&&a.type===ge.ShadowMap){var h,u,c,_=.1,l=0;if(a.fixedArea){i.invert(wn,s.node.getWorldMatrix()),h=wn;var d=a.orthoSize,f=a.orthoSize;_=a.near,l=a.far,i.ortho(yn,-d,d,-f,f,_,l,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY),u=yn,i.multiply(On,yn,wn),c=On}else _=.1,l=a.shadowCameraFar,h=a.matShadowView,u=a.matShadowProj,c=a.matShadowViewProj;i.toArray(t,h,pe.MAT_LIGHT_VIEW_OFFSET),o[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[pe.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[pe.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[pe.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[pe.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,i.toArray(t,c,pe.MAT_LIGHT_VIEW_PROJ_OFFSET);var p=Te(r)?0:1;o[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=_,o[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=l,o[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,o[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-a.saturation,o[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,o[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,o[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=a.pcf,o[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=a.bias,o[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,o[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=p,o[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=a.normalBias,o[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else s&&a.type===ge.Planar&&En(a,s,o);Ee.toArray(o,a.shadowColor,pe.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var r,s,a,o=e.device,h=e.pipelineSceneData.shadows,u=t,c=Te(o)?0:1,_=.1,l=0;switch(n.type){case ri.DIRECTIONAL:if(h.fixedArea){i.invert(wn,n.node.getWorldMatrix()),r=wn;var d=h.orthoSize,f=h.orthoSize;_=h.near,l=h.far,i.ortho(yn,-d,d,-f,f,_,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),s=yn,i.multiply(On,yn,wn),a=On}else _=.1,l=h.shadowCameraFar,r=h.matShadowView,s=h.matShadowProj,a=h.matShadowViewProj;i.toArray(t,r,pe.MAT_LIGHT_VIEW_OFFSET),u[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=s.m10,u[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=s.m14,u[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=s.m11,u[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=s.m15,u[pe.SHADOW_PROJ_INFO_OFFSET+0]=s.m00,u[pe.SHADOW_PROJ_INFO_OFFSET+1]=s.m05,u[pe.SHADOW_PROJ_INFO_OFFSET+2]=1/s.m00,u[pe.SHADOW_PROJ_INFO_OFFSET+3]=1/s.m05,i.toArray(t,a,pe.MAT_LIGHT_VIEW_PROJ_OFFSET),In.set(_,l,0,1-h.saturation),z.toArray(u,In,pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),In.set(0,c,h.normalBias,0),z.toArray(u,In,pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case ri.SPOT:i.invert(wn,n.node.getWorldMatrix()),i.toArray(u,wn,pe.MAT_LIGHT_VIEW_OFFSET),i.perspective(yn,n.angle,n.aspect,.001,n.range),i.multiply(On,yn,wn),i.toArray(u,On,pe.MAT_LIGHT_VIEW_PROJ_OFFSET),In.set(.01,n.range,0,1-h.saturation),z.toArray(u,In,pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),In.set(1,c,h.normalBias,0),z.toArray(u,In,pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}In.set(h.size.x,h.size.y,h.pcf,h.bias),z.toArray(u,In,pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Ee.toArray(u,h.shadowColor,pe.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var n=e.prototype;return n._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},n.activate=function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;this._initCombineSignY();var n=e.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,ve.SIZE,ve.SIZE));i.bindBuffer(ve.BINDING,n);var r=e.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,me.SIZE,me.SIZE));i.bindBuffer(me.BINDING,r);var s=e.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,pe.SIZE,pe.SIZE));i.bindBuffer(pe.BINDING,s)},n.updateGlobalUBO=function(){var t=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(this._pipeline,this._globalUBO),n[0].updateBuffer(i.getBuffer(ve.BINDING),this._globalUBO),t.bindBuffer(ve.BINDING,i.getBuffer(ve.BINDING)),t.update()},n.updateCameraUBO=function(t){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(n.getBuffer(me.BINDING),this._cameraUBO),i.bindBuffer(me.BINDING,n.getBuffer(me.BINDING)),i.update()},n.updateShadowUBO=function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,s=i.shadowFrameBufferMap,a=t.scene.mainLight;n.update(),a&&s.has(a)&&n.bindTexture(Se,s.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),r[0].updateBuffer(n.getBuffer(pe.BINDING),this._shadowUBO)}},n.updateShadowUBOLight=function(t,i){var n=this._pipeline.descriptorSet;e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,t,i),n.getBuffer(pe.BINDING).update(this._shadowUBO)},n.updateShadowUBORange=function(e,t){t instanceof i?i.toArray(this._shadowUBO,t,e):t instanceof Ee&&Ee.toArray(this._shadowUBO,t,e)},n.destroy=function(){},e}();An._combineSignY=0;var bn,Fn,Rn,Dn,Nn,Pn,Ln,Bn,Cn,Mn,xn,Un=[O.LINEAR,O.LINEAR,O.NONE,I.CLAMP,I.CLAMP,I.CLAMP],Hn=[O.POINT,O.POINT,O.NONE,I.CLAMP,I.CLAMP,I.CLAMP],Gn=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device;var t=A(Un);this._linearSampler=b.getSampler(this._device,t);var i=A(Hn);this._pointSampler=b.getSampler(this._device,i);var n=new ye(Oe.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(n),this._globalDescriptorSet=this._device.createDescriptorSet(new R(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindBuffer(e,t),n=i.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindSampler(e,t),n=i.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindTexture(e,t),n=i.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=this._globalDescriptorSet,n=t.createDescriptorSet(new R(this._descriptorSetLayout));this._descriptorSetMap.set(e,n);for(var r=we.UBO_GLOBAL;r<we.COUNT;r++)n.bindBuffer(r,i.getBuffer(r)),n.bindSampler(r,i.getSampler(r)),n.bindTexture(r,i.getTexture(r));var s=t.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,pe.SIZE,pe.SIZE));n.bindBuffer(pe.BINDING,s),n.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy(),this._linearSampler.destroy(),this._pointSampler.destroy()},c(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),zn=e("x",(bn=ae("cc.RenderPipeline"),Fn=ce(),Rn=ce(),Dn=_e([Yi]),bn((Cn=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,he(t,"_tag",Ln,ie(t)),he(t,"_flows",Bn,ie(t)),t._commandBuffers=[],t._pipelineUBO=new An,t._macros={},t._constantMacros="",t}$(t,e);var i=t.prototype;return i.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},i.generateRenderArea=function(e){var t=new Ae,i=e.viewport,n=this.pipelineSceneData,r=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.height:e.width,s=e.window.hasOnScreenAttachments&&this.device.surfaceTransform%2?e.width:e.height;return t.x=i.x*r,t.y=i.y*s,t.width=i.width*r*n.shadingScale,t.height=i.height*s*n.shadingScale,t},i.activate=function(){this._device=a.director.root.device,this._globalDSManager=new Gn(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),!0},i.render=function(e){for(var t=0;t<e.length;t++){var i=e[t];if(i.scene)for(var n=0;n<this._flows.length;n++)this._flows[n].render(i)}},i.destroy=function(){for(var t,i,n=0;n<this._flows.length;n++)this._flows[n].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),e.prototype.destroy.call(this)},i.resize=function(){},i._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(V.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",this._constantMacros=e},c(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}}]),t}(Ie),Ln=oe((Pn=Cn).prototype,"_tag",[Fn,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bn=oe(Pn.prototype,"_flows",[Rn,Dn,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nn=Pn))||Nn));a.RenderPipeline=zn,function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(Mn||(Mn={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(xn||(xn={}));var kn,Vn,Wn,Kn,Yn,Qn,qn,Xn,jn,Zn,Jn,$n,er,tr,ir,nr,rr,sr,ar,or,hr,ur,cr,_r,lr,dr,fr,pr,gr,vr,mr,Sr,Er,Tr,wr,yr,Or,Ir,Ar,br,Fr,Rr,Dr,Nr,Pr,Lr,Br,Cr,Mr,xr,Ur,Hr,Gr,zr,kr,Vr,Wr,Kr,Yr,Qr,qr,Xr,jr,Zr,Jr,$r,es,ts,is,ns,rs,ss,as,os,hs,us,cs,_s,ls,ds=e("Y",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,i,n,r){var s=t.hash^n.hash^r.attributesHash^i.id,a=this._PSOHashMap.get(s);if(!a){t.pipelineLayout;var o=new be(r.attributes),h=new Fe(i,t.pipelineLayout,n,o,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(h),this._PSOHashMap.set(s,a)}return a},e}());ds._PSOHashMap=new Map,Re(S),Re(E),Re(De),Re(Ne),Re(Pe),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(ls||(ls={})),Re(ls),kn=ae("RenderTextureDesc"),Vn=_e(S),Wn=_e(E),Kn=_e(T),kn((Qn=oe((Yn=function(){he(this,"name",Qn,this),he(this,"type",qn,this),he(this,"usage",Xn,this),he(this,"format",jn,this),he(this,"width",Zn,this),he(this,"height",Jn,this)}).prototype,"name",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qn=oe(Yn.prototype,"type",[Vn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S.TEX2D}}),Xn=oe(Yn.prototype,"usage",[Wn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return E.COLOR_ATTACHMENT}}),jn=oe(Yn.prototype,"format",[Kn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T.UNKNOWN}}),Zn=oe(Yn.prototype,"width",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Jn=oe(Yn.prototype,"height",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Yn));var fs,ps=($n=ae("RenderTextureConfig"),er=_e(Le),$n((nr=oe((ir=function(){he(this,"name",nr,this),he(this,"texture",rr,this)}).prototype,"name",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rr=oe(ir.prototype,"texture",[er],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tr=ir))||tr),gs=(sr=ae("MaterialConfig"),ar=_e(ne),sr((hr=oe((or=function(){he(this,"name",hr,this),he(this,"material",ur,this)}).prototype,"name",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ur=oe(or.prototype,"material",[ar],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),or)),cr=ae("FrameBufferDesc"),_r=_e([Be]),lr=_e(Le),cr((fr=oe((dr=function(){he(this,"name",fr,this),he(this,"renderPass",pr,this),he(this,"colorTextures",gr,this),he(this,"depthStencilTexture",vr,this),he(this,"texture",mr,this)}).prototype,"name",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pr=oe(dr.prototype,"renderPass",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gr=oe(dr.prototype,"colorTextures",[_r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vr=oe(dr.prototype,"depthStencilTexture",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mr=oe(dr.prototype,"texture",[lr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dr)),Sr=ae("ColorDesc"),Er=_e(T),Tr=_e(Ne),wr=_e(De),yr=_e([Pe]),Or=_e([Pe]),Sr((br=oe((Ar=function(){he(this,"format",br,this),he(this,"loadOp",Fr,this),he(this,"storeOp",Rr,this),he(this,"sampleCount",Dr,this),he(this,"beginAccesses",Nr,this),he(this,"endAccesses",Pr,this)}).prototype,"format",[Er],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T.UNKNOWN}}),Fr=oe(Ar.prototype,"loadOp",[Tr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ne.CLEAR}}),Rr=oe(Ar.prototype,"storeOp",[wr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return De.STORE}}),Dr=oe(Ar.prototype,"sampleCount",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Nr=oe(Ar.prototype,"beginAccesses",[yr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pr=oe(Ar.prototype,"endAccesses",[Or],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Pe.PRESENT]}}),Ir=Ar))||Ir),vs=(Lr=ae("DepthStencilDesc"),Br=_e(T),Cr=_e(Ne),Mr=_e(De),xr=_e(Ne),Ur=_e(De),Hr=_e([Pe]),Gr=_e([Pe]),Lr((Vr=oe((kr=function(){he(this,"format",Vr,this),he(this,"depthLoadOp",Wr,this),he(this,"depthStoreOp",Kr,this),he(this,"stencilLoadOp",Yr,this),he(this,"stencilStoreOp",Qr,this),he(this,"sampleCount",qr,this),he(this,"beginAccesses",Xr,this),he(this,"endAccesses",jr,this)}).prototype,"format",[Br],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T.UNKNOWN}}),Wr=oe(kr.prototype,"depthLoadOp",[Cr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ne.CLEAR}}),Kr=oe(kr.prototype,"depthStoreOp",[Mr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return De.STORE}}),Yr=oe(kr.prototype,"stencilLoadOp",[xr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ne.CLEAR}}),Qr=oe(kr.prototype,"stencilStoreOp",[Ur],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return De.STORE}}),qr=oe(kr.prototype,"sampleCount",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xr=oe(kr.prototype,"beginAccesses",[Hr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jr=oe(kr.prototype,"endAccesses",[Gr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Pe.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),zr=kr))||zr);Zr=ae("RenderPassDesc"),Jr=_e([gs]),$r=_e(vs),Zr((ts=oe((es=function(){he(this,"index",ts,this),he(this,"colorAttachments",is,this),he(this,"depthStencilAttachment",ns,this)}).prototype,"index",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),is=oe(es.prototype,"colorAttachments",[Jr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ns=oe(es.prototype,"depthStencilAttachment",[$r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vs}}),es)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(fs||(fs={})),Re(fs);var ms=(rs=ae("RenderQueueDesc"),ss=_e(fs),as=_e([Be]),rs((us=oe((hs=function(){he(this,"isTransparent",us,this),he(this,"sortMode",cs,this),he(this,"stages",_s,this)}).prototype,"isTransparent",[ue,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cs=oe(hs.prototype,"sortMode",[ss],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fs.FRONT_TO_BACK}}),_s=oe(hs.prototype,"stages",[as],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),os=hs))||os);function Ss(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Es(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var Ts=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Me((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new xe(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var n=e.model.subModels[t],r=n.passes[i],s=n.shaders[i];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|n.priority<<8|i,o=this._passPool.add();return o.hash=a,o.depth=e.depth||0,o.shaderId=s.id,o.subModel=n,o.passIdx=i,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],s=r.subModel,a=r.passIdx,o=s.inputAssembler,h=s.passes[a],u=s.shaders[a],c=ds.getOrCreatePipelineState(e,h,u,t,o);i.bindPipelineState(c),i.bindDescriptorSet(Ue.MATERIAL,h.descriptorSet),i.bindDescriptorSet(Ue.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}();function ws(e){for(var t=0,i=0;i<e.stages.length;i++)t|=v(e.stages[i]);var n=Ss;switch(e.sortMode){case fs.BACK_TO_FRONT:n=Es;break;case fs.FRONT_TO_BACK:n=Ss}return new Ts({isTransparent:e.isTransparent,phases:t,sortFunc:n})}function ys(e){e.clear()}function Os(e){e.sort()}function Is(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var As=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var s=0;s<r.vbs.length;++s)r.vbs[s].update(r.vbDatas[s]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}i=t.next()}},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var s=!1,a=0;a<r.value.batches.length;++a){var o=r.value.batches[a];if(o.mergeCount){if(!s){var h=o.shader,u=ds.getOrCreatePipelineState(e,o.pass,h,t,o.ia);i.bindPipelineState(u),i.bindDescriptorSet(Ue.MATERIAL,o.pass.descriptorSet),s=!0}i.bindDescriptorSet(Ue.LOCAL,o.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(o.ia),i.draw(o.ia)}}r=n.next()}},e}(),bs=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){var s=r.value,a=s.instances,o=s.pass;if(s.hasPendingModels){i.bindDescriptorSet(Ue.MATERIAL,o.descriptorSet);for(var h=null,u=0;u<a.length;++u){var c=a[u];if(c.count){var _=c.shader,l=ds.getOrCreatePipelineState(e,o,_,t,c.ia);h!==l&&(i.bindPipelineState(l),h=l),i.bindDescriptorSet(Ue.LOCAL,c.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(c.ia),i.draw(c.ia)}}}r=n.next()}},e}(),Fs=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var r=e.subMesh.flatBuffers;if(0!==r.length){for(var s=0,a=0,o=r[0].count,h=e.passes[t],u=e.shaders[t],c=e.descriptorSet,_=!1,l=0;l<this.batches.length;++l){var d=this.batches[l];if(d.vbs.length===r.length&&d.mergeCount<He.BATCHING_COUNT){_=!0;for(var f=0;f<d.vbs.length;++f)if(d.vbs[f].stride!==r[f].stride){_=!1;break}if(_){for(var p=0;p<d.vbs.length;++p){var g=r[p],v=d.vbs[p],m=d.vbDatas[p];(s=(o+d.vbCount)*g.stride)>v.size&&(v.resize(s),d.vbDatas[p]=new Uint8Array(s),d.vbDatas[p].set(m)),d.vbDatas[p].set(g.buffer,d.vbCount*g.stride)}var S=d.vbIdxData;(a=4*(o+d.vbCount))>d.vbIdx.size&&(d.vbIdx.resize(a),d.vbIdxData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),d.vbIdxData.set(S),S=d.vbIdxData);var E=d.vbCount,w=E+o,y=d.mergeCount;if(S[E]!==y||S[w-1]!==y)for(var O=E;O<w;O++)S[O]=y+.1;return i.toArray(d.uboData,n.transform.worldMatrix,He.MAT_WORLDS_OFFSET+16*d.mergeCount),d.mergeCount||(c.bindBuffer(He.BINDING,d.ubo),c.update(),d.pass=h,d.shader=u,d.descriptorSet=c),++d.mergeCount,d.vbCount+=o,void(d.ia.vertexCount+=o)}}}for(var I=[],A=[],b=[],F=0;F<r.length;++F){var R=r[F],D=this._device.createBuffer(new P(L.VERTEX|L.TRANSFER_DST,B.HOST|B.DEVICE,R.count*R.stride,R.stride));D.update(R.buffer.buffer),I.push(D),A.push(new Uint8Array(D.size)),b.push(D)}var N=this._device.createBuffer(new P(L.VERTEX|L.TRANSFER_DST,B.HOST|B.DEVICE,4*o,4)),x=new Float32Array(o);x.fill(0),N.update(x),b.push(N);for(var U=e.inputAssembler.attributes,H=new Array(U.length+1),G=0;G<U.length;++G)H[G]=U[G];H[U.length]=new C("a_dyn_batch_id",T.R32F,!1,r.length);var z=new M(H,b),k=this._device.createInputAssembler(z),V=this._device.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,He.SIZE,He.SIZE));c.bindBuffer(He.BINDING,V),c.update();var W=new Float32Array(He.COUNT);i.toArray(W,n.transform.worldMatrix,He.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:I,vbDatas:A,vbIdx:N,vbIdxData:x,vbCount:o,ia:k,ubo:V,uboData:W,pass:h,shader:u,descriptorSet:c})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}();Fs._buffers=new Map;var Rs=new x((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Ds=new Float32Array(4),Ns=le.create(0,0,0,1),Ps=[],Ls=[],Bs=new i,Cs=new i;function Ms(e,t){return!(!t.worldBounds||fe.aabbWithAABB(t.worldBounds,e.aabb))}function xs(e,t){return!(!t.worldBounds||fe.aabbWithAABB(t.worldBounds,e.aabb)&&fe.aabbFrustum(t.worldBounds,e.frustum))}var Us=v("forward-add"),Hs=[];function Gs(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===Us){s=a,i=!0;break}t.push(s)}return i}var zs,ks,Vs,Ws,Ks,Ys,Qs,qs,Xs,js,Zs,Js=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._validLights=[],this._lightPasses=[],this._shadowUBO=new Float32Array(pe.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new bs,this._batchedQueue=new As;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Ge.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new ze(this._lightBuffer,0,Ge.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var n=e.prototype;return n.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear(),this._validLights.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Rs.freeArray(this._lightPasses),this._lightPasses.length=0},n.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var n=t[i],r=e.get(n);r&&(r.getBuffer(pe.BINDING).destroy(),r.getSampler(Se).destroy(),r.getSampler(ke).destroy(),r.getTexture(Se).destroy(),r.getTexture(ke).destroy(),r.destroy()),e.delete(n)}},n.gatherLightPasses=function(e,t){var i=this._validLights;if(this.clear(),this._gatherValidLights(e,i),i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var n=this._pipeline.pipelineSceneData.renderObjects,r=0;r<n.length;r++){var s=n[r].model,a=s.subModels;if(Gs(a,Hs)&&(Ls.length=0,this._lightCulling(s,i),Ls.length))for(var o=0;o<a.length;o++){var h=Hs[o];if(!(h<0)){var u=a[o],c=u.passes[h];u.descriptorSet.bindBuffer(Ge.BINDING,this._firstLightBufferView),u.descriptorSet.update(),this._addRenderQueue(c,u,s,h,i)}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},n.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var s=this._lightPasses[r],a=s.subModel,o=s.passIdx,h=s.dynamicOffsets,u=s.lights,c=a.passes[o],_=a.shaders[o],l=a.inputAssembler,d=ds.getOrCreatePipelineState(e,c,_,t,l),f=c.descriptorSet,p=a.descriptorSet;i.bindPipelineState(d),i.bindDescriptorSet(Ue.MATERIAL,f),i.bindInputAssembler(l);for(var g=0;g<h.length;++g){var v=u[g],m=n.getOrCreateDescriptorSet(v);Ps[0]=h[g],i.bindDescriptorSet(Ue.GLOBAL,m),i.bindDescriptorSet(Ue.LOCAL,p,Ps),i.draw(l)}}},n._gatherValidLights=function(e,t){for(var i=e.scene.sphereLights,n=0;n<i.length;n++){var r=i[n];r.baked||(le.set(Ns,r.position.x,r.position.y,r.position.z,r.range),fe.sphereFrustum(Ns,e.frustum)&&t.push(r))}for(var s=e.scene.spotLights,a=0;a<s.length;a++){var o=s[a];o.baked||(le.set(Ns,o.position.x,o.position.y,o.position.z,o.range),fe.sphereFrustum(Ns,e.frustum)&&t.push(o))}},n._lightCulling=function(e,t){for(var i=0;i<t.length;i++){var n=t[i],r=!1;switch(n.type){case ri.SPHERE:r=Ms(n,e);break;case ri.SPOT:r=xs(n,e)}r||Ls.push(i)}},n._addRenderQueue=function(e,t,i,n){var r=e.batchingScheme;if(r===p.INSTANCING)for(var s=0;s<Ls.length;s++){var a=Ls[s],o=jt.get(e,a);o.merge(t,i.instancedAttributes,n),o.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(o)}else if(r===p.VB_MERGING)for(var h=0;h<Ls.length;h++){var u=Ls[h],c=Fs.get(e,u);c.merge(t,n,i),c.dynamicOffsets[0]=this._lightBufferStride*u,this._batchedQueue.queue.add(c)}else{var _=Rs.alloc();_.subModel=t,_.passIdx=n;for(var l=0;l<Ls.length;l++){var d=Ls[l];_.lights.push(d),_.dynamicOffsets.push(this._lightBufferStride*d)}this._lightPasses.push(_)}},n._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,r=this._pipeline.pipelineSceneData,s=r.shadows,a=r.shadowFrameBufferMap,o=e.scene.mainLight,h=Te(n)?0:1,u=this._pipeline.globalDSManager,c=0;c<this._validLights.length;c++){var _=this._validLights[c],l=u.getOrCreateDescriptorSet(c);if(l){var d=void 0,f=void 0;switch(_.type){case ri.SPHERE:o&&En(s,o,this._shadowUBO),this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=s.pcf,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=s.bias,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=s.normalBias,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Ee.toArray(this._shadowUBO,s.shadowColor,pe.SHADOW_COLOR_OFFSET);break;case ri.SPOT:if(o&&En(s,o,this._shadowUBO),i.invert(Bs,_.node.getWorldMatrix()),i.perspective(Cs,_.angle,_.aspect,.001,_.range),d=Cs.clone(),f=Cs.clone().invert(),i.multiply(Cs,Cs,Bs),i.toArray(this._shadowUBO,Bs,pe.MAT_LIGHT_VIEW_OFFSET),i.toArray(this._shadowUBO,Cs,pe.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=_.range,this._shadowUBO[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[pe.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-s.saturation,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=s.pcf,this._shadowUBO[pe.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=s.bias,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=s.normalBias,this._shadowUBO[pe.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[pe.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[pe.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[pe.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[pe.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[pe.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[pe.SHADOW_PROJ_INFO_OFFSET+0]=d.m00,this._shadowUBO[pe.SHADOW_PROJ_INFO_OFFSET+1]=d.m05,this._shadowUBO[pe.SHADOW_PROJ_INFO_OFFSET+2]=1/d.m00,this._shadowUBO[pe.SHADOW_PROJ_INFO_OFFSET+3]=1/d.m05,Ee.toArray(this._shadowUBO,s.shadowColor,pe.SHADOW_COLOR_OFFSET),a.has(_)){var p,g=null===(p=a.get(_))||void 0===p?void 0:p.colorTextures[0];g&&l.bindTexture(ke,g)}}l.update(),t.updateBuffer(l.getBuffer(pe.BINDING),this._shadowUBO)}}},n._updateUBOs=function(e,i){var n=e.exposure,r=this._pipeline.pipelineSceneData,s=r.isHDR,a=r.fpScale;this._validLights.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Ve(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new ze(this._lightBuffer,0,Ge.SIZE)));for(var o=0,h=0;o<this._validLights.length;o++,h+=this._lightBufferElementCount){var u=this._validLights[o];switch(u.type){case ri.SPHERE:if(t.toArray(Ds,u.position),Ds[3]=0,this._lightBufferData.set(Ds,h+Ge.LIGHT_POS_OFFSET),Ds[0]=u.size,Ds[1]=u.range,Ds[2]=0,this._lightBufferData.set(Ds,h+Ge.LIGHT_SIZE_RANGE_ANGLE_OFFSET),t.toArray(Ds,u.color),u.useColorTemperature){var c=u.colorTemperatureRGB;Ds[0]*=c.x,Ds[1]*=c.y,Ds[2]*=c.z}Ds[3]=s?u.luminance*a*this._lightMeterScale:u.luminance*n*this._lightMeterScale,this._lightBufferData.set(Ds,h+Ge.LIGHT_COLOR_OFFSET);break;case ri.SPOT:if(t.toArray(Ds,u.position),Ds[3]=1,this._lightBufferData.set(Ds,h+Ge.LIGHT_POS_OFFSET),Ds[0]=u.size,Ds[1]=u.range,Ds[2]=u.spotAngle,this._lightBufferData.set(Ds,h+Ge.LIGHT_SIZE_RANGE_ANGLE_OFFSET),t.toArray(Ds,u.direction),this._lightBufferData.set(Ds,h+Ge.LIGHT_DIR_OFFSET),t.toArray(Ds,u.color),u.useColorTemperature){var _=u.colorTemperatureRGB;Ds[0]*=_.x,Ds[1]*=_.y,Ds[2]*=_.z}Ds[3]=s?u.luminance*a*this._lightMeterScale:u.luminance*n*this._lightMeterScale,this._lightBufferData.set(Ds,h+Ge.LIGHT_COLOR_OFFSET)}}i.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),$s=new G,ea=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new bs,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var i=this._pipeline.pipelineSceneData,n=this._pipeline.pipelineUBO,r=i.shadows;if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,r.enabled&&r.type===ge.Planar){n.updateShadowUBO(e);var s=e.scene,a=e.frustum,o=0!=(e.visibility&U.BitMask.DEFAULT);if(s.mainLight&&o){for(var h=s.models,u=0;u<h.length;u++){var c=h[u];c.enabled&&c.node&&c.castShadow&&this._castModels.push(c)}var _=jt.get(r.instancingMaterial.passes[0]);this._instancedQueue.queue.add(_);for(var l=0;l<this._castModels.length;l++){var d=this._castModels[l];if(!d.worldBounds||(G.transform($s,d.worldBounds,r.matLight),fe.aabbFrustum($s,a)))if(d.isInstancingEnabled)for(var f=d.subModels,p=0;p<f.length;p++){var g=f[p];_.merge(g,d.instancedAttributes,0,g.planarInstanceShader)}else this._pendingModels.push(d)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var n=this._pipeline.pipelineSceneData.shadows;if(n.enabled&&n.type===ge.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,i),this._pendingModels.length)){var r=n.material.passes[0],s=r.descriptorSet;i.bindDescriptorSet(Ue.MATERIAL,s);for(var a=this._pendingModels.length,o=0;o<a;o++)for(var h=this._pendingModels[o],u=0;u<h.subModels.length;u++){var c=h.subModels[u],_=c.planarShader,l=c.inputAssembler,d=ds.getOrCreatePipelineState(e,r,_,t,l);i.bindPipelineState(d),i.bindDescriptorSet(Ue.LOCAL,c.descriptorSet),i.bindInputAssembler(l),i.draw(l)}}},e}(),ta=function(){function e(){this._phaseID=v("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=e.scene.batches,a=0;a<s.length;a++){var o=s[a],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var u=o.shaders.length,c=0;c<u;c++){var _=o.passes[c];if(_.phase===this._phaseID){var l=o.shaders[c],d=o.inputAssembler,f=o.descriptorSet,p=ds.getOrCreatePipelineState(n,_,l,t,d);r.bindPipelineState(p),r.bindDescriptorSet(Ue.MATERIAL,_.descriptorSet),r.bindDescriptorSet(Ue.LOCAL,f),r.bindInputAssembler(d),r.draw(d)}}}},e}(),ia=[new l(0,0,0,1)],na=e("B",(zs=ae("ForwardStage"),ks=_e([ms]),Vs=ce(),zs((qs=Qs=function(e){function t(){var t;return t=e.call(this)||this,he(t,"renderQueues",Ys,ie(t)),t._renderQueues=[],t._renderArea=new Ae,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=v("default"),t._clearFlag=4294967295,t._batchedQueue=new As,t._instancedQueue=new bs,t._uiPhase=new ta,t}$(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=ws(this.renderQueues[n]);this._additiveLightQueue=new Js(this._pipeline),this._planarQueue=new ea(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(ys);for(var r=t.pipelineSceneData.renderObjects,s=0,a=0,o=0,h=0;h<r.length;++h){var u=r[h],c=u.model.subModels;for(s=0;s<c.length;++s){var _=c[s],l=_.passes;for(a=0;a<l.length;++a){var d=l[a];if(d.phase===this._phaseID){var f=d.batchingScheme;if(f===p.INSTANCING){var g=jt.get(d);g.merge(_,u.model.instancedAttributes,a),this._instancedQueue.queue.add(g)}else if(f===p.VB_MERGING){var v=Fs.get(d);v.merge(_,a,u.model),this._batchedQueue.queue.add(v)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(u,s,a)}}}}this._renderQueues.forEach(Os);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m);var S=t.pipelineSceneData;if(this._renderArea=t.generateRenderArea(e),e.clearFlag&n.COLOR)if(S.isHDR){Is(ia[0],e.clearColor);var E=S.fpScale/e.exposure;ia[0].x*=E,ia[0].y*=E,ia[0].z*=E}else ia[0].x=e.clearColor.x,ia[0].y=e.clearColor.y,ia[0].z=e.clearColor.z;ia[0].w=e.clearColor.w;var T=e.window.framebuffer,w=T.colorTextures[0]?T.renderPass:t.getRenderPass(e.clearFlag&this._clearFlag);m.beginRenderPass(w,T,this._renderArea,ia,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Ue.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,w,m),this._instancedQueue.recordCommandBuffer(i,w,m),this._batchedQueue.recordCommandBuffer(i,w,m),this._additiveLightQueue.recordCommandBuffer(i,w,m),this._planarQueue.recordCommandBuffer(i,w,m),this._renderQueues[1].recordCommandBuffer(i,w,m),this._uiPhase.render(e,w),m.endRenderPass()},t}(Ki),Qs.initInfo={name:"ForwardStage",priority:Mn.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:fs.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:fs.BACK_TO_FRONT,stages:["default","planarShadow"]}]},Ys=oe((Ks=qs).prototype,"renderQueues",[ks,ue,Vs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ws=Ks))||Ws)),ra=e("A",ae("ForwardFlow")((Zs=js=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new na;i.initialize(na.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(Yi),js.initInfo={name:We,priority:xn.FORWARD,stages:[]},Xs=Zs))||Xs),sa=v("shadow-caster"),aa=[];function oa(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===sa){s=a,i=!0;break}t.push(s)}return i}var ha,ua,ca,_a,la,da,fa,pa,ga,va,ma,Sa,Ea,Ta,wa,ya,Oa,Ia,Aa,ba,Fa,Ra,Da,Na=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new bs,this._batchedQueue=new As}var t=e.prototype;return t.gatherLightPasses=function(e,t,i){this.clear();var n=this._pipeline.pipelineSceneData.shadows,r=this._pipeline.pipelineSceneData.shadowObjects,s=this._pipeline.pipelineSceneData.renderObjects;if(e&&n.enabled&&n.type===ge.ShadowMap)switch(this._pipeline.pipelineUBO.updateShadowUBOLight(e,t),e.type){case ri.DIRECTIONAL:for(var a=0;a<r.length;a++){var o=r[a].model;oa(o.subModels,aa)&&this.add(o,i,aa)}break;case ri.SPOT:for(var h=0;h<s.length;h++){var u=s[h].model;oa(u.subModels,aa)&&u.castShadow&&(!u.worldBounds||fe.aabbWithAABB(u.worldBounds,e.aabb)&&fe.aabbFrustum(u.worldBounds,e.frustum))&&this.add(u,i,aa)}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,i){for(var n=e.subModels,r=0;r<n.length;r++){var s=n[r],a=i[r],o=s.passes[a];if(o.batchingScheme===p.INSTANCING){var h=jt.get(o);h.merge(s,e.instancedAttributes,a),this._instancedQueue.queue.add(h)}else if(o.batchingScheme===p.VB_MERGING){var u=Fs.get(o);u.merge(s,a,e),this._batchedQueue.queue.add(u)}else{var c=s.shaders[a];this._subModelsArray.push(s),c&&this._shaderArray.push(c),this._passArray.push(o)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,h=ds.getOrCreatePipelineState(e,a,s,t,o),u=a.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(Ue.MATERIAL,u),i.bindDescriptorSet(Ue.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}(),Pa=[new l(1,1,1,1)],La=e("W",ae("ShadowStage")((ca=ua=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowFrameBuffer=null,t._renderArea=new Ae,t._light=null,t}$(t,e);var i=t.prototype;return i.setUsage=function(e,t){this._light=e,this._shadowFrameBuffer=t},i.destroy=function(){var e;null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){Pa[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],i=this._shadowFrameBuffer.renderPass;t.beginRenderPass(i,this._shadowFrameBuffer,this._renderArea,Pa,e.clearDepth,e.clearStencil),t.endRenderPass()}},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData,n=i.shadows,r=i.shadingScale,s=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._additiveShadowQueue.gatherLightPasses(this._light,e,s);var a=e.viewport,o=n.size;this._renderArea.x=a.x*o.x,this._renderArea.y=a.y*o.y,this._renderArea.width=a.width*o.x*r,this._renderArea.height=a.height*o.y*r;var h=t.device,u=this._shadowFrameBuffer.renderPass;s.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,Pa,e.clearDepth,e.clearStencil),s.bindDescriptorSet(Ue.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(h,u,s),s.endRenderPass()}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new Na(t)},t}(Ki),ua.initInfo={name:"ShadowStage",priority:Mn.FORWARD,tag:0},ha=ca))||ha),Ba=e("U",ae("ShadowFlow")((da=la=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowRenderPass=null,t}$(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new La;i.initialize(La.initInfo),this._stages.push(i)}return!0},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,n=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.shadowObjects,s=t.pipelineSceneData.renderObjects;if(i.enabled&&i.type===ge.ShadowMap){var a=function(e,t){Zi.length=0;var i=e.scene;Zi.push(i.mainLight);for(var n=i.spotLights,r=0;r<n.length;r++){var s=n[r];le.set(Ji,s.position.x,s.position.y,s.position.z,s.range),fe.sphereFrustum(Ji,e.frustum)&&t>Zi.length&&Zi.push(s)}return Zi}(e,i.maxReceived);if(0!==r.length||0!==s.length){i.shadowMapDirty&&this.resizeShadowMap();for(var o=0;o<a.length;o++){var h=a[o];n.has(h)||this._initShadowFrameBuffer(t,h);for(var u=n.get(h),c=0;c<this._stages.length;c++){var _=this._stages[c];_.setUsage(h,u),_.render(e)}}t.pipelineUBO.updateShadowUBO(e)}else this.clearShadowMap(a,e)}},i.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(t.values()),n=0;n<i.length;n++){var r=i[n];if(r){for(var s=r.colorTextures,a=0;a<s.length;a++){var o=s[n];o&&o.destroy()}s.length=0;var h=r.depthStencilTexture;h&&h.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(e,t){var i=e.device,n=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,s=Te(i)?T.R32F:T.RGBA8;if(!this._shadowRenderPass){var a=new Ke;a.format=s,a.loadOp=Ne.CLEAR,a.storeOp=De.STORE,a.sampleCount=1;var o=new Ye;o.format=i.depthStencilFormat,o.depthLoadOp=Ne.CLEAR,o.depthStoreOp=De.DISCARD,o.stencilLoadOp=Ne.CLEAR,o.stencilStoreOp=De.DISCARD,o.sampleCount=1;var h=new Qe([a],o);this._shadowRenderPass=i.createRenderPass(h)}var u=[];u.push(i.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,s,n.x,n.y)));var c=i.createTexture(new m(S.TEX2D,E.DEPTH_STENCIL_ATTACHMENT,i.depthStencilFormat,n.x,n.y)),_=i.createFramebuffer(new qe(this._shadowRenderPass,u,c));r.set(t,_)},i.clearShadowMap=function(e,t){for(var i=this._pipeline.pipelineSceneData,n=0;n<e.length;n++){var r=e[n],s=i.shadowFrameBufferMap.get(r);if(i.shadowFrameBufferMap.has(r))for(var a=0;a<this._stages.length;a++){var o=this._stages[a];o.setUsage(r,s),o.clearFramebuffer(t)}}},i.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,i=this._pipeline,n=i.device,r=i.pipelineSceneData.shadowFrameBufferMap,s=Te(n)?T.R32F:T.RGBA8,a=r.values(),o=a.next();!o.done;){var h=o.value;if(h){var u=[];u.push(i.device.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,s,t.x,t.y)));var c=h.depthStencilTexture;c&&c.resize(t.x,t.y);var _=h.renderPass;h.destroy(),h.initialize(new qe(_,u,c)),o=a.next()}else o=a.next()}e.shadowMapDirty=!1},t}(Yi),la.initInfo={name:Xe,priority:xn.SHADOW,tag:ls.SCENE,stages:[]},_a=da))||_a),Ca=function(){var e=t.prototype;function t(){this.fog=new je,this.ambient=new ee,this.skybox=new pi,this.shadows=new J,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._isHDR=!1,this._shadingScale=1,this._fpScale=1/1024,this._init(),this.shadingScale=1,this.fpScale=1/1024}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,!0},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy()},c(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale=e}},{key:"fpScale",get:function(){return this._fpScale},set:function(e){this._fpScale=e}}]),t}(),Ma=[O.POINT,O.POINT,O.NONE,I.CLAMP,I.CLAMP,I.CLAMP];e("F",(fa=ae("ForwardPipeline"),pa=_e([ps]),ga=ce(),fa((Ea=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,he(t,"renderTextures",Sa,ie(t)),t._renderPasses=new Map,t}$(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Ba;i.initialize(Ba.initInfo),this._flows.push(i);var n=new ra;n.initialize(ra.initInfo),this._flows.push(n)}return!0},i.activate=function(){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new Ca,!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(D(2402),1))},i.render=function(e){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){Tn(this,i),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i)}}this._commandBuffers[0].end(),this._device.flushCommands(this._commandBuffers),this._device.queue.submit(this._commandBuffers)},i.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,r=new Ke,s=new Ye;r.format=i.colorFormat,s.format=i.depthStencilFormat,s.stencilStoreOp=De.DISCARD,s.depthStoreOp=De.DISCARD,e&n.COLOR||(e&Kt?r.loadOp=Ne.DISCARD:(r.loadOp=Ne.LOAD,r.beginAccesses=[Pe.PRESENT])),(e&n.DEPTH_STENCIL)!==n.DEPTH_STENCIL&&(e&n.DEPTH||(s.depthLoadOp=Ne.LOAD),e&n.STENCIL||(s.stencilLoadOp=Ne.LOAD),s.beginAccesses=[Pe.DEPTH_STENCIL_ATTACHMENT_WRITE]);var a=new Qe([r],s);return t=i.createRenderPass(a),this._renderPasses.set(e,t),t},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=A(Ma),i=b.getSampler(e,t);return this._descriptorSet.bindSampler(Se,i),this._descriptorSet.bindTexture(Se,k.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ke,i),this._descriptorSet.bindTexture(ke,k.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(ve.BINDING).destroy(),this._descriptorSet.getBuffer(pe.BINDING).destroy(),this._descriptorSet.getBuffer(me.BINDING).destroy(),this._descriptorSet.getSampler(Se).destroy(),this._descriptorSet.getSampler(ke).destroy(),this._descriptorSet.getTexture(Se).destroy(),this._descriptorSet.getTexture(ke).destroy())},i.destroy=function(){this.destroyUBOs();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},t}(zn),Sa=oe((ma=Ea).prototype,"renderTextures",[pa,ue,ga],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),va=ma))||va)),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT",e[e.POSTPROCESS=19]="POSTPROCESS",e[e.UI=20]="UI"}(Ta||(Ta={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.GBUFFER=1]="GBUFFER",e[e.LIGHTING=5]="LIGHTING",e[e.UI=10]="UI"}(wa||(wa={}));var xa,Ua,Ha,Ga,za,ka,Va,Wa,Ka,Ya,Qa,qa,Xa,ja,Za,Ja,$a,eo,to,io,no,ro,so,ao,oo,ho,uo,co,_o,lo,fo,po,go,vo,mo,So,Eo=[new l(0,0,0,0),new l(0,0,0,0),new l(0,0,0,0),new l(0,0,0,0)],To=e("J",(ya=ae("GbufferStage"),Oa=_e([ms]),Ia=ce(),ya((Da=Ra=function(e){function t(){var t;return t=e.call(this)||this,he(t,"renderQueues",Fa,ie(t)),t._renderQueues=[],t._renderArea=new Ae,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=v("deferred"),t._batchedQueue=new As,t._instancedQueue=new bs,t}$(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=ws(this.renderQueues[n])},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(ys);var r=t.pipelineSceneData.renderObjects;if(0!==r.length){for(var s=0,a=0,o=0,h=0;h<r.length;++h){var u=r[h],c=u.model.subModels;for(s=0;s<c.length;++s){var _=c[s],l=_.passes;for(a=0;a<l.length;++a){var d=l[a];if(d.phase===this._phaseID){var f=d.batchingScheme;if(f===p.INSTANCING){var g=jt.get(d);g.merge(_,u.model.instancedAttributes,a),this._instancedQueue.queue.add(g)}else if(f===p.VB_MERGING){var v=Fs.get(d);v.merge(_,a,u.model),this._batchedQueue.queue.add(v)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(u,s,a)}}}}this._renderQueues.forEach(Os);var m=t.commandBuffers[0];if(this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._renderArea=t.generateRenderArea(e),t.updateQuadVertexData(this._renderArea),e.clearFlag&n.COLOR)if(t.pipelineSceneData.isHDR){Is(Eo[0],e.clearColor);var S=t.pipelineSceneData.fpScale/e.exposure;Eo[0].x*=S,Eo[0].y*=S,Eo[0].z*=S}else Eo[0].x=e.clearColor.x,Eo[0].y=e.clearColor.y,Eo[0].z=e.clearColor.z;Eo[0].w=e.clearColor.w;var E=t.getDeferredRenderData(e).gbufferFrameBuffer,T=E.renderPass;m.beginRenderPass(T,E,this._renderArea,Eo,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Ue.GLOBAL,t.descriptorSet);for(var w=0;w<this.renderQueues.length;w++)this._renderQueues[w].recordCommandBuffer(i,T,m);this._instancedQueue.recordCommandBuffer(i,T,m),this._batchedQueue.recordCommandBuffer(i,T,m),m.endRenderPass()}},t}(Ki),Ra.initInfo={name:"GbufferStage",priority:Ta.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:fs.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:fs.BACK_TO_FRONT,stages:["default"]}]},Fa=oe((ba=Da).prototype,"renderQueues",[Oa,ue,Ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Aa=ba))||Aa)),wo=e("I",ae("GbufferFlow")((Ha=Ua=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new To;i.initialize(To.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(Yi),Ua.initInfo={name:Ze,priority:wa.GBUFFER,stages:[]},xa=Ha))||xa),yo=[new l(0,0,0,1)],Oo=e("O",(Ga=ae("LightingStage"),za=_e(ne),ka=ce(),Va=_e([ms]),Wa=ce(),Ga((ja=Xa=function(e){function i(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._deferredLitsBufs=null,t._maxDeferredLights=Je.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new Ae,he(t,"_deferredMaterial",Qa,ie(t)),he(t,"renderQueues",qa,ie(t)),t._phaseID=v("default"),t._defPhaseID=v("deferred"),t._renderQueues=[],t}$(i,e);var r=i.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.gatherLights=function(e){for(var i=this._pipeline,n=i.commandBuffers[0],r=e.scene.sphereLights,s=e.scene.spotLights,a=le.create(0,0,0,1),o=new Float32Array(4),h=e.exposure,u=0,c=z.length,_=c*this._maxDeferredLights,l=0;l<r.length&&u<this._maxDeferredLights;l++,++u){var d=r[l];if(le.set(a,d.position.x,d.position.y,d.position.z,d.range),fe.sphereFrustum(a,e.frustum)){if(t.toArray(o,d.position),o[3]=0,this._lightBufferData.set(o,u*c),t.toArray(o,d.color),d.useColorTemperature){var f=d.colorTemperatureRGB;o[0]*=f.x,o[1]*=f.y,o[2]*=f.z}i.pipelineSceneData.isHDR?o[3]=d.luminance*i.pipelineSceneData.fpScale*this._lightMeterScale:o[3]=d.luminance*h*this._lightMeterScale,this._lightBufferData.set(o,u*c+1*_),o[0]=d.size,o[1]=d.range,o[2]=0,this._lightBufferData.set(o,u*c+2*_)}}for(var p=0;p<s.length&&u<this._maxDeferredLights;p++,++u){var g=s[p];if(le.set(a,g.position.x,g.position.y,g.position.z,g.range),fe.sphereFrustum(a,e.frustum)){if(t.toArray(o,g.position),o[3]=1,this._lightBufferData.set(o,u*c+0*_),t.toArray(o,g.color),g.useColorTemperature){var v=g.colorTemperatureRGB;o[0]*=v.x,o[1]*=v.y,o[2]*=v.z}i.pipelineSceneData.isHDR?o[3]=g.luminance*i.pipelineSceneData.fpScale*this._lightMeterScale:o[3]=g.luminance*h*this._lightMeterScale,this._lightBufferData.set(o,u*c+1*_),o[0]=g.size,o[1]=g.range,o[2]=g.spotAngle,this._lightBufferData.set(o,u*c+2*_),t.toArray(o,g.direction),this._lightBufferData.set(o,u*c+3*_)}}var m=3*_+3;this._lightBufferData.set([u],m),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},r.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=ws(this.renderQueues[r]);var s=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;s=Math.ceil(s/n.capabilities.uboOffsetAlignment)*n.capabilities.uboOffsetAlignment,this._deferredLitsBufs=n.createBuffer(new P(L.UNIFORM|L.TRANSFER_DST,B.HOST|B.DEVICE,s,n.capabilities.uboOffsetAlignment));var a=n.createBuffer(new ze(this._deferredLitsBufs,0,s));this._lightBufferData=new Float32Array(s/Float32Array.BYTES_PER_ELEMENT);var o=new ye($e.bindings);this._descriptorSetLayout=n.createDescriptorSetLayout(o),this._descriptorSet=n.createDescriptorSet(new R(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Ge.BINDING,a),this._planarQueue=new ea(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},r.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},r.render=function(e){var t=this._pipeline,i=t.device,r=t.commandBuffers[0],s=t.pipelineSceneData,a=s.renderObjects;if(0!==a.length){if(this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,r),r.bindDescriptorSet(Ue.LOCAL,this._descriptorSet,[0]),this._renderArea=t.generateRenderArea(e),e.clearFlag&n.COLOR)if(s.isHDR){Is(yo[0],e.clearColor);var o=s.fpScale/e.exposure;yo[0].x*=o,yo[0].y*=o,yo[0].z*=o}else yo[0].x=e.clearColor.x,yo[0].y=e.clearColor.y,yo[0].z=e.clearColor.z;yo[0].w=0;var h=t.getDeferredRenderData(e).lightingFrameBuffer,u=h.renderPass;r.beginRenderPass(u,h,this._renderArea,yo,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Ue.GLOBAL,t.descriptorSet);var c=s.deferredLightingMaterial.passes[0],_=c.getShaderVariant();r.bindDescriptorSet(Ue.MATERIAL,c.descriptorSet);var l=t.quadIAOffscreen,d=null;null!=c&&null!=_&&null!=l&&(d=ds.getOrCreatePipelineState(i,c,_,u,l)),null!=d&&(r.bindPipelineState(d),r.bindInputAssembler(l),r.draw(l)),this._renderQueues.forEach(ys);for(var f=0,p=0,g=0,v=0;v<a.length;++v){var m=a[v],S=m.model.subModels;for(f=0;f<S.length;++f){var E=S[f].passes;for(p=0;p<E.length;++p){var T=E[p];if(T.phase===this._phaseID||T.phase===this._defPhaseID)for(g=0;g<this._renderQueues.length;g++)this._renderQueues[g].insertRenderPass(m,f,p)}}}this._renderQueues.forEach(Os);for(var w=0;w<this._renderQueues.length;w++)this._renderQueues[w].recordCommandBuffer(i,u,r);this._planarQueue.recordCommandBuffer(i,u,r),r.endRenderPass()}},i}(Ki),Xa.initInfo={name:"LightingStage",priority:Ta.LIGHTING,tag:0},Qa=oe((Ya=ja).prototype,"_deferredMaterial",[za,ue,ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qa=oe(Ya.prototype,"renderQueues",[Va,ue,Wa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ka=Ya))||Ka)),Io=e("N",ae("LightingFlow")(($a=Ja=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Oo;i.initialize(Oo.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(Yi),Ja.initInfo={name:et,priority:wa.LIGHTING,stages:[]},Za=$a))||Za),Ao=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var i=t.prototype;return i.onGlobalPipelineStateChanged=function(){this.updateDeferredPassInfo()},i.initPipelinePassInfo=function(){var e=new ne;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new ne;i._uuid="builtin-post-process-material",i.initialize({effectName:"post-process"});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._deferredPostMaterial=i,this.updateDeferredPassInfo()},i.activate=function(t,i){return e.prototype.activate.call(this,t,i),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass(),this.updateDeferredPostPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i.updateDeferredPostPass=function(){if(this.deferredPostMaterial){var e=this.deferredPostMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},c(t,[{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updateDeferredPassInfo())}},{key:"deferredPostMaterial",get:function(){return this._deferredPostMaterial},set:function(e){this._deferredPostMaterial!==e&&e&&(this._deferredPostMaterial=e,this.updateDeferredPassInfo())}}]),t}(Ca),bo=[O.POINT,O.POINT,O.NONE,I.CLAMP,I.CLAMP,I.CLAMP],Fo=A(bo),Ro=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Do=function(){this.gbufferFrameBuffer=null,this.gbufferRenderTargets=[],this.lightingFrameBuffer=null,this.lightingRenderTargets=[],this.depthTex=null},No=(e("H",(eo=ae("DeferredPipeline"),to=_e([ps]),io=ce(),eo((ao=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._deferredRenderData=null,t._gbufferRenderPass=null,t._lightingRenderPass=null,t._width=0,t._height=0,t._lastUsedRenderArea=new Ae,he(t,"renderTextures",so,ie(t)),t._renderPasses=new Map,t}$(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new Ba;i.initialize(Ba.initInfo),this._flows.push(i);var n=new wo;n.initialize(wo.initInfo),this._flows.push(n);var r=new Io;r.initialize(Io.initInfo),this._flows.push(r)}return!0},i.activate=function(){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new Ao,!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(D(2402),1))},i.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this._pipelineUBO.updateGlobalUBO();for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){Tn(this,i),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i)}}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},i.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,r=new Ke,s=new Ye;r.format=i.colorFormat,s.format=i.depthStencilFormat,s.stencilStoreOp=De.DISCARD,s.depthStoreOp=De.DISCARD,e&n.COLOR||(e&Kt?r.loadOp=Ne.DISCARD:(r.loadOp=Ne.LOAD,r.beginAccesses=[Pe.PRESENT])),(e&n.DEPTH_STENCIL)!==n.DEPTH_STENCIL&&(e&n.DEPTH||(s.depthLoadOp=Ne.LOAD),e&n.STENCIL||(s.stencilLoadOp=Ne.LOAD),s.beginAccesses=[Pe.DEPTH_STENCIL_ATTACHMENT_WRITE]);var a=new Qe([r],s);return t=i.createRenderPass(a),this._renderPasses.set(e,t),t},i.getDeferredRenderData=function(){return this._deferredRenderData||this._generateDeferredRenderData(),this._deferredRenderData},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=b.getSampler(e,Fo);this._descriptorSet.bindSampler(Se,t),this._descriptorSet.bindTexture(Se,k.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ke,t),this._descriptorSet.bindTexture(ke,k.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new Ro;if(!(i=this.createQuadInputAssembler(s.IDENTITY)).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var n=this.createQuadInputAssembler(e.surfaceTransform);if(!n.quadIB||!n.quadVB||!n.quadIA)return!1;if(this._quadVBOnscreen=n.quadVB,this._quadIAOnscreen=n.quadIA,!this._gbufferRenderPass){var r=new Ke;r.format=T.RGBA16F,r.loadOp=Ne.CLEAR,r.storeOp=De.STORE;var a=new Ke;a.format=T.RGBA16F,a.loadOp=Ne.CLEAR,a.storeOp=De.STORE;var o=new Ke;o.format=T.RGBA16F,o.loadOp=Ne.CLEAR,o.storeOp=De.STORE;var h=new Ke;h.format=T.RGBA16F,h.loadOp=Ne.CLEAR,h.storeOp=De.STORE;var u=new Ye;u.format=e.depthStencilFormat,u.depthLoadOp=Ne.CLEAR,u.depthStoreOp=De.STORE,u.stencilLoadOp=Ne.CLEAR,u.stencilStoreOp=De.STORE;var c=new Qe([r,a,o,h],u);this._gbufferRenderPass=e.createRenderPass(c)}if(!this._lightingRenderPass){var _=new Ke;_.format=T.RGBA8,_.loadOp=Ne.CLEAR,_.storeOp=De.STORE,_.endAccesses=[Pe.COLOR_ATTACHMENT_WRITE];var l=new Ye;l.format=e.depthStencilFormat,l.depthLoadOp=Ne.LOAD,l.depthStoreOp=De.DISCARD,l.stencilLoadOp=Ne.LOAD,l.stencilStoreOp=De.DISCARD,l.beginAccesses=[Pe.DEPTH_STENCIL_ATTACHMENT_WRITE],l.endAccesses=[Pe.DEPTH_STENCIL_ATTACHMENT_WRITE];var d=new Qe([_],l);this._lightingRenderPass=e.createRenderPass(d)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},i.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(ve.BINDING).destroy(),this._descriptorSet.getBuffer(pe.BINDING).destroy(),this._descriptorSet.getBuffer(me.BINDING).destroy(),this._descriptorSet.getSampler(Se).destroy(),this._descriptorSet.getSampler(ke).destroy(),this._descriptorSet.getTexture(Se).destroy(),this._descriptorSet.getTexture(ke).destroy())},i.destroyDeferredData=function(){var e=this._deferredRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.lightingFrameBuffer&&e.lightingFrameBuffer.destroy(),e.depthTex&&e.depthTex.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.lightingRenderTargets.length;i++)e.lightingRenderTargets[i].destroy();e.lightingRenderTargets.length=0}this._deferredRenderData=null},i.destroy=function(){this.destroyUBOs(),this.destroyQuadInputAssembler(),this.destroyDeferredData();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i.resize=function(e,t){this._width===e&&this._height===t||(this._width=e,this._height=t,this.destroyDeferredData(),this._generateDeferredRenderData())},i.createQuadInputAssembler=function(){var e=new Ro,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,n=this._device.createBuffer(new P(L.VERTEX|L.TRANSFER_DST,B.HOST|B.DEVICE,i,t));if(!n)return e;var r=Uint8Array.BYTES_PER_ELEMENT,s=6*r,a=this._device.createBuffer(new P(L.INDEX|L.TRANSFER_DST,B.HOST|B.DEVICE,s,r));if(!a)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,a.update(o);var h=new Array(2);h[0]=new C("a_position",T.RG32F),h[1]=new C("a_texCoord",T.RG32F);var u=this._device.createInputAssembler(new M(h,[n],a));return e.quadIB=a,e.quadVB=n,e.quadIA=u,e},i.updateQuadVertexData=function(e){if(this._lastUsedRenderArea!==e){this._lastUsedRenderArea=e;var t=this.genQuadVertexData(s.IDENTITY,e);this._quadVBOffscreen.update(t);var i=this.genQuadVertexData(this.device.surfaceTransform,e);this._quadVBOnscreen.update(i)}},i.genQuadVertexData=function(e,t){var i=new Float32Array(16),n=t.x/this.device.width,r=(t.x+t.width)/this.device.width,a=t.y/this.device.height,o=(t.y+t.height)/this.device.height;if(this.device.capabilities.screenSpaceSignY>0){var h=o;o=a,a=h}var u=0;switch(e){case s.IDENTITY:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=o,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=o,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=a;break;case s.ROTATE_90:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=o,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=o,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=a;break;case s.ROTATE_180:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=o,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=o;break;case s.ROTATE_270:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=o,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=o}return i},i.destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},i._generateDeferredRenderData=function(){var e=this.device,t=this._deferredRenderData=new Do;t.gbufferRenderTargets.push(e.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,T.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,T.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,T.RGBA16F,this._width,this._height))),t.gbufferRenderTargets.push(e.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,T.RGBA16F,this._width,this._height))),t.depthTex=e.createTexture(new m(S.TEX2D,E.DEPTH_STENCIL_ATTACHMENT,e.depthStencilFormat,this._width,this._height)),t.gbufferFrameBuffer=e.createFramebuffer(new qe(this._gbufferRenderPass,t.gbufferRenderTargets,t.depthTex)),t.lightingRenderTargets.push(e.createTexture(new m(S.TEX2D,E.COLOR_ATTACHMENT|E.SAMPLED,T.RGBA8,this._width,this._height))),t.lightingFrameBuffer=e.createFramebuffer(new qe(this._lightingRenderPass,t.lightingRenderTargets,t.depthTex)),this._descriptorSet.bindTexture(tt,t.gbufferFrameBuffer.colorTextures[0]),this._descriptorSet.bindTexture(it,t.gbufferFrameBuffer.colorTextures[1]),this._descriptorSet.bindTexture(nt,t.gbufferFrameBuffer.colorTextures[2]),this._descriptorSet.bindTexture(rt,t.gbufferFrameBuffer.colorTextures[3]),this._descriptorSet.bindTexture(st,t.lightingFrameBuffer.colorTextures[0]);var i=b.getSampler(e,Fo);this._descriptorSet.bindSampler(tt,i),this._descriptorSet.bindSampler(it,i),this._descriptorSet.bindSampler(nt,i),this._descriptorSet.bindSampler(rt,i),this._descriptorSet.bindSampler(st,i)},c(t,[{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}}]),t}(zn),so=oe((ro=ao).prototype,"renderTextures",[to,ue,io],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),no=ro))||no)),[new l(0,0,0,1)]),Po=(e("Q",(oo=ae("PostprocessStage"),ho=_e(ne),uo=ce(),co=_e([ms]),_o=ce(),oo((mo=vo=function(e){function t(){var t;return t=e.call(this)||this,he(t,"_postProcessMaterial",po,ie(t)),he(t,"renderQueues",go,ie(t)),t._renderArea=new Ae,t._uiPhase=void 0,t._uiPhase=new ta,t}$(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._uiPhase.activate(t),this._postProcessMaterial&&(t.pipelineSceneData.deferredPostMaterial=this._postProcessMaterial)},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.device,r=t.pipelineSceneData,s=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var a=e.viewport;this._renderArea.x=a.x*e.width,this._renderArea.y=a.y*e.height,this._renderArea.width=a.width*e.width*r.shadingScale,this._renderArea.height=a.height*e.height*r.shadingScale;var o=e.window.framebuffer,h=o.colorTextures[0]?o.renderPass:t.getRenderPass(e.clearFlag);e.clearFlag&n.COLOR&&(No[0].x=e.clearColor.x,No[0].y=e.clearColor.y,No[0].z=e.clearColor.z),No[0].w=e.clearColor.w,s.beginRenderPass(h,o,this._renderArea,No,e.clearDepth,e.clearStencil),s.bindDescriptorSet(Ue.GLOBAL,t.descriptorSet);var u=r.deferredPostMaterial.passes[0],c=u.getShaderVariant();s.bindDescriptorSet(Ue.MATERIAL,u.descriptorSet);var _=e.window.hasOffScreenAttachments?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=u&&null!=c&&null!=_&&(l=ds.getOrCreatePipelineState(i,u,c,h,_));var d=t.pipelineSceneData.renderObjects;null!=l&&d.length>0&&(s.bindPipelineState(l),s.bindInputAssembler(_),s.draw(_)),this._uiPhase.render(e,h),s.endRenderPass()},t}(Ki),vo.initInfo={name:"PostprocessStage",priority:Ta.POSTPROCESS,tag:0},po=oe((fo=mo).prototype,"_postProcessMaterial",[ho,ue,uo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),go=oe(fo.prototype,"renderQueues",[co,ue,_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lo=fo))||lo)),function(){function e(){this.support=void 0,this._isStarted=!1,this._accelMode="normal",this._eventTarget=new at,this._didAccelerateFunc=void 0,this.support=!0,this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){ot.onAccelerometerChange(this._didAccelerateFunc)},t._unregisterEvent=function(){ot.offAccelerometerChange(this._didAccelerateFunc)},t._didAccelerate=function(e){var t={type:ht.DEVICEMOTION,x:e.x,y:e.y,z:e.z,timestamp:performance.now()};this._eventTarget.emit(ht.DEVICEMOTION,t)},t.start=function(){var e=this;this._registerEvent(),ot.startAccelerometer({interval:this._accelMode,success:function(){e._isStarted=!0}})},t.stop=function(){var e=this;ot.stopAccelerometer({success:function(){e._isStarted=!1},fail:function(){console.error("failed to stop accelerometer")}}),this._unregisterEvent()},t.setInterval=function(e){this._accelMode=e>=200?"normal":e>=60?"ui":"game",this._isStarted&&(this.stop(),this.start())},t.onChange=function(e){this._eventTarget.on(ht.DEVICEMOTION,e)},e}()),Lo=function(){function e(){this.support=void 0,this.support=!0}var t=e.prototype;return t.show=function(){throw new Error("Method not implemented.")},t.hide=function(){throw new Error("Method not implemented.")},t.onChange=function(){throw new Error("Method not implemented.")},t.onComplete=function(){throw new Error("Method not implemented.")},t.offChange=function(){throw new Error("Method not implemented.")},t.offComplete=function(){throw new Error("Method not implemented.")},e}();!function(e){e[e.NONE=0]="NONE",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(So||(So=e("K",{})));var Bo={Backspace:So.BACKSPACE,Tab:So.TAB,Enter:So.ENTER,ShiftLeft:So.SHIFT_LEFT,ControlLeft:So.CTRL_LEFT,AltLeft:So.ALT_LEFT,ShiftRight:So.SHIFT_RIGHT,ControlRight:So.CTRL_RIGHT,AltRight:So.ALT_RIGHT,Pause:So.PAUSE,CapsLock:So.CAPS_LOCK,Escape:So.ESCAPE,Space:So.SPACE,PageUp:So.PAGE_UP,PageDown:So.PAGE_DOWN,End:So.END,Home:So.HOME,ArrowLeft:So.ARROW_LEFT,ArrowUp:So.ARROW_UP,ArrowRight:So.ARROW_RIGHT,ArrowDown:So.ARROW_DOWN,Insert:So.INSERT,Delete:So.DELETE,Digit0:So.DIGIT_0,Digit1:So.DIGIT_1,Digit2:So.DIGIT_2,Digit3:So.DIGIT_3,Digit4:So.DIGIT_4,Digit5:So.DIGIT_5,Digit6:So.DIGIT_6,Digit7:So.DIGIT_7,Digit8:So.DIGIT_8,Digit9:So.DIGIT_9,KeyA:So.KEY_A,KeyB:So.KEY_B,KeyC:So.KEY_C,KeyD:So.KEY_D,KeyE:So.KEY_E,KeyF:So.KEY_F,KeyG:So.KEY_G,KeyH:So.KEY_H,KeyI:So.KEY_I,KeyJ:So.KEY_J,KeyK:So.KEY_K,KeyL:So.KEY_L,KeyM:So.KEY_M,KeyN:So.KEY_N,KeyO:So.KEY_O,KeyP:So.KEY_P,KeyQ:So.KEY_Q,KeyR:So.KEY_R,KeyS:So.KEY_S,KeyT:So.KEY_T,KeyU:So.KEY_U,KeyV:So.KEY_V,KeyW:So.KEY_W,KeyX:So.KEY_X,KeyY:So.KEY_Y,KeyZ:So.KEY_Z,Numpad0:So.NUM_0,Numpad1:So.NUM_1,Numpad2:So.NUM_2,Numpad3:So.NUM_3,Numpad4:So.NUM_4,Numpad5:So.NUM_5,Numpad6:So.NUM_6,Numpad7:So.NUM_7,Numpad8:So.NUM_8,Numpad9:So.NUM_9,NumpadMultiply:So.NUM_MULTIPLY,NumpadAdd:So.NUM_PLUS,NumpadSubtract:So.NUM_SUBTRACT,NumpadDecimal:So.NUM_DECIMAL,NumpadDivide:So.NUM_DIVIDE,NumpadEnter:So.NUM_ENTER,F1:So.F1,F2:So.F2,F3:So.F3,F4:So.F4,F5:So.F5,F6:So.F6,F7:So.F7,F8:So.F8,F9:So.F9,F10:So.F10,F11:So.F11,F12:So.F12,NumLock:So.NUM_LOCK,ScrollLock:So.SCROLL_LOCK,Semicolon:So.SEMICOLON,Equal:So.EQUAL,Comma:So.COMMA,Minus:So.DASH,Period:So.PERIOD,Slash:So.SLASH,Backquote:So.BACK_QUOTE,BracketLeft:So.BRACKET_LEFT,Backslash:So.BACKSLASH,BracketRight:So.BRACKET_RIGHT,Quote:So.QUOTE};function Co(e){return Bo[e]||So.NONE}var Mo=function(){function e(){this.support=void 0,this._eventTarget=new at,this._keyStateMap={},this.support="object"==typeof ot.wx&&void 0!==ot.wx.onKeyDown,this.support&&this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e,t,i,n,r=this;null===(e=ot.wx)||void 0===e||null===(t=e.onKeyDown)||void 0===t||t.call(e,(function(e){var t=Co(e.code);if(!r._keyStateMap[t]){var i=r._getInputEvent(e,ht.KEY_DOWN);r._eventTarget.emit(ht.KEY_DOWN,i)}var n=r._getInputEvent(e,ht.KEY_DOWN);r._eventTarget.emit(ht.KEY_DOWN,n),r._keyStateMap[t]=!0})),null===(i=ot.wx)||void 0===i||null===(n=i.onKeyUp)||void 0===n||n.call(i,(function(e){var t=Co(e.code),i={code:t,type:ht.KEY_UP,timestamp:performance.now()};r._keyStateMap[t]=!1,r._eventTarget.emit(ht.KEY_UP,i)}))},t._getInputEvent=function(e,t){return{type:t,code:Co(e.code),timestamp:performance.now()}},t.onDown=function(e){this._eventTarget.on("keypress",e)},t.onPressing=function(e){this._eventTarget.on(ht.KEY_DOWN,e)},t.onUp=function(e){this._eventTarget.on(ht.KEY_UP,e)},e}(),xo=function(){function e(){this.support=void 0,this._eventTarget=new at,this._isPressed=!1,this._preMousePos=new de,this.support="object"==typeof ot.wx&&void 0!==ot.wx.onMouseDown,this.support&&this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e,t,i,n,r,s,a,o,h=this;null===(e=ot.wx)||void 0===e||null===(t=e.onMouseDown)||void 0===t||t.call(e,this._createCallback(ht.MOUSE_DOWN)),null===(i=ot.wx)||void 0===i||null===(n=i.onMouseMove)||void 0===n||n.call(i,this._createCallback(ht.MOUSE_MOVE)),null===(r=ot.wx)||void 0===r||null===(s=r.onMouseUp)||void 0===s||s.call(r,this._createCallback(ht.MOUSE_UP)),null===(a=ot.wx)||void 0===a||null===(o=a.onWheel)||void 0===o||o.call(a,(function(e){var t=ot.getSystemInfoSync(),i={type:ht.MOUSE_WHEEL,x:e.x,y:t.screenHeight-e.y,button:e.button,deltaX:e.deltaX,deltaY:e.deltaY,timestamp:performance.now()};h._eventTarget.emit(ht.MOUSE_WHEEL,i)}))},t._createCallback=function(e){var t=this;return function(i){var n=ot.getSystemInfoSync(),r=i.button;switch(e){case ht.MOUSE_DOWN:t._isPressed=!0;break;case ht.MOUSE_UP:t._isPressed=!1;break;case ht.MOUSE_MOVE:t._isPressed||(r=-1)}var s=i.x,a=n.screenHeight-i.y,o={type:e,x:s,y:a,movementX:s-t._preMousePos.x,movementY:t._preMousePos.y-a,button:r,timestamp:performance.now()};t._preMousePos.set(o.x,o.y),t._eventTarget.emit(e,o)}},t.onDown=function(e){this._eventTarget.on(ht.MOUSE_DOWN,e)},t.onMove=function(e){this._eventTarget.on(ht.MOUSE_MOVE,e)},t.onUp=function(e){this._eventTarget.on(ht.MOUSE_UP,e)},t.onWheel=function(e){this._eventTarget.on(ht.MOUSE_WHEEL,e)},e}(),Uo=function(){function e(){this.support=void 0,this._eventTarget=new at,this.support=!0,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){ot.onTouchStart(this._createCallback(ht.TOUCH_START)),ot.onTouchMove(this._createCallback(ht.TOUCH_MOVE)),ot.onTouchEnd(this._createCallback(ht.TOUCH_END)),ot.onTouchCancel(this._createCallback(ht.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(i){for(var n=ot.getSystemInfoSync(),r=[],s=i.changedTouches.length,a=0;a<s;++a){var o=i.changedTouches[a],h=t._getLocation(o),u={identifier:o.identifier,x:h.x,y:n.windowHeight-h.y,force:o.force};r.push(u)}var c={type:e,changedTouches:r,timestamp:performance.now()};t._eventTarget.emit(e,c)}},t._getLocation=function(e){return new de(e.clientX,e.clientY)},t.onStart=function(e){this._eventTarget.on(ht.TOUCH_START,e)},t.onMove=function(e){this._eventTarget.on(ht.TOUCH_MOVE,e)},t.onEnd=function(e){this._eventTarget.on(ht.TOUCH_END,e)},t.onCancel=function(e){this._eventTarget.on(ht.TOUCH_CANCEL,e)},e}(),Ho=new(function(){function e(){this._touch=new Uo,this._mouse=new xo,this._keyboard=new Mo,this._accelerometer=new Po,this._inputBox=new Lo,this._touchEvents=[],this._mouseEvents=[],this._keyboardEvents=[],this._accelerometerEvents=[],this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){if(this._touch.support){var e=this._touchEvents;this._touch.onStart((function(t){e.push(t)})),this._touch.onMove((function(t){e.push(t)})),this._touch.onEnd((function(t){e.push(t)})),this._touch.onCancel((function(t){e.push(t)}))}if(this._mouse.support){var t=this._mouseEvents;this._mouse.onDown((function(e){t.push(e)})),this._mouse.onMove((function(e){t.push(e)})),this._mouse.onUp((function(e){t.push(e)})),this._mouse.onWheel((function(e){t.push(e)}))}if(this._keyboard.support){var i=this._keyboardEvents;this._keyboard.onPressing((function(e){i.push(e)})),this._keyboard.onUp((function(e){i.push(e)}))}if(this._accelerometer.support){var n=this._accelerometerEvents;this._accelerometer.onChange((function(e){n.push(e)}))}},t.startAccelerometer=function(){this._accelerometer.start()},t.stopAccelerometer=function(){this._accelerometer.stop()},t.setAccelerometerInterval=function(e){this._accelerometer.setInterval(e)},t.pollTouchEvents=function(){var e=ut.array.copy(this._touchEvents);return this._touchEvents.length=0,e},t.pollMouseEvents=function(){var e=ut.array.copy(this._mouseEvents);return this._mouseEvents.length=0,e},t.pollKeyboardEvents=function(){var e=ut.array.copy(this._keyboardEvents);return this._keyboardEvents.length=0,e},t.pollAccelerometerEvents=function(){var e=ut.array.copy(this._accelerometerEvents);return this._accelerometerEvents.length=0,e},e}()),Go=new de,zo=e("E",function(e){function t(i,n,r){var s;return(s=e.call(this,i,n)||this).movementX=0,s.movementY=0,s._eventType=void 0,s._button=t.BUTTON_MISSING,s._x=0,s._y=0,s._prevX=0,s._prevY=0,s._scrollX=0,s._scrollY=0,s._eventType=i,r&&(s._prevX=r.x,s._prevY=r.y),s}$(t,e);var i=t.prototype;return i.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},i.getScrollX=function(){return this._scrollX},i.getScrollY=function(){return this._scrollY},i.setLocation=function(e,t){this._x=e,this._y=t},i.getLocation=function(e){return e||(e=new de),de.set(e,this._x,this._y),e},i.getLocationInView=function(e){return e||(e=new de),de.set(e,this._x,a.view._designResolutionSize.height-this._y),e},i.getUILocation=function(e){return e||(e=new de),de.set(e,this._x,this._y),a.view._convertPointWithScale(e),e},i.getPreviousLocation=function(e){return e||(e=new de),de.set(e,this._prevX,this._prevY),e},i.getUIPreviousLocation=function(e){return e||(e=new de),de.set(e,this._prevX,this._prevY),a.view._convertPointWithScale(e),e},i.getDelta=function(e){return e||(e=new de),de.set(e,this._x-this._prevX,this._y-this._prevY),e},i.getDeltaX=function(){return this._x-this._prevX},i.getDeltaY=function(){return this._y-this._prevY},i.getUIDelta=function(e){return e||(e=new de),de.set(e,(this._x-this._prevX)/a.view.getScaleX(),(this._y-this._prevY)/a.view.getScaleY()),e},i.getUIDeltaX=function(){return(this._x-this._prevX)/a.view.getScaleX()},i.getUIDeltaY=function(){return(this._y-this._prevY)/a.view.getScaleY()},i.setButton=function(e){this._button=e},i.getButton=function(){return this._button},i.getLocationX=function(){return this._x},i.getLocationY=function(){return this._y},i.getUILocationX=function(){var e=a.view.getViewportRect();return(this._x-e.x)/a.view.getScaleX()},i.getUILocationY=function(){var e=a.view.getViewportRect();return(this._y-e.y)/a.view.getScaleY()},c(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(ct));zo.BUTTON_MISSING=-1,zo.BUTTON_LEFT=0,zo.BUTTON_RIGHT=2,zo.BUTTON_MIDDLE=1,zo.BUTTON_4=3,zo.BUTTON_5=4,zo.BUTTON_6=5,zo.BUTTON_7=6,zo.BUTTON_8=7;var ko=e("r",function(e){function t(t,i,n,r){var s;return void 0===r&&(r=[]),(s=e.call(this,n,i)||this).touch=null,s.simulate=!1,s._eventCode=void 0,s._touches=void 0,s._allTouches=void 0,s._eventCode=n,s._touches=t||[],s._allTouches=r,s}$(t,e);var i=t.prototype;return i.getEventCode=function(){return this._eventCode},i.getTouches=function(){return this._touches},i.getAllTouches=function(){return this._allTouches},i.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},i.getLocation=function(e){return this.touch?this.touch.getLocation(e):new de},i.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new de},i.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new de},i.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new de},i.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new de},i.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new de},i.getID=function(){return this.touch?this.touch.getID():null},i.getDelta=function(e){return this.touch?this.touch.getDelta(e):new de},i.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new de},i.getDeltaX=function(){return this.touch?this.touch.getDelta(Go).x:0},i.getDeltaY=function(){return this.touch?this.touch.getDelta(Go).y:0},i.getLocationX=function(){return this.touch?this.touch.getLocationX():0},i.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(ct));ko.MAX_TOUCHES=5;var Vo=e("t",function(e){function t(t,i){var n;return(n=e.call(this,ht.DEVICEMOTION,i)||this).acc=void 0,n.acc=t,n}return $(t,e),t}(ct)),Wo=e("u",function(e){function t(t,i,n){var r;return"boolean"==typeof i&&(i=i?ht.KEY_DOWN:ht.KEY_UP),(r=e.call(this,i,n)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=i!==ht.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return $(t,e),c(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(ct));ct.EventMouse=zo,ct.EventTouch=ko,ct.EventAcceleration=Vo,ct.EventKeyboard=Wo;var Ko=new de,Yo=e("T",function(){function e(e,t,i){void 0===i&&(i=0),this._point=new de,this._prevPoint=new de,this._lastModified=0,this._id=0,this._startPoint=new de,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new de),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new de),e.set(this._point.x,this._point.y),a.view._convertPointWithScale(e),e},t.getUILocationX=function(){var e=a.view.getViewportRect();return(this._point.x-e.x)/a.view.getScaleX()},t.getUILocationY=function(){var e=a.view.getViewportRect();return(this._point.y-e.y)/a.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new de),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new de),e.set(this._prevPoint.x,this._prevPoint.y),a.view._convertPointWithScale(e),e},t.getStartLocation=function(e){return e||(e=new de),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new de),e.set(this._startPoint.x,this._startPoint.y),a.view._convertPointWithScale(e),e},t.getDelta=function(e){return e||(e=new de),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new de),Ko.set(this._point),Ko.subtract(this._prevPoint),e.set(a.view.getScaleX(),a.view.getScaleY()),de.divide(e,Ko,e),e},t.getLocationInView=function(e){return e||(e=new de),e.set(this._point.x,a.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new de),e.set(this._prevPoint.x,a.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new de),e.set(this._startPoint.x,a.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,i){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new de(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new de(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=a.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new de(e.x,e.y):new de(e||0,t||0),this._lastModified=a.game.frameStartTime},c(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());a.Touch=Yo;var Qo=function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n},qo=dt.TOUCH_TIMEOUT,Xo=new de,jo=new de,Zo=function(){function e(){this._preTouchPoint=new de,this._prevMousePoint=new de,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}var t=e.prototype;return t.clearEvents=function(){Ho.pollMouseEvents(),Ho.pollTouchEvents(),Ho.pollKeyboardEvents(),Ho.pollAccelerometerEvents()},t.frameDispatchEvents=function(){for(var e=Ho.pollMouseEvents(),t=0,i=e.length;t<i;++t){var n=e[t];this._dispatchMouseEvent(n)}for(var r=Ho.pollTouchEvents(),s=0,a=r.length;s<a;++s){var o=r[s];this._dispatchTouchEvent(o)}for(var h=Ho.pollKeyboardEvents(),u=0,c=h.length;u<c;++u){var _=h[u];this._dispatchKeyboardEvent(_)}for(var l=Ho.pollAccelerometerEvents(),d=0,f=l.length;d<f;++d){var p=l[d];this._dispatchAccelerometerEvent(p)}},t._dispatchMouseEvent=function(e){var t,i;switch(e.type){case ht.MOUSE_DOWN:t=this._getMouseEvent(e),i=this._getTouch(e),this._handleTouchesStart([i]),_t.dispatchEvent(t);break;case ht.MOUSE_MOVE:t=this._getMouseEvent(e),i=this._getTouch(e),this._handleTouchesMove([i]),_t.dispatchEvent(t);break;case ht.MOUSE_UP:t=this._getMouseEvent(e),i=this._getTouch(e),this._handleTouchesEnd([i]),_t.dispatchEvent(t);break;case ht.MOUSE_WHEEL:(t=this._getMouseEvent(e)).setScrollData(e.deltaX,e.deltaY),_t.dispatchEvent(t)}},t._dispatchTouchEvent=function(e){var t=this._getTouchList(e);switch(e.type){case ht.TOUCH_START:this._handleTouchesStart(t);break;case ht.TOUCH_MOVE:this._handleTouchesMove(t);break;case ht.TOUCH_END:this._handleTouchesEnd(t);break;case ht.TOUCH_CANCEL:this._handleTouchesCancel(t)}},t._handleTouchesStart=function(e){for(var t=[],i=this._touchesIntegerDict,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s&&void 0===i[s]){var a=this._getUnUsedIndex();if(-1===a){lt(2300,a);continue}r.getLocation(Xo);var o=new Yo(Xo.x,Xo.y,s);this._touches[a]=o,r.getPreviousLocation(Xo),o.setPrevPoint(Xo),i[s]=a,t.push(o)}}if(t.length>0){var h=new ko(t,!1,ht.TOUCH_START,dt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);_t.dispatchEvent(h)}},t._handleTouchesMove=function(e){for(var t=[],i=this._touches,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s){var a=this._touchesIntegerDict[s];void 0!==a&&i[a]&&(r.getLocation(Xo),i[a].setPoint(Xo),r.getPreviousLocation(Xo),i[a].setPrevPoint(Xo),t.push(i[a]))}}if(t.length>0){var o=new ko(t,!1,ht.TOUCH_MOVE,dt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);_t.dispatchEvent(o)}},t._handleTouchesEnd=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new ko(t,!1,ht.TOUCH_END,dt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);_t.dispatchEvent(i)}this._preTouchPool.length=0},t._handleTouchesCancel=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new ko(t,!1,ht.TOUCH_CANCEL,dt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);_t.dispatchEvent(i)}this._preTouchPool.length=0},t.getSetOfTouchesEndOrCancel=function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var s=e[r],a=s.getID();if(null!==a){var o=n[a];void 0!==o&&i[o]&&(s.getLocation(Xo),i[o].setPoint(Xo),s.getPreviousLocation(Xo),i[o].setPrevPoint(Xo),t.push(i[o]),this._removeUsedIndexBit(o),delete n[a])}}return t},t._getPreTouch=function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t},t._setPreTouch=function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))},t._getViewPixelRatio=function(){return this._glView||(this._glView=a.view),this._glView?this._glView._devicePixelRatio:1},t._getTouch=function(e){var t=this._preTouchPoint,i=this._getViewPixelRatio(),n=e.x*i,r=e.y*i,s=new Yo(n,r,0);return s.setPrevPoint(t.x,t.y),t.x=n,t.y=r,s},t._getMouseEvent=function(e){var t=this._prevMousePoint,i=new zo(e.type,!1,t),n=this._getViewPixelRatio();return t.x=e.x*n,t.y=e.y*n,a.GAME_VIEW&&(t.x/=a.gameView.canvas.width/a.game.canvas.width,t.y/=a.gameView.canvas.height/a.game.canvas.height),i.setLocation(t.x,t.y),i.setButton(e.button),e.movementX&&(i.movementX=e.movementX),e.movementY&&(i.movementY=e.movementY),i},t._getTouchList=function(e){for(var t=[],i=this._preTouchPoint,n=e.changedTouches.length,r=this._getViewPixelRatio(),s=0;s<n;s++){var a=e.changedTouches[s],o=a.x*r,h=a.y*r,u=new Yo(o,h,a.identifier);if(this._getPreTouch(u).getLocation(jo),u.setPrevPoint(jo.x,jo.y),this._setPreTouch(u),i.x=o,i.y=h,t.push(u),!dt.ENABLE_MULTI_TOUCH)break}return t},t._getUnUsedIndex=function(){for(var e=this._indexBitsUsed,t=a.game.frameStartTime,i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n.lastModified>qo){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1},t._removeUsedIndexBit=function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}},t._getUsefulTouches=function(){var e=[],t=this._touchesIntegerDict;for(var i in t){var n=t[parseInt(i)];if(null!=n){var r=this._touches[n];e.push(r)}}return e},t._dispatchKeyboardEvent=function(e){switch(e.type){case ht.KEY_DOWN:_t.dispatchEvent(new Wo(e.code,ht.KEY_DOWN));break;case ht.KEY_UP:_t.dispatchEvent(new Wo(e.code,ht.KEY_UP))}},t._dispatchAccelerometerEvent=function(e){if(e.type===ht.DEVICEMOTION){var t=e.x,i=e.y,n=e.z,r=e.timestamp;_t.dispatchEvent(new Vo(new Qo(t,i,n,r)))}},t.setAccelerometerEnabled=function(e){e?Ho.startAccelerometer():Ho.stopAccelerometer()},t.setAccelerometerInterval=function(e){Ho.setAccelerometerInterval(e)},e}(),Jo=e("Z",new Zo);a.internal.inputManager=Jo;var $o=e("G",function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t}$(t,e);var i=t.prototype;return i.setFrameRate=function(e){this.frameRate=e},i.getFrameRate=function(){return this.frameRate},i.step=function(){a.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(Jo.clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return a.director.once(a.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var i in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[i]);return a.director.getScene().destroy(),a.Object._deferredDestroy(),a.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){ft.close()},i.on=function(e,i,n,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&i.call(n),this.eventTargetOn(e,i,n,r)},i.once=function(e,i,n){return this._engineInited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)},i.init=function(e){var t=this;if(this._initConfig(e),this.config.assetOptions&&a.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,n=0;n<i.length;n++){var r=i[n],s=pt(r.value);U.addLayer(r.name,s)}return this._initEngine().then((function(){return t._initEvents(),a.director.root&&a.director.root.dataPoolManager&&a.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},i.run=function(e,t){var i,n=this;return"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,gt.init(),Promise.resolve(i).then((function(){return n._setRenderPipelineNShowSplash()}))},i.addPersistRootNode=function(e){if(a.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=a.director._scene;if(a.isValid(i))if(e.parent){if(!(e.parent instanceof a.Scene))return void vt(3801);if(e.parent!==i)return void vt(3802);e._originalSceneId=i.uuid}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0,a.assetManager._releaseManager._addPersistNodeRef(e)}}else vt(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",a.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},i._initEngine=function(){var e=this;return this._initDevice(),Promise.resolve(a.director._init()).then((function(){mt("Cocos Creator v"+St),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,a.internal.dynamicAtlasManager&&(a.internal.dynamicAtlasManager.enabled=!dt.CLEANUP_IMAGE_CACHE)}))},i._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(e){var t=performance.now(),i=Math.max(0,t-this._startTime),n=Math.max(0,this.frameTime-i);return window.setTimeout(e,n)},i._ctTime=function(e){window.clearTimeout(e)},i._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},i._updateCallback=function(){var e,t=this,i=a.director;if(30===this._frameRate){var n=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(n=!n)||i.tick(t._calculateDT(e))}}else e=function(e){i.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},i._runMainLoop=function(){if(this._inited&&!Et){var e=this.config,t=a.director;Tt(!!e.showFPS),t.startAnimation(),this.resume()}},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=wt.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,yt(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},i._determineRenderType=function(){var e=this.config,i=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?Ot.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):Ot.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&Ot.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&Ot.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(It(3820,i))},i._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var i=[],n=dt.ENABLE_WEBGL_ANTIALIAS,r=new At(this.canvas,n,!1,window.devicePixelRatio,Ot.windowPixelResolution.width,Ot.windowPixelResolution.height,bt),s=!!window.WebGL2RenderingContext,o=window.navigator.userAgent.toLowerCase();(-1!==o.indexOf("safari")&&-1===o.indexOf("chrome")||Ot.browserType===Ft.UC)&&(s=!1),s&&a.WebGL2Device&&i.push(a.WebGL2Device),a.WebGLDevice&&i.push(a.WebGLDevice);for(var h=0;h<i.length&&(this._gfxDevice=new i[h],!this._gfxDevice.initialize(r));h++);}if(!this._gfxDevice)return Rt("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){ft.on("show",this._onShow,this),ft.on("hide",this._onHide,this)},i._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,i){a.assetManager.loadAny(t,(function(t,n){return!t&&n instanceof zn?e(n):i(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(i){Dt(i),Dt("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(a.internal.SplashScreen){var e=a.internal.SplashScreen.instance;return e.main(a.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},i._setRenderPipeline=function(e){a.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},c(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(at));$o.EVENT_HIDE="game_on_hide",$o.EVENT_SHOW="game_on_show",$o.EVENT_LOW_MEMORY="game_on_low_memory",$o.EVENT_GAME_INITED="game_inited",$o.EVENT_ENGINE_INITED="engine_inited",$o.EVENT_RENDERER_INITED="renderer_inited",$o.EVENT_RESTART="game_on_restart",$o.RENDER_TYPE_CANVAS=0,$o.RENDER_TYPE_WEBGL=1,$o.RENDER_TYPE_OPENGL=2,$o.DEBUG_DT_THRESHOLD=1,a.Game=$o,e("w",a.game=new $o);var eh=e("_",{topLeft:a.v2(0,0),topRight:a.v2(0,0),top:a.v2(0,0),bottomLeft:a.v2(0,0),bottomRight:a.v2(0,0),bottom:a.v2(0,0),center:a.v2(0,0),left:a.v2(0,0),right:a.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,s=r+i,a=n+t;this.topLeft.x=n,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=n+t/2,this.top.y=s,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}});a.visibleRect=eh;var th=function(){function e(){}var t=e.prototype;return t.fullScreen=function(){return Nt.isFullScreen},t.requestFullScreen=function(e,t,i){return arguments.length>0&&vt(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Nt.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==i||i()}))},t.exitFullScreen=function(){return Nt.exitFullScreen()},t.autoFullScreen=function(e,t){var i;null===(i=this.requestFullScreen(e,t))||void 0===i||i.catch((function(){}))},t.disableAutoFullScreen=function(){},c(e,[{key:"supportsFullScreen",get:function(){return Nt.supportFullScreen}}]),e}(),ih=e("s",new th);a.screen=ih;var nh=new Pt,rh=e("p",function(e){function t(){var t;(t=e.call(this)||this)._resizeWithBrowserSize=void 0,t._designResolutionSize=void 0,t._frameSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._devicePixelRatio=void 0,t._maxPixelRatio=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resizing=void 0,t._orientationChanging=void 0,t._isRotated=void 0,t._orientation=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var i=sh,n=ah;return t._frameSize=new Pt(0,0),t._designResolutionSize=new Pt(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new d(0,0,0,0),t._visibleRect=new d(0,0,0,0),t._autoFullScreen=!1,t._devicePixelRatio=1,t._maxPixelRatio=2,t._retinaEnabled=!1,t._resizeCallback=null,t._resizing=!1,t._resizeWithBrowserSize=!1,t._orientationChanging=!0,t._isRotated=!1,t._orientation=a.macro.ORIENTATION_AUTO,t._rpExactFit=new oh(i.EQUAL_TO_FRAME,n.EXACT_FIT),t._rpShowAll=new oh(i.EQUAL_TO_FRAME,n.SHOW_ALL),t._rpNoBorder=new oh(i.EQUAL_TO_FRAME,n.NO_BORDER),t._rpFixedHeight=new oh(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),t._rpFixedWidth=new oh(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,a.game.once(a.Game.EVENT_ENGINE_INITED,t.init,ie(t)),t}$(t,e);var i=t.prototype;return i.init=function(){this._initFrameSize();var e=a.game.canvas.width,t=a.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,nh.width=this._visibleRect.width,nh.height=this._visibleRect.height,eh&&eh.init(this._visibleRect)},i.resizeWithBrowserSize=function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,Nt.on("window-resize",this._resizeEvent,this),Nt.on("orientation-change",this._orientationChange,this)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,Nt.off("window-resize",this._resizeEvent,this),Nt.off("orientation-change",this._orientationChange,this))},i.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},i.setOrientation=function(e){(e&=a.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)},i.adjustViewportMeta=function(){},i.enableRetina=function(e){this._retinaEnabled=!!e},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&ih.requestFullScreen().catch((function(){})))},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(e,t){var i=a.game.canvas,n=a.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=Ot.windowPixelResolution.width,i.height=Ot.windowPixelResolution.height,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()},i.getCanvasSize=function(){return new Pt(a.game.canvas.width,a.game.canvas.height)},i.getFrameSize=function(){return new Pt(this._frameSize.width,this._frameSize.height)},i.setFrameSize=function(e,t){this._frameSize.width=e,this._frameSize.height=t,a.game.frame.style.width=e+"px",a.game.frame.style.height=t+"px",this._resizeEvent()},i.getVisibleSize=function(){return new Pt(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new Pt(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new de(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new de(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i.setResolutionPolicy=function(e){if(e instanceof oh)this._resolutionPolicy=e;else{var t=oh;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},i.setDesignResolutionSize=function(e,t,i){if(e>0&&t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var s=this._viewportRect,a=this._visibleRect,o=r.viewport;s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,a.x=0,a.y=0,a.width=o.width/this._scaleX,a.height=o.height/this._scaleY}n.postApply(this),nh.width=this._visibleRect.width,nh.height=this._visibleRect.height,eh&&eh.init(this._visibleRect),this.emit("design-resolution-changed")}else lt(2201)}else D(2200)},i.getDesignResolutionSize=function(){return new Pt(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(e,t,i){this.setDesignResolutionSize(e,t,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return this._devicePixelRatio},i.convertToLocationInView=function(e,t,i,n){var r=n||new de,s=this._devicePixelRatio*(e-i.left),o=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=a.game.canvas.width-o,r.y=s):(r.x=s,r.y=o),a.GAME_VIEW&&(r.x/=a.gameView.canvas.width/a.game.canvas.width,r.y/=a.gameView.canvas.height/a.game.canvas.height),r},i._convertPointWithScale=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},i._resizeEvent=function(){var e,t=this._frameSize.width,i=this._frameSize.height,n=this._isRotated;if(a.sys.isMobile){var r=a.game.container.style,s=r.margin;r.margin="0",r.display="none",this._initFrameSize(),r.margin=s,r.display="block"}else this._initFrameSize();if(this._orientationChanging||this._isRotated!==n||this._frameSize.width!==t||this._frameSize.height!==i){var o=this._designResolutionSize.width,h=this._designResolutionSize.height;this._resizing=!0,o>0&&this.setDesignResolutionSize(o,h,this._resolutionPolicy),this._resizing=!1,this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)}},i._orientationChange=function(){this._orientationChanging=!0,this._resizeEvent()},i._initFrameSize=function(){var e=this._frameSize,t=Nt.windowSize,i=t.width,n=t.height,r=i>=n;!a.sys.isMobile||r&&this._orientation&a.macro.ORIENTATION_LANDSCAPE||!r&&this._orientation&a.macro.ORIENTATION_PORTRAIT?(e.width=i,e.height=n,a.game.container.style["-webkit-transform"]="rotate(0deg)",a.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=n,e.height=i,a.game.container.style["-webkit-transform"]="rotate(90deg)",a.game.container.style.transform="rotate(90deg)",a.game.container.style["-webkit-transform-origin"]="0px 0px 0px",a.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,a.game.canvas.style["-webkit-transform"]="translateZ(0px)",a.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){a.view._orientationChanging=!1}),1e3)},t}(at));rh.instance=void 0;var sh=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupContainer=function(e,t,i){var n=a.game.canvas,r=a.game.container;Ot.os!==Lt.ANDROID&&Ot.os!==Lt.OHOS||(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px",e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),n.width=t*e._devicePixelRatio,n.height=i*e._devicePixelRatio},t._fixContainer=function(){document.body.insertBefore(a.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=a.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0},e}();sh.EQUAL_TO_FRAME=void 0,sh.PROPORTION_TO_FRAME=void 0;var ah=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,i,n,r,s){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var a=new d(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,s],this._result.viewport=a,this._result},e}();ah.EXACT_FIT=void 0,ah.SHOW_ALL=void 0,ah.NO_BORDER=void 0,ah.FIXED_HEIGHT=void 0,ah.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="EqualToFrame",t}return $(t,e),t.prototype.apply=function(e){var t=e._frameSize.height,i=a.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"},t}(sh),t=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ProportionalToFrame",t}return $(t,e),t.prototype.apply=function(e,t){var i,n,r=e._frameSize.width,s=e._frameSize.height,o=a.game.container.style,h=t.width,u=t.height,c=r/h,_=s/u;c<_?(i=r,n=u*c):(i=h*_,n=s);var l=Math.round((r-i)/2),d=Math.round((s-n)/2);i=r-2*l,n=s-2*d,this._setupContainer(e,i,n),e._isRotated?o.margin="0 0 0 "+s+"px":o.margin="0px",o.paddingLeft=l+"px",o.paddingRight=l+"px",o.paddingTop=d+"px",o.paddingBottom=d+"px"},t}(sh),i=("undefined"==typeof window?global:window).__globalAdapter;i&&(i.adaptContainerStrategy&&i.adaptContainerStrategy(sh.prototype),i.adaptView&&i.adaptView(rh.prototype)),sh.EQUAL_TO_FRAME=new e,sh.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ExactFit",t}return $(t,e),t.prototype.apply=function(e,t){var i=a.game.canvas.width,n=a.game.canvas.height,r=i/t.width,s=n/t.height;return this._buildResult(i,n,i,n,r,s)},t}(ah),r=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ShowAll",t}return $(t,e),t.prototype.apply=function(e,t){var i,n,r=a.game.canvas.width,s=a.game.canvas.height,o=t.width,h=t.height,u=r/o,c=s/h,_=0;return u<c?(i=r,n=h*(_=u)):(i=o*(_=c),n=s),this._buildResult(r,s,i,n,_,_)},t}(ah),s=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="NoBorder",t}return $(t,e),t.prototype.apply=function(e,t){var i,n,r,s=a.game.canvas.width,o=a.game.canvas.height,h=t.width,u=t.height,c=s/h,_=o/u;return c<_?(n=h*(i=_),r=o):(n=s,r=u*(i=c)),this._buildResult(s,o,n,r,i,i)},t}(ah),o=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedHeight",t}return $(t,e),t.prototype.apply=function(e,t){var i=a.game.canvas.width,n=a.game.canvas.height,r=n/t.height,s=i,o=n;return this._buildResult(i,n,s,o,r,r)},t}(ah),h=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedWidth",t}return $(t,e),t.prototype.apply=function(e,t){var i=a.game.canvas.width,n=a.game.canvas.height,r=i/t.width,s=i,o=n;return this._buildResult(i,n,s,o,r,r)},t}(ah);ah.EXACT_FIT=new n,ah.SHOW_ALL=new r,ah.NO_BORDER=new s,ah.FIXED_HEIGHT=new o,ah.FIXED_WIDTH=new h}();var oh=e("q",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof sh&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof ah&&(this._contentStrategy=e)},c(e,[{key:"canvasSize",get:function(){return new de(a.game.canvas.width,a.game.canvas.height)}}]),e}());oh.EXACT_FIT=0,oh.NO_BORDER=1,oh.SHOW_ALL=2,oh.FIXED_HEIGHT=3,oh.FIXED_WIDTH=4,oh.UNKNOWN=5,oh.ContainerStrategy=sh,oh.ContentStrategy=ah,a.ResolutionPolicy=oh,e("v",rh.instance=a.view=new rh),a.winSize=nh}}}));
