System.register(["./json-asset-1a4fee7d.js","./view-50c22e7e.js","./texture-buffer-pool-32e209c1.js","./renderable-component-b5e46bae.js","./mesh-c8768986.js"],(function(e){"use strict";var t,i,s,n,h,o,a,r,l,u,d,c,p,_,g,m,f,b,S,M,w,v,y,I,O,P;return{setters:[function(e){t=e.ec,i=e.cJ,s=e.ef,n=e.gv,h=e.e2,o=e.eg,a=e.eu,r=e.ek,l=e.fY,u=e.l,d=e.g0,c=e.eb,p=e.dQ,_=e.gw,g=e.eh,m=e.ei,f=e.c7,b=e.fZ,S=e.ga,M=e.f_,w=e.fU,v=e.go,y=e.ed},function(e){I=e.i},function(){},function(e){O=e.R},function(e){P=e.M}],execute:function(){var R,z,C,W,k,F,j,D,L,x,B,T,N,U,A,E,V,H,q,J,Q,Y,Z,G,K,X,$,ee,te,ie,se,ne=e("a",function(e){function i(){for(var t,i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];return(t=e.call.apply(e,[this].concat(s))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}t(i,e);var s=i.prototype;return s.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):null},s.initSubModel=function(t,i,s){return e.prototype.initSubModel.call(this,t,i,this._launderMaterial(s))},s.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},s.setSubModelMaterial=function(t,i){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(i))},s._updateLocalDescriptors=function(t,i){e.prototype._updateLocalDescriptors.call(this,t,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,i)},s._launderMaterial=function(e){return e},s.setMorphRendering=function(e){this._morphRenderingInstance=e},i}(I)),he=i({OFF:0,ON:1}),oe=i({OFF:0,ON:1}),ae=(R=s("cc.ModelLightmapSettings"),z=n("_recieveShadow"),R((B=function(){function e(){g(this,"texture",k,this),g(this,"uvParam",F,this),g(this,"_bakeable",j,this),g(this,"_castShadow",D,this),g(this,"_receiveShadow",L,this),g(this,"_lightmapSize",x,this)}return h(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),k=o((W=B).prototype,"texture",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F=o(W.prototype,"uvParam",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),j=o(W.prototype,"_bakeable",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D=o(W.prototype,"_castShadow",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),L=o(W.prototype,"_receiveShadow",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x=o(W.prototype,"_lightmapSize",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),o(W.prototype,"bakeable",[a],Object.getOwnPropertyDescriptor(W.prototype,"bakeable"),W.prototype),o(W.prototype,"castShadow",[a],Object.getOwnPropertyDescriptor(W.prototype,"castShadow"),W.prototype),o(W.prototype,"receiveShadow",[a],Object.getOwnPropertyDescriptor(W.prototype,"receiveShadow"),W.prototype),o(W.prototype,"lightmapSize",[a],Object.getOwnPropertyDescriptor(W.prototype,"lightmapSize"),W.prototype),C=W))||C);e("M",(T=s("cc.MeshRenderer"),N=b(),U=S(100),A=M(),E=r(he),V=w(),H=r(oe),q=w(),J=r(P),Q=w(),Y=v(),T(Z=N(Z=U(Z=A(Z=l((se=ie=function(e){function i(){var t;return t=e.call(this)||this,g(t,"lightmapSettings",K,y(t)),g(t,"_mesh",X,y(t)),g(t,"_shadowCastingMode",$,y(t)),g(t,"_shadowReceivingMode",ee,y(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,g(t,"_enableMorph",te,y(t)),t._modelType=I,t}t(i,e);var s=i.prototype;return s.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},s.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},s.onEnable=function(){this._model||this._updateModels(),this._attachToScene()},s.onDisable=function(){this._model&&this._detachFromScene()},s.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},s.getWeight=function(e,t){var i=this._subMeshShapesWeights;d(e<i.length);var s=this._subMeshShapesWeights[e];return d(t<s.length),s[t]},s.setWeights=function(e,t){var i=this._subMeshShapesWeights;t>=i.length||i[t].length===e.length&&(i[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},s.setWeight=function(e,t,i){var s=this._subMeshShapesWeights;if(!(t>=s.length)){var n=s[t];i>=n.length||(n[i]=e,this._uploadSubMeshShapesWeights(t))}},s.setInstancedAttribute=function(e,t){if(this.model)for(var i=this.model.instancedAttributes,s=i.attributes,n=i.views,h=0;h<s.length;h++)if(s[h].name===e){n[h].set(t);break}},s._updateLightmap=function(e,t,i,s,n){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=s,this.lightmapSettings.uvParam.w=n,this._onUpdateLightingmap()},s._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},s._createModel=function(){var e=this._morphInstance&&this._modelType===I?ne:this._modelType,t=this._model=u.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof ne&&t.setMorphRendering(this._morphInstance)},s._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},s._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},s._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=c.POSITION,this._model.transform.hasChangedFlags|=c.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var s=this.getRenderMaterial(i);s&&!s.isValid&&(s=null);var n=t[i];n&&this._model.initSubModel(i,n,s||this._getBuiltinMaterial())}this._model.enabled=!0}},s._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},s._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},s._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},s._onMeshChanged=function(){},s._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},s._getBuiltinMaterial=function(){return p.get("missing-material")},s._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},s._updateCastShadow=function(){this._model&&(this._shadowCastingMode===he.OFF?this._model.castShadow=!1:(d(this._shadowCastingMode===he.ON,"ShadowCastingMode "+this._shadowCastingMode+" is not supported."),this._model.castShadow=!0))},s._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===oe.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},s._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i)if(t.passes[i].batchingScheme)return!0}return!1},s._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof ne&&this._model.setMorphRendering(this._morphInstance)}},s._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var i=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):i?(d(i.length===e.targets.length),i.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},s._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var i=e.struct.morph;return i.subMeshMorphs.length===t.length&&t.every((function(e,t){var s,n,h=e.length;return(null!==(s=null===(n=i.subMeshMorphs[t])||void 0===n?void 0:n.targets.length)&&void 0!==s?s:0)===h}))},s._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},h(i,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,i=this._mesh=e;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),i}(O),ie.ShadowCastingMode=he,ie.ShadowReceivingMode=oe,K=o((G=se).prototype,"lightmapSettings",[m,a,_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ae}}),X=o(G.prototype,"_mesh",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$=o(G.prototype,"_shadowCastingMode",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return he.OFF}}),ee=o(G.prototype,"_shadowReceivingMode",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oe.ON}}),o(G.prototype,"shadowCastingMode",[E,V,_],Object.getOwnPropertyDescriptor(G.prototype,"shadowCastingMode"),G.prototype),o(G.prototype,"receiveShadow",[H,q,_],Object.getOwnPropertyDescriptor(G.prototype,"receiveShadow"),G.prototype),o(G.prototype,"mesh",[J,Q],Object.getOwnPropertyDescriptor(G.prototype,"mesh"),G.prototype),o(G.prototype,"enableMorph",[Y,_],Object.getOwnPropertyDescriptor(G.prototype,"enableMorph"),G.prototype),te=o(G.prototype,"_enableMorph",[m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Z=G))||Z)||Z)||Z)||Z)||Z))}}}));
